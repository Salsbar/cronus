const int32 times[] = {0,6374,6874,7274,7291,7307,7324,7357,7391,7407,7674,7708,7724,7741,7758,7841,8125,8158,8192,8208,8242,8258,8559,8575,8592,8609,8692,8959,9009,9042,9059,9092,9376,9409,9426,9626,9643,9660,9676,9693,9710,9743,9960,9977,9993,10010,10027,10043,10060,10277,10291,10292,10294,10377,10394,10694,10727,10744,10761,10811,10827,11111,11144,11178,11195,11211,11278,11562,11595,11612,11628,11678,11962,12012,12029,12045,12112,12412,12429,12446,12462,12479,12496,12513,13030,13096,13113,13130,13163,13180,13263,13280,13297,13313,13330,13347,13363,13747,13764,14114,14147,14198,14214,14248,14531,14565,14581,14598,14631,14648,14681,14982,15015,15032,15048,15132,15399,15415,15449,15465,15516,15549,15832,15883,15916,15966,16466,16500,16517,16533,16567,16583,16683,16717,16733,16750,16767,16817,17084,17100,18569,18652,18669,19937,19953,19970,20003,20053,20120,20170,20187,20204,20254,20571,20604,20654,20804,21722,21738,22122,22163,22164,22289,22313,22314,22322,22522,22523,22723,22856,22857,22990,23031,23032,23156,23173,23257,23273,23574,23590,23607,23624,23657,23674,23874,23907,23924,23941,24024,24107,24124,24141,24157,24191,24222,24223,24224,24391,24641,25042,25075,25125,25175,25192,25292,25309,25342,25709,26476,26577,26593,26610,26643,26677,26960,27010,27027,27044,27077,27110,27411,27427,27444,27461,27494,27511,27828,28312,29780,29997,30013,30063,30113,30163,30180,30230,30430,30447,30464,30480,30547,30814,30864,30881,30898,30914,30948,31265,31281,31298,31315,31331,31336,31337,31348,31365,31381,31398,31698,31732,31748,31815,31832,32115,32165,32182,32249,32273,32274,32282,32298,32299,32349,32366,32382,32416,32482,32566,32599,32616,32633,32666,32683,32758,32759,32983,33000,33016,33050,33100,33116,33333,33417,33500,33517,33534,33567,33584,33617,33634,33650,33750,33784,33851,33867,33967,33969,33970,34101,34201,34218,34234,34268,34284,34301,34368,34384,34401,34434,34451,34484,34501,34535,34551,34601,34618,34635,34651,34668,34685,35302,36203,37037,37087,37204,37287,37304,37321,37337,37354,37404,37487,37504,37554,37571,37638,37688,37738,37754,37771,37838,38522,38538,38539,38539,39790,39857,39873,40198,40199,40524,40540,40590,40607,40641,40724,40741,40774,40821,40822,40824,40874,40880,40881,40924,40974,40991,41024,41124,41141,41158,41174,41221,41222,41224,41858,41858,41859,41875,43877,43910,43927,43977,44011,44094,44127,44144,44227,44461,44478,44911,44945,45062,45095,45412,45429,45445,45479,45512,45829,45846,45862,45879,45912,45929,46330,46346,46647,46663,46697,46730,46747,46797,47080,47114,47147,47164,47180,47214,47614,47631,47931,47948,47981,47998,48015,48031,48081,48365,48415,48448,48465,48498,48815,48832,48915,49333,49349,50717,50722,50723,50767,50884,50984,51001,51018,51034,51081,51082,51084,51109,51110,51184,51201,51218,51268,51301,51385,51418,51435,51451,51468,51515,51516,51518,52352,52352,52353,52369,54154,54187,54221,54288,54304,54338,54371,54421,54438,54454,54504,54538,54605,54621,54738,54838,54871,54888,54938,55639,55655,55656,55656,55989,55990,56323,57591,57624,57674,57741,57808,57841,57858,57874,57908,57939,57940,57941,58175,58175,58176,58191,58675,58709,58725,58742,58759,58809,59109,59126,59176,59223,59224,59226,59543,59559,59593,59626,59643,60043,60052,60053,60060,60377,60410,60427,60444,60477,60508,60509,60510,60827,60844,60861,60927,61328,61337,61338,61345,61645,61695,61728,61745,61793,61794,61795,62079,62112,62145,62162,62179,62212,62529,62546,62579,62629,62763,63263,63264,88389,88889,88905,89106,89139,89189,89222,89523,89539,89556,89573,89589,89606,89656,89940,89957,89973,90007,90090,90407,90424,90507,90824,90841,90857,90874,90907,90924,91191,91241,91875,91892,91908,91942,91959,92009,92075,92109,92125,92142,92426,92442,92943,92976,92993,93010,93060,93393,93410,93427,93443,93477,93510,93660,93677,93694,93727,93744,93760,93777,93827,93860,93877,93927,93944,94044,94127,94411,94428,95312,95329,95362,95395,95429,95529,95562,95579,95612,95629,95796,95996,96013,96380,96396,96413,96430,96446,96496,96580,96596,96613,96630,96647,96663,96680,96697,97014,97047,97064,97097,97114,97147,97164,97481,97497,97514,97531,97581,98715,98765,98782,98799,98815,98832,98949,98966,98982,99016,99032,99082,99249,99399,100000,101268,101318,101351,101535,101568,102152,102185,102219,102252,102302,102369,102419,102436,102452,102469,102502,102786,103286,103287,103821,104321,104429,104430,104755,105372,105380,105381,105405,105422,105439,105472,105522,105789,105839,105872,105889,105939,106023,106156,106223,106273,106290,106303,106304,106306,106323,106356,108392,108809,108842,108859,108942,108976,109042,109209,109259,109276,109293,109326,109359,109576,109626,109676,109776,110177,110544,112029,112245,112262,112346,112362,112412,112429,112479,112679,112696,112713,112729,112779,112996,113046,113080,113113,113130,113180,113196,113513,113530,113547,113563,113590,113591,113597,113614,113647,113964,113997,114014,114031,114047,114097,114398,114431,114448,114464,114511,114512,114514,114615,114616,114617,114648,114698,114731,114798,114848,114865,114929,114930,114931,115215,115265,115282,115299,115315,115349,115365,115582,115666,115766,115782,115799,115816,115832,115882,115999,116033,116099,116116,116183,116187,116188,116249,116300,116350,116416,116450,116483,116500,116533,116566,116633,116667,116683,116717,116733,116767,116783,116817,116833,116850,116867,116883,116900,116917,116934,117551,119303,119336,119369,119403,119436,119553,119586,119603,119653,119753,119803,119820,119886,119953,119987,120003,120020,120070,120087,120771,120787,122422,122506,122539,122639,122640,122739,122756,122789,122806,122873,122973,122990,123006,123023,123040,123086,123087,123090,123123,123124,123156,123190,123307,123407,123423,123440,123457,123504,123505,123507,124141,124141,124142,124157,125242,125325,125342,126159,126193,126209,126259,126293,126393,126410,126426,126443,126460,126510,126743,126760,127227,127260,127277,127294,127327,127377,127644,127661,127694,127711,127728,127744,127794,128095,128111,128128,128145,128161,128211,128228,128562,128578,128645,128662,128979,128996,129012,129046,129079,129379,129396,129413,129429,129446,129463,129496,129896,129913,130263,130280,130297,130347,130364,130681,130697,130714,130731,130764,130781,131064,131114,131131,131148,131198,131481,131498,131623,131624,131748,132215,132216,132683,132799,132833,132933,132934,133033,133050,133083,133100,133166,133266,133283,133364,133365,133367,133417,133418,133467,133517,133550,133600,133667,133700,133717,133734,133784,133798,133799,133800,134635,134635,134636,134651,136436,136470,136520,136536,136586,136653,136703,136720,136737,136787,136870,136903,136937,136987,137020,137120,137137,137154,137220,137921,137938,138488,138489,139039,139239,139890,139940,139957,140023,140090,140123,140140,140157,140173,140221,140222,140223,140457,140457,140458,140474,140958,140991,141008,141024,141074,141091,141408,141441,141475,141506,141507,141508,141808,141825,141842,141858,141925,142326,142334,142335,142342,142676,142693,142709,142726,142743,142791,142792,142793,143110,143126,143210,143610,143618,143619,143627,143961,143977,143994,144011,144061,144075,144076,144077,144394,144428,144444,144478,144494,144778,144828,144861,144911,145045,145545,145546,171872,172372,172956,173056,173123,173323,173473,173540,173573,174157,174191,174207,174274,174308,174408,174424,174441,174458,174508,174608,174625,174658,174741,174841,174858,174875,174942,174975,175642,175659,177577,177585,177586,177611,177661,177678,177728,177794,177844,177861,177878,177894,177926,177927,177928,177986,177987,178045,178061,178111,178161,178261,178278,178312,178360,178361,178362,178996,178996,178997,179012,181031,181048,181131,181181,181264,181298,181315,181365,181598,181615,182099,182132,182149,182182,182232,182549,182566,182582,182599,182649,182966,182983,183016,183066,183467,183483,183800,183834,183867,183884,183917,183934,184217,184251,184268,184301,184318,184351,184368,184751,184768,185118,185152,185168,185185,185218,185535,185552,185569,185585,185619,185636,185919,185969,185986,186003,186019,186053,186336,186353,186453,186469,186470,186486,186745,186746,187004,187129,187130,187254,187395,187396,187537,187654,187688,187888,187890,187891,187921,187971,188021,188105,188121,188138,188155,188188,188219,188220,188221,188288,188292,188293,188338,188372,188388,188438,188538,188555,188572,188588,188639,188730,188731,188822,189322,189323,189340,189840,190674,190707,191108,191291,191325,191375,191408,191458,191541,191558,191591,191658,191725,191758,191875,191959,191975,192009,192025,192059,192075,192776,192793,194745,194747,194748,194778,194828,194878,194945,194978,194995,195012,195045,195078,195186,195187,195295,195295,195296,195312,195379,195395,195812,195846,195862,195896,195946,196213,196280,196296,196330,196356,196357,196363,196380,196471,196472,196563,196580,196604,196605,196613,196646,196647,196680,196680,196681,196697,196730,196747,196780,197180,197189,197190,197197,197514,197547,197581,197597,197646,197647,197648,197965,197981,197998,198015,198031,198081,198465,198473,198474,198482,198515,198548,198815,198832,198849,198865,198882,198929,198930,198932,199216,199266,199283,199299,199316,199349,199366,199683,199700,199716,199750,199766,199783,199900,200400,200401}
const int16 angles[] = {-1,180,180,179,178,174,166,162,146,148,148,146,154,167,176,208,208,206,199,192,185,180,179,178,174,168,148,148,143,134,127,120,118,118,120,120,123,128,132,137,140,148,148,138,121,112,98,88,90,90,0,359,347,347,180,179,178,170,166,146,148,148,151,166,180,188,208,208,206,199,196,181,180,176,172,165,148,148,147,144,134,131,124,118,120,129,134,137,145,148,148,146,139,122,114,99,90,90,180,180,178,164,160,148,148,146,155,168,198,207,239,239,234,230,224,208,208,210,207,200,189,180,180,172,165,148,148,144,132,116,101,90,90,96,102,106,112,120,120,180,181,182,180,181,185,192,197,208,208,196,190,176,148,149,138,125,119,120,1,0,0,359,358,359,0,0,0,359,359,359,0,0,0,359,358,352,335,332,330,330,326,319,308,301,301,306,308,316,332,332,334,337,344,351,359,0,0,0,32,32,29,18,4,0,0,8,32,30,31,29,26,19,11,0,0,4,8,14,22,32,32,33,36,46,53,61,60,32,30,34,32,32,27,16,10,0,1,2,6,14,32,32,36,42,45,52,60,60,50,42,21,4,0,359,350,339,298,301,301,306,312,328,332,332,336,340,358,359,0,0,0,359,358,358,352,346,330,333,336,340,346,354,359,359,0,1,2,5,16,27,32,32,60,60,62,56,50,44,38,34,32,30,20,5,0,0,0,359,332,331,328,318,308,298,300,300,299,296,284,273,264,254,246,236,224,218,214,204,200,192,180,180,180,184,208,208,207,200,196,190,180,181,182,192,198,208,208,204,200,194,180,180,359,0,0,1,2,0,0,359,359,358,346,342,332,331,336,350,359,0,0,0,0,359,356,346,340,332,331,338,342,348,359,0,0,0,0,359,180,181,182,189,198,208,209,207,200,180,180,239,238,239,218,208,208,204,196,190,180,181,172,169,162,154,148,148,208,208,213,207,198,192,180,180,176,170,162,160,149,148,208,208,213,209,202,198,192,180,180,174,164,160,149,148,147,120,120,0,0,0,359,355,332,331,339,342,348,359,0,0,0,359,358,356,350,340,332,332,334,341,344,350,359,0,0,0,0,359,180,180,182,189,206,210,208,208,204,200,194,182,180,181,182,210,209,200,194,180,180,359,0,0,0,359,359,359,356,344,332,332,334,338,344,351,359,0,0,0,0,359,301,302,308,314,318,320,332,332,333,348,359,0,0,0,8,15,26,32,32,0,359,332,332,334,338,344,351,359,0,0,0,8,12,32,32,0,359,332,332,335,342,347,359,0,0,0,3,10,16,20,32,32,35,48,60,60,60,-1,146,146,148,149,160,171,180,179,178,176,168,164,158,148,148,146,154,177,208,209,202,180,180,176,168,165,154,148,148,120,120,123,128,134,140,148,148,126,104,90,90,180,181,178,170,166,148,148,168,181,191,208,239,238,236,231,226,222,222,219,208,201,194,184,180,181,180,180,120,120,126,132,142,148,148,128,112,96,90,92,90,180,179,178,176,168,164,148,148,146,157,176,189,200,217,270,270,258,246,235,224,206,208,209,202,198,192,180,180,170,164,148,140,119,120,124,130,135,142,148,148,179,180,181,182,180,178,180,181,182,190,196,210,208,197,190,176,170,149,148,148,-1,359,359,359,0,1,0,0,359,358,354,348,342,332,332,328,320,313,301,301,331,332,342,348,359,0,2,9,32,30,31,28,24,14,9,0,0,4,8,14,22,31,32,38,48,60,60,32,30,34,28,18,14,8,4,0,0,4,11,14,32,31,38,46,48,52,58,61,60,51,34,24,0,359,354,342,301,300,308,316,320,320,331,332,336,346,348,359,0,0,0,0,359,349,340,332,331,338,341,359,0,0,0,6,10,16,20,34,32,32,60,61,58,52,49,44,32,31,20,4,0,0,0,359,352,340,331,330,328,318,310,300,301,301,289,279,270,260,252,244,235,226,222,220,213,208,198,194,180,181,183,193,198,209,208,196,194,180,181,192,198,208,207,205,202,194,184,180,180,0,1,5,0,0,359,359,358,352,346,332,331,335,342,346,352,359,0,0,0,359,359,356,332,331,340,342,348,359,0,0,0,0,359,180,181,182,180,181,182,189,198,208,209,208,201,197,191,180,180,239,239,234,230,224,220,208,208,210,209,201,198,192,180,179,178,175,168,164,146,148,148,290,290,209,209,204,196,191,180,179,178,176,168,164,158,148,148,208,208,204,196,185,180,179,176,168,166,154,149,148,143,138,131,120,119,0,0,359,359,359,0,0,8,0,0,359,359,358,350,344,332,331,340,359,0,0,0,359,359,347,340,332,333,335,340,346,356,359,0,0,0,0,359,180,181,182,194,196,210,208,203,200,194,180,180,182,190,202,208,208,204,197,180,180,0,0,359,359,359,359,350,344,332,332,334,337,344,346,359,0,0,0,0,359,301,301,308,314,318,334,332,332,345,350,359,0,0,1,2,5,12,32,32,0,359,330,332,333,337,344,346,359,0,0,0,8,32,32,0,359,330,332,333,340,342,356,359,0,0,0,14,16,27,32,32,36,48,60,60,60,-1,180,180,180,148,180,181,181,182,180,181,182,189,201,208,208,200,197,191,180,181,184,194,208,208,204,196,182,180,180,0,0,0,359,358,348,342,331,332,336,340,347,350,359,0,0,0,359,359,352,342,332,331,339,346,359,0,0,0,0,359,180,181,182,200,208,208,200,192,180,180,239,239,232,226,221,208,209,201,198,192,180,181,172,164,148,148,208,208,206,198,192,185,180,180,178,174,164,160,146,148,148,208,209,198,194,188,180,180,172,170,163,154,149,148,144,138,134,127,120,120,0,0,0,359,359,359,0,0,0,359,359,359,0,0,8,0,0,0,359,354,340,332,332,334,337,344,351,359,0,0,0,0,359,354,348,346,332,332,333,340,344,359,359,0,0,0,-1,180,180,178,180,181,180,182,193,200,208,207,204,194,180,181,183,210,208,206,200,194,185,180,180,0,0,0,359,354,340,332,332,334,337,344,351,359,359,0,0,0,359,299,299,301,302,308,314,319,332,330,334,342,350,359,0,2,0,0,359,359,358,359,0,0,0,359,359,359,0,8,14,22,32,32,0,359,332,332,334,341,347,359,0,0,1,4,12,16,22,32,32,0,359,330,330,332,331,332,338,342,348,359,0,0,0,6,10,16,20,34,32,31,36,47,55,63,60,60,60,-1}
int maxIdx = 1417;
int bpm=140;
int ribbon_offset=0;

//deadzone for autoswirl set negative to disable
int deadzone=5;
int ms=0;
int ms_ribbon=0;
int running=0;

int idx=0;
int curAngle=-1;

int next_beat=0;
int beat_anticipate=0;
int autoswirl=0;

init {
	beat_anticipate=60000/(bpm*4);
}

main {
	ms+=get_rtime();
	if (get_val(XB1_VIEW)>0 && event_press(XB1_A)) {
		ms=0;
		idx=0;
		next_beat=0;
		cls_oled(0);
		running=1;
		putc_oled(1,82);
		putc_oled(2,117);
		putc_oled(3,110);
		puts_oled(40,20,2,3,1);
	}
	if (event_press(XB1_B)) {
		ms=0;
		idx=0;
		next_beat=0;
		cls_oled(0);
		running=0;
		putc_oled(1,83);
		putc_oled(2,116);
		putc_oled(3,111);
		putc_oled(4,112);
		puts_oled(30,20,2,4,1);
	}
	if (event_press(XB1_RB)) {ribbon_offset = ribbon_offset + 25;set_val(TRACE_1,ribbon_offset);}
	if (event_press(XB1_LB)) {ribbon_offset = ribbon_offset - 25;set_val(TRACE_1,ribbon_offset);}
	
	if (running) {
		set_val(TRACE_2,ms);
		ms_ribbon = ms + ribbon_offset;
		//advance until we reach the end or catch up with the time code
		while (idx<maxIdx && ms_ribbon>times[idx + 1]) {
			idx++;
		}
		//if we've reached the end of the ribbon, releast LS
		if (idx>=maxIdx || angles[idx]== -1) {
			curAngle=-1;
		} else {
			curAngle=angles[idx]+(angles[idx + 1]-angles[idx])*(ms_ribbon-times[idx])/(times[idx + 1]-times[idx]);
		}
		//set LS position if ribbon present
		if (curAngle>=0) set_polar(POLAR_LS,curAngle,32767);

		//shoot if we are on the beat
		if ((ms+beat_anticipate)>((next_beat*2*60000)/bpm)) {
			next_beat+=1;
			combo_run(fire);
		}

		//swirl reticle if idle
		if (event_press(XB1_X)) {if (autoswirl==0) {autoswirl=1} else {autoswirl=0}}
		if (autoswirl==1 && get_val(XB1_RX)<=deadzone && get_val(XB1_RY)<=deadzone && get_val(XB1_RX)>=-deadzone && get_val(XB1_RY)>=-deadzone) {set_polar(POLAR_RS,ms%360,32767);}
	}
}

combo fire {
	set_val(XB1_RT,100);wait(50);
}
const int32 times[] = {0,59493,59993,60010,60027,60043,60077,60093,60110,60125,60126,60127,60160,60194,60227,60244,60310,60394,60410,60494,61094,61128,61144,61245,61261,61295,61311,61378,61395,61428,61495,61545,61562,61578,61595,61612,61645,61662,61712,61745,61778,61828,61845,61862,61895,61912,61929,61945,61962,61979,61995,62012,62029,62045,62062,62079,62095,62129,62145,62196,62212,62246,62262,62296,62312,62346,62980,62996,63013,63080,63096,63113,63146,63163,63197,63213,63263,63280,63330,63347,63397,63413,63447,63463,63514,63530,63597,63606,63607,63630,63680,63697,63730,63747,63764,63797,63814,63847,63864,63879,63880,63881,63897,63931,63947,63981,63997,64014,64047,64064,64081,64131,64147,64164,64248,64848,64882,64898,64932,64948,65048,65065,65098,65132,65148,65165,65265,65299,65315,65332,65365,65382,65399,65432,65465,65499,65532,65599,65616,65632,65649,65682,65732,65749,65766,65782,65799,65816,65832,65849,65883,65899,65916,65933,65966,65983,66016,66033,66049,66099,66533,66583,66600,66617,66633,66650,66667,66683,66700,66717,66733,66750,66800,66817,66850,66867,66917,66934,66967,66984,67017,67050,67067,67117,67167,67184,67234,67267,67301,67317,67351,67367,67417,67434,67467,67484,67534,67551,67568,67584,67601,67618,67626,67627,67634,67651,67668,67684,67718,67734,67768,67784,67835,67851,67885,67901,67918,67985,68602,68652,68669,68735,68752,68852,68886,68902,68952,68969,69019,69036,69086,69119,69152,69186,69219,69303,69353,69369,69386,69403,69436,69453,69503,69520,69536,69553,69570,69586,69620,69636,69686,69703,69753,69770,69803,69853,70487,70604,70671,70721,70754,70771,70838,70854,70904,70921,70938,70954,70988,71004,71038,71088,71113,71114,71138,71188,71238,71255,71288,71305,71321,71338,71355,71371,71375,71376,71388,71405,71421,71438,71455,71488,71505,71538,71555,71588,71605,71638,71655,71672,71722,72356,72372,72389,72406,72539,72573,72589,72623,72639,72673,72689,72773,72789,72823,72840,72856,72890,72906,72940,72956,73040,73056,73090,73106,73156,73173,73190,73207,73223,73240,73257,73273,73290,73307,73340,73357,73390,73407,73440,73457,73507,73524,73557,73607,73624,73640,73707,73740,73757,73774,73807,73824,73857,73874,73907,73924,73974,73991,74041,74074,74091,74124,74141,74174,74208,74224,74258,74274,74291,74341,74374,74424,74474,74541,74575,74625,74641,74658,74691,74708,74775,74791,74842,74858,74908,74925,74975,75025,75042,75075,75108,75125,75129,75130,75142,75158,75175,75192,75225,75242,75292,75309,75359,75375,75392,75425,75475,76109,76126,76159,76176,76293,76360,76376,76393,76527,76543,76577,76593,76627,76643,76727,76760,76810,76844,76877,76894,76910,76927,76944,76960,77044,77060,77077,77094,77160,77177,77244,77277,77294,77361,77978,78078,78228,78245,78262,78312,78328,78345,78378,78412,78428,78445,78462,78495,78512,78529,78579,78595,78602,78603,78612,78662,78695,78712,78729,78745,78762,78779,78795,78812,78862,78879,78880,78881,78896,78912,78946,78962,78979,79012,79029,79079,79096,79129,79146,79179,79229,79630,79847,79863,79880,79897,79930,79947,79997,80013,80030,80047,80063,80097,80113,80130,80180,80197,80214,80247,80297,80314,80347,80364,80397,80430,80480,80497,80564,80581,80597,80631,80664,80681,80697,80714,80731,80747,80764,80781,80797,80814,80848,80864,80898,80914,80964,80981,81014,81031,81048,81064,81565,81598,81615,81632,81682,81698,81715,81765,81782,81832,81849,81899,81915,81965,81982,81999,82015,82032,82049,82115,82132,82149,82199,82249,82266,82316,82332,82399,82416,82449,82466,82516,82533,82549,82566,82583,82599,82616,82627,82628,82633,82649,82666,82683,82699,82716,82766,82783,82833,82850,82883,82900,82933,82983,83584,83600,83634,83650,83800,83817,83867,83884,83967,83984,84017,84084,84117,84251,84268,84334,84368,84384,84418,84451,84468,84501,84518,84535,84568,84585,84618,84635,84651,84668,84701,84718,84735,84751,84785,84852,85469,85519,85569,85586,85602,85636,85669,85686,85702,85719,85736,85752,85769,85786,85819,85919,85936,85953,85986,86069,86086,86101,86102,86136,86153,86186,86203,86220,86236,86270,86286,86320,86336,86353,86370,86375,86376,86386,86403,86420,86436,86470,86486,86520,86537,86570,86587,86620,86637,86670,86720,87354,87437,87471,87538,87638,87654,87704,87754,87788,87804,87821,87855,87888,87921,87955,87988,88055,88071,88105,88121,88138,88172,88188,88205,88222,88238,88255,88272,88288,88305,88322,88338,88355,88388,88405,88455,88472,88505,88572,88605,88672,89172,89173,89507,90007,90023,90057,90090,90107,90140,90157,90190,90207,90257,90274,90307,90324,90357,90374,90390,90407,90440,90457,90958,90974,91041,91058,91091,91108,91124,91158,91175,91225,91241,91291,91308,91341,91358,91375,91391,91892,91909,91975,91992,92009,92042,92059,92092,92109,92159,92176,92226,92242,92276,92292,92309,92326,92826,92860,92876,92926,92943,92976,92993,93010,93026,93060,93076,93143,93160,93177,93193,93210,93243,93277,93291,93292,93310,93327,93343,93377,93393,93410,93544,93577,93594,93627,93644,93677,93694,93760,93794,93810,93877,93911,93944,93961,94027,94044,94111,94127,94144,94161,94178,94194,94211,94711,94728,94795,94811,94828,94878,94895,94912,94995,95012,95045,95062,95095,95112,95128,95145,95646,95662,95729,95796,95812,95896,95913,95996,96013,96029,96046,96063,96079,96597,96663,96697,96713,96730,96813,96830,96897,96914,96947,96980,96997,97064,97097,97114,97130,97181,97197,97247,97281,97297,97381,97397,97431,97464,97512,97513,97514,97531,97548,97564,97614,97648,97664,97714,97731,97865,97881,97915,97948,97965,98448,98515,98599,98615,98632,98699,98715,98782,98799,98832,98849,98866,98882,99351,99352,99383,99384,99385,99483,99499,99516,99566,99583,99600,99666,99683,99750,99766,99783,99816,99833,100334,100384,100400,100434,100450,100501,100517,100601,100617,100684,100701,100717,100784,100795,100796,100817,100834,100851,100884,100901,100968,100984,101068,101084,101151,101285,101351,101368,101385,101435,101451,101468,101552,101568,101618,101652,101668,101685,101702,102174,102175,102202,102203,102204,102302,102319,102369,102386,102402,102469,102486,102553,102569,102586,102619,102636,103153,103203,103220,103253,103303,103337,103353,103437,103487,103520,103570,103587,104087,104121,104154,104188,104204,104238,104271,104354,104388,104404,104438,104454,104488,104521,104555,104588,104621,104671,104755,104821,104938,104972,104988,105005,105505,105506,149483,149983,150033,150050,150067,150083,150100,150117,150121,150122,150133,150150,150167,150184,150217,150234,150250,150284,150300,150334,150350,150384,150400,150417,150434,151185,151201,151235,151268,151285,151318,151335,151351,151385,151418,151468,151485,151552,151568,151602,151652,151668,151752,151768,151802,151835,151869,151902,151919,151952,151969,151985,152002,152035,152052,152069,152085,152102,152152,152169,152236,152252,152302,152319,153070,153086,153120,153203,153220,153270,153287,153303,153353,153370,153420,153437,153487,153520,153531,153532,153587,153704,153737,153754,153787,153820,153837,153871,153879,153880,153887,153904,153954,153971,154004,154021,154054,154071,154121,154137,154171,154188,154938,154972,155005,155022,155055,155072,155122,155138,155155,155205,155239,155272,155305,155372,155389,155472,155556,155572,155622,155639,155656,155672,155689,155706,155722,155739,155756,155789,155806,155822,155856,155873,155889,155939,155956,156006,156023,156039,156056,156073,156573,156590,156623,156640,156657,156673,156690,156740,156757,156807,156823,156874,156890,156957,156974,157007,157040,157074,157124,157140,157224,157241,157291,157307,157357,157374,157424,157441,157508,157541,157558,157589,157590,157591,157608,157624,157641,157674,157691,157708,157791,157808,157824,157925,157941,158575,158592,158876,158892,158909,158959,158976,159026,159042,159092,159109,159159,159176,159243,159276,159326,159343,159393,159409,159426,159459,159476,159493,159526,159543,159560,159576,159626,159643,159693,159710,159760,159776,159793,159810,160444,160460,160761,160777,160844,160861,160911,160928,160978,160994,161028,161061,161078,161150,161151,161161,161195,161278,161295,161311,161328,161332,161333,161361,161378,161395,161411,161428,161478,161495,161545,161562,161628,161645,161678,161695,162329,162346,162646,162696,162713,162763,162779,162846,162863,162913,162946,162980,163013,163030,163063,163146,163163,163197,163213,163230,163247,163280,163297,163363,163380,163430,163447,163514,163530,163547,163564,164064,164081,164097,164114,164164,164181,164231,164248,164331,164348,164398,164431,164448,164481,164665,164748,164765,164848,164865,164915,164932,164965,164982,165015,165032,165048,165065,165081,165082,165082,165098,165115,165132,165148,165165,165182,165199,165215,165249,165265,165315,165332,165365,165382,165432,165449,165749,165766,166383,166391,166392,166400,166617,166633,166650,166700,166717,166767,166817,166834,166900,166917,166934,166950,166967,167000,167017,167034,167067,167084,167134,167150,167201,167217,167251,167267,167301,167317,167601,167606,167607,167618,168235,168252,168485,168519,168535,168585,168602,168652,168685,168696,168697,168769,168785,168802,168819,168835,168836,168852,168869,168886,168902,168919,168952,168969,169019,169036,169086,169102,169152,169169,169186,169453,169469,170103,170120,170370,170387,170404,170454,170470,170487,170521,170537,170571,170587,170654,170687,170704,170721,170737,170754,170771,170804,170821,170838,170888,170904,170954,170971,171004,171021,171054,171071,171572,171588,171605,171655,171672,171705,171722,171755,171772,171822,171839,171889,171905,171939,171955,172022,172055,172105,172189,172206,172256,172272,172306,172322,172372,172389,172439,172456,172472,172539,172556,172573,172584,172585,172606,172623,172639,172673,172689,172723,172739,172789,172806,172856,172873,172906,172923,172940,173190,173207,173841,173857,174107,174157,174174,174224,174241,174258,174291,174391,174408,174424,174441,174474,174491,174508,174525,174541,174558,174608,174625,174675,174691,174725,174741,174791,174808,175058,175063,175064,175075,175642,175659,175876,175893,175909,175943,175959,175976,175993,176259,176270,176271,176276,176326,176343,176359,176362,176363,176376,176393,176409,176426,176443,176476,176493,176510,176526,176560,176593,176610,176810,176827,177577,177585,177586,177594,177844,177861,177894,177911,177961,177978,178011,178028,178061,178128,178144,178161,178194,178211,178228,178245,178261,178278,178311,178328,178361,178378,178428,178445,178478,178495,178528,178578,178595,178612,178645,178662,178712,178728,178762,178778,178812,178828,178878,178895,178929,178945,178995,179012,179045,179095,179129,179162,179229,179296,179329,179346,179362,179379,179412,179429,179479,179496,179963,179980,179996,180013,180030,180046,180063,180080,180105,180106,180130,180146,180163,180180,180196,180213,180263,180280,180330,180347,180363,180397,180413,180864,181181,181197,181214,181264,181298,181314,181348,181364,181381,181448,181464,181498,181581,181615,181681,181748,181765,181781,181798,181815,181848,181881,181915,181932,181948,181965,181982,181998,182015,182032,182048,182098,182115,182165,182182,182215,182232,182249,182265,182282,182382,182648,182649,182699,182991,182992,183033,183049,183066,183099,183116,183149,183166,183183,183199,183216,183250,183266,183283,183316,183350,183383,183400,183466,183483,183509,183510,183566,183583,183650,183667,183733,183767,183783,183817,183833,183850,183856,183857,183867,183883,183900,183917,183934,183950,184000,184017,184050,184067,184117,184134,184150,184167,184601,184918,184935,184951,184985,185018,185035,185051,185101,185118,185151,185168,185218,185235,185285,185335,185402,185435,185485,185502,185552,185569,185602,185619,185635,185652,185669,185685,185702,185719,185735,185752,185769,185785,185802,185835,185852,185885,185902,185952,185969,185986,186019,186036,186533,186534,186553,186554,186555,186586,186603,186620,186653,186670,186720,186736,186770,186786,186820,186836,186886,186903,186953,186987,187003,187037,187087,187120,187187,187203,187237,187254,187270,187320,187337,187387,187404,187437,187487,187504,187520,187554,187571,187587,187603,187604,187604,187621,187637,187654,187671,187687,187737,187754,187804,187821,187871,187887,187904,187921,188355,188688,188705,188872,188888,188922,188939,188955,188972,188989,189005,189055,189089,189155,189172,189239,189306,189322,189356,189372,189389,189406,189422,189439,189456,189472,189489,189506,189522,189539,189589,189606,189639,189656,189673,189706,189723,189739,189756,189773,189789,189923,190153,190154,190206,190557,190557,190558,190574,190740,190757,190807,190824,190890,190941,190957,191012,191013,191024,191057,191107,191141,191157,191174,191191,191224,191241,191258,191274,191291,191308,191324,191341,191358,191358,191359,191374,191391,191408,191424,191458,191474,191508,191524,191575,191591,191608,191625,191641,191658,191675,192092,192425,192475,192492,192542,192559,192626,192642,192692,192776,192792,192826,192859,192876,192976,192993,193026,193043,193076,193093,193126,193159,193176,193243,193260,193276,193293,193310,193326,193343,193360,193410,193426,193443,193460,193476,193493,193543,193560,193593,193660,193677,193710,193727,193743,193760,193777,193793,193827,193843,193860,193877,193910,193927,193944,194010,194044,194060,194077,194094,194127,194144,194177,194194,194227,194261,194327,194344,194394,194411,194444,194461,194478,194479,194511,194544,194628,194711,194728,194744,194794,194811,194844,194861,194894,194911,195411,195412}
const int16 angles[] = {-1,297,297,304,315,318,328,341,348,359,0,1,18,42,61,78,106,135,147,180,180,177,173,160,158,154,150,142,138,134,125,120,124,131,134,142,148,156,173,188,196,214,222,240,231,222,219,210,203,191,184,176,164,151,140,130,114,98,84,68,58,49,38,30,22,0,0,4,4,14,16,19,22,26,29,33,38,44,48,52,57,62,54,46,34,26,4,0,359,349,336,331,310,300,310,320,328,340,353,359,0,0,14,26,50,68,76,90,104,108,120,134,144,148,180,180,176,172,170,166,154,150,146,140,138,135,122,122,125,132,139,147,150,164,175,189,197,222,240,234,225,218,190,178,172,161,146,135,126,110,96,84,78,68,58,50,41,32,26,0,1,4,10,18,22,30,34,42,46,56,61,70,82,91,100,106,117,124,130,136,143,154,157,176,188,195,206,221,232,245,256,264,276,284,292,298,313,321,326,338,345,356,359,0,3,16,22,42,60,76,90,102,118,127,136,147,151,180,180,174,170,162,160,146,142,137,132,128,123,118,130,142,149,162,178,202,226,241,236,226,217,209,180,172,160,154,142,121,104,90,72,61,47,36,26,1,0,18,26,34,36,42,49,53,58,63,58,50,42,36,29,11,0,359,348,334,313,305,316,319,329,336,349,356,359,0,10,14,28,38,58,74,88,100,111,121,130,138,148,152,181,180,177,176,172,154,150,147,142,138,136,132,122,119,127,134,137,148,152,164,175,198,206,218,242,228,219,215,203,196,184,178,164,160,140,122,106,92,80,68,59,45,35,25,2,4,10,24,33,36,43,49,55,61,66,72,78,86,92,102,106,112,116,121,126,132,134,142,144,148,156,165,173,186,197,204,212,220,222,230,238,252,259,268,273,281,286,294,311,319,328,349,356,359,0,10,16,30,42,62,78,99,110,126,135,142,150,181,180,176,172,169,154,145,144,138,121,118,127,134,143,150,178,192,206,217,237,232,222,219,214,201,156,142,131,114,84,72,50,41,30,0,0,14,34,36,41,48,49,52,56,63,60,52,48,36,34,26,10,4,0,359,354,342,328,324,314,302,307,316,319,324,352,358,359,0,12,22,46,54,72,86,99,116,125,134,145,154,180,179,179,179,176,174,168,168,160,156,156,154,150,147,144,142,134,132,128,126,119,127,134,142,148,164,180,188,206,218,224,234,223,220,210,204,190,184,170,164,154,138,119,104,89,76,60,51,42,36,26,9,0,8,16,20,42,46,56,71,80,92,100,112,119,129,135,138,143,146,154,172,178,186,197,210,220,239,250,270,278,286,294,306,317,320,325,334,345,351,359,0,4,12,24,32,45,64,87,100,117,127,136,142,158,180,181,182,176,172,154,150,144,140,130,126,123,131,139,187,194,214,240,231,222,210,197,178,166,161,135,118,104,91,84,74,64,55,50,42,32,0,0,6,14,14,18,21,26,27,32,33,36,38,42,43,48,60,56,49,42,15,4,0,359,349,346,332,326,318,300,309,319,326,339,345,357,359,0,4,18,22,44,62,76,91,104,114,123,132,142,150,180,180,168,164,155,142,136,132,125,118,122,129,136,148,157,168,185,204,214,231,241,232,221,214,209,201,187,180,166,160,144,132,123,106,92,80,64,54,45,16,0,0,0,-1,358,358,356,346,332,326,311,295,282,272,258,248,240,232,224,222,214,210,194,180,197,191,210,224,240,246,258,269,279,292,302,313,319,328,336,342,352,359,350,332,318,309,295,282,272,262,248,240,228,221,213,204,198,189,181,191,199,215,231,245,256,261,271,280,288,306,314,318,320,324,339,353,359,0,8,12,22,36,46,58,110,119,126,133,142,148,157,180,189,194,224,241,256,267,288,298,315,318,326,330,337,342,351,357,351,332,316,306,284,279,267,242,234,224,222,213,203,197,186,188,186,213,245,258,286,296,318,324,328,333,342,359,352,330,316,306,291,262,252,234,224,218,210,198,170,160,147,138,118,106,88,78,68,48,38,31,20,0,359,359,356,350,341,324,307,293,274,264,224,222,212,199,187,180,199,241,249,261,282,292,310,318,325,329,337,352,359,0,0,0,359,330,322,305,284,278,267,248,238,220,218,210,198,187,181,196,203,220,231,254,265,292,300,318,321,329,355,359,0,8,18,24,38,54,78,89,114,122,138,187,208,213,231,254,260,271,296,304,318,324,334,340,351,359,0,0,0,359,328,312,288,282,271,250,242,224,222,212,202,191,183,204,208,224,248,262,273,300,315,322,340,352,359,347,340,326,318,295,278,247,236,236,224,222,211,197,178,164,152,124,89,66,32,19,5,5,5,-1,299,299,314,322,326,339,345,358,359,0,4,14,23,44,62,70,84,98,110,120,128,137,148,152,161,178,176,164,158,150,142,136,126,118,126,135,142,152,159,168,179,186,202,208,214,223,240,230,221,211,197,190,177,164,148,136,126,108,86,74,53,43,27,18,3,10,16,42,50,60,57,52,44,37,29,22,11,2,0,359,347,320,308,306,316,325,339,353,359,0,6,14,50,68,83,96,108,118,131,142,150,161,178,168,162,154,146,136,125,118,124,132,142,146,156,171,178,196,214,222,240,230,224,222,216,206,198,185,178,158,150,128,110,102,88,70,59,45,34,30,24,13,0,10,18,28,34,42,54,70,80,94,103,114,122,137,145,152,164,179,192,195,228,242,260,270,284,292,304,312,329,340,349,359,0,0,10,14,24,38,46,60,89,94,104,132,143,143,90,90,92,98,108,114,122,128,136,143,150,157,172,184,194,196,209,203,193,184,172,168,152,146,138,124,106,95,80,70,58,51,47,37,37,90,90,84,70,64,56,50,42,35,30,22,16,0,359,357,346,333,343,347,358,359,0,8,18,22,30,44,64,76,92,102,120,128,135,145,145,94,94,104,110,120,126,136,144,151,163,170,178,182,192,207,199,188,179,173,164,154,138,112,100,84,74,58,50,46,36,32,36,44,54,69,79,92,100,118,126,136,145,146,156,215,249,260,284,292,302,310,318,320,333,335,346,350,359,0,0,4,13,20,24,37,46,52,64,75,86,100,108,118,125,135,143,143,270,270,359,0,90,90,98,110,125,134,150,179,186,206,197,193,183,178,164,158,147,132,118,102,92,78,68,60,53,46,38,38,0,359,270,270,90,90,78,67,52,42,26,4,0,359,332,341,346,355,359,0,4,14,20,30,37,52,64,82,92,106,114,127,134,150,150,270,270,92,92,98,110,126,135,142,150,163,180,186,202,190,182,178,168,162,156,138,130,118,101,91,76,68,59,51,45,37,34,42,52,66,75,84,92,100,108,118,124,134,142,148,155,172,186,197,224,238,254,263,272,280,292,300,310,318,319,340,349,354,359,0,10,14,23,36,50,62,74,90,100,112,121,129,136,152,152,270,270,90,90,108,118,133,144,148,162,209,204,194,188,173,168,160,154,148,132,114,102,87,78,68,60,49,42,42,0,359,270,270,90,90,82,66,55,46,35,18,10,0,359,355,336,351,356,359,0,12,16,32,38,54,76,82,92,106,122,130,137,137,270,270,359,0,90,90,98,110,120,134,145,156,162,185,209,198,194,180,174,164,160,148,142,126,116,104,93,78,70,62,54,47,31,35,45,52,59,70,77,84,90,97,104,112,118,124,128,136,143,148,161,168,179,194,208,218,222,226,236,244,252,264,271,299,300,310,315,318,328,334,344,359,0,14,20,36,48,57,74,96,108,124,133,137,152,169,184,178,173,166,154,145,134,125,115,115,135,137,147,165,176,191,206,208,216,220,224,240,230,216,212,198,192,180,172,160,154,132,106,91,72,62,53,43,37,33,24,18,0,359,356,359,0,0,2,10,16,22,30,38,44,48,55,60,58,52,47,37,33,26,13,5,0,359,348,342,328,320,305,315,323,334,347,354,359,0,8,14,26,36,48,67,89,102,112,123,137,147,151,160,184,178,174,168,160,150,146,136,125,120,126,130,138,145,154,168,184,193,203,208,220,228,240,230,225,222,217,206,198,186,180,166,160,144,131,114,98,85,73,58,48,44,29,12,0,359,359,359,0,13,17,25,34,46,62,71,80,88,96,104,114,122,131,142,145,156,169,182,199,206,214,222,233,250,260,273,280,288,304,310,318,328,341,346,359,0,0,8,20,26,36,57,82,96,112,123,137,148,154,163,184,184,118,118,124,130,134,137,142,144,149,159,170,184,191,203,220,230,238,234,223,220,215,204,196,184,178,164,158,138,110,96,82,76,66,56,46,42,36,32,23,15,0,359,356,359,356,0,62,62,57,49,44,30,19,12,0,359,357,347,338,328,326,320,312,300,304,314,320,322,332,340,352,359,359,0,12,18,34,46,64,80,94,106,122,131,135,142,146,156,177,184,176,164,158,145,135,119,124,134,154,156,167,173,180,201,206,212,222,229,240,234,230,226,218,213,212,208,206,202,200,196,188,184,182,178,176,170,162,158,154,139,134,130,126,124,120,118,113,108,104,102,98,94,90,88,76,72,68,66,62,58,55,52,48,44,37,27,23,16,12,8,2,0,359,355,348,336,321,320,314,306,300,294,289,284,279,279,-1}
int maxIdx = 2026;
int bpm=128;
int ribbon_offset=0;

//deadzone for autoswirl set negative to disable
int deadzone=5;
int ms=0;
int ms_ribbon=0;
int running=0;

int idx=0;
int curAngle=-1;

int next_beat=0;
int beat_anticipate=0;
int autoswirl=0;

init {
	beat_anticipate=60000/(bpm*4);
}

main {
	ms+=get_rtime();
	if (get_val(XB1_VIEW)>0 && event_press(XB1_A)) {
		ms=0;
		idx=0;
		next_beat=0;
		cls_oled(0);
		running=1;
		putc_oled(1,82);
		putc_oled(2,117);
		putc_oled(3,110);
		puts_oled(40,20,2,3,1);
	}
	if (event_press(XB1_B)) {
		ms=0;
		idx=0;
		next_beat=0;
		cls_oled(0);
		running=0;
		putc_oled(1,83);
		putc_oled(2,116);
		putc_oled(3,111);
		putc_oled(4,112);
		puts_oled(30,20,2,4,1);
	}
	if (event_press(XB1_RB)) {ribbon_offset = ribbon_offset + 25;set_val(TRACE_1,ribbon_offset);}
	if (event_press(XB1_LB)) {ribbon_offset = ribbon_offset - 25;set_val(TRACE_1,ribbon_offset);}
	
	if (running) {
		set_val(TRACE_2,ms);
		ms_ribbon = ms + ribbon_offset;
		//advance until we reach the end or catch up with the time code
		while (idx<maxIdx && ms_ribbon>times[idx + 1]) {
			idx++;
		}
		//if we've reached the end of the ribbon, releast LS
		if (idx>=maxIdx || angles[idx]== -1) {
			curAngle=-1;
		} else {
			curAngle=angles[idx]+(angles[idx + 1]-angles[idx])*(ms_ribbon-times[idx])/(times[idx + 1]-times[idx]);
		}
		//set LS position if ribbon present
		if (curAngle>=0) set_polar(POLAR_LS,curAngle,32767);

		//shoot if we are on the beat
		if ((ms+beat_anticipate)>((next_beat*2*60000)/bpm)) {
			next_beat+=1;
			combo_run(fire);
		}

		//swirl reticle if idle
		if (event_press(XB1_X)) {if (autoswirl==0) {autoswirl=1} else {autoswirl=0}}
		if (autoswirl==1 && get_val(XB1_RX)<=deadzone && get_val(XB1_RY)<=deadzone && get_val(XB1_RX)>=-deadzone && get_val(XB1_RY)>=-deadzone) {set_polar(POLAR_RS,ms%360,32767);}
	}
}

combo fire {
	set_val(XB1_RT,100);wait(50);
}
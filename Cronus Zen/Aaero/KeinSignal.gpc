const int32 times[] = {0,29530,30030,30080,30130,30147,30180,30197,30214,30247,30264,30314,30330,30364,30380,30430,30447,30547,30564,30581,30597,30645,30646,30647,30649,30650,30714,30781,30797,30831,30848,30898,30914,30931,30948,30964,30981,31014,31031,31081,31098,31148,31164,31198,31215,31281,31298,31315,31398,31481,31515,31598,31615,31648,31665,31698,31715,31748,31782,31798,31815,31849,31882,31899,31932,31949,31982,31999,32032,32049,32065,32082,32115,32149,32165,32199,32211,32212,32232,32249,32266,32282,32316,32332,32349,32366,32399,32416,32449,32466,32482,32516,32533,32566,32583,32616,32633,32683,32699,32733,32749,32799,32866,32883,32933,32966,33016,33033,33100,33150,33166,33200,33217,33267,33283,33317,33333,33367,33383,33433,33450,33500,33517,33617,33684,33717,33759,33760,33767,33784,33800,33817,33834,33851,33867,33884,33901,33951,33967,34001,34017,34051,34067,34101,34134,34151,34184,35035,35068,35085,35102,35135,35169,35185,35202,35219,35252,35269,35285,35302,35335,35352,35369,35385,35402,35419,35435,35469,35485,35502,35519,35536,35552,35569,35586,35602,35650,35651,35652,35653,35654,35686,35702,35736,35752,35769,35802,35819,35836,35853,35869,35886,35903,35919,35953,35969,35986,36003,36019,36036,36053,36069,36103,36119,36136,36153,36170,36186,36203,36236,36270,36303,36320,36336,36370,36386,36420,36436,36453,36470,36486,36503,36520,36553,36570,36587,36603,36620,36637,36670,36687,36720,36737,36753,36770,36803,36820,36904,36920,36970,36987,37020,37037,37054,37070,37104,37120,37154,37171,37471,37971,37972,39523,40023,40040,40057,40107,40157,40174,40190,40224,40240,40274,40290,40324,40340,40390,40407,40440,40457,40541,40574,40591,40657,40691,40724,40741,40807,40824,40858,40874,40924,40941,41008,41024,41175,41291,41375,41458,41475,41542,41558,41575,41608,41625,41658,41675,41725,41742,41775,41792,41825,41892,41909,41942,41959,41992,42009,42042,42059,42075,42092,42109,42125,42159,42176,42192,42210,42211,42226,42242,42259,42276,42292,42309,42326,42342,42359,42376,42409,42426,42459,42476,42509,42526,42576,42593,42626,42643,42693,42709,42743,42759,42809,42876,42910,42943,42993,43043,43076,43143,43160,43210,43227,43260,43277,43310,43327,43360,43377,43410,43427,43460,43493,43510,43527,43594,43610,43644,43677,43694,43760,43774,43775,43777,44695,44695,44696,44711,45028,45062,45128,45145,45162,45179,45212,45229,45262,45279,45312,45329,45345,45362,45395,45412,45445,45462,45529,45562,45579,45612,45646,45662,45696,45746,45779,45796,45829,45846,45879,45896,45929,45946,45979,45996,46046,46063,46096,46113,46146,46163,46196,46213,46280,46346,46396,46446,46530,46547,46597,46613,46647,46663,46713,46730,46763,46780,46813,46830,46864,46880,46930,46947,46980,46997,47030,47047,47097,47147,47164,47181,47197,47211,47212,47214,47247,47264,47281,47314,47331,47381,47397,47431,47931,47932,49533,50033,50083,50117,50150,50167,50184,50217,50234,50267,50284,50334,50350,50384,50400,50450,50467,50551,50567,50634,50649,50650,50651,50653,50654,50684,50701,50751,50817,50834,50884,50901,50968,50984,51101,51118,51134,51185,51218,51285,51351,51368,51401,51435,51451,51485,51502,51535,51885,51985,52102,52236,52286,52302,52319,52369,52386,52402,52469,52536,52553,52736,52837,52838,52886,52903,53103,53203,53220,53320,53337,53403,53437,53604,53637,53704,53754,53770,53804,53820,53854,53871,53887,53904,53937,53971,54037,55022,55038,55072,55122,55172,55189,55222,55239,55289,55305,55322,55339,55372,55389,55422,55439,55472,55489,55506,55522,55556,55572,55656,55689,55739,55756,55789,55806,55856,55873,55906,55923,55956,55973,56023,56039,56073,56089,56173,56190,56223,56273,56323,56356,56390,56423,56440,56456,56507,56523,56540,57040,57041,59527,60027,60077,60110,60160,60194,60210,60244,60260,60294,60310,60360,60377,60410,60427,60460,60477,60494,60511,60527,60561,60577,60661,60711,60744,60777,60794,60811,60844,60861,60911,60928,60961,60978,61028,61044,61078,61094,61128,61144,61161,61178,61211,61278,61311,61345,61428,61445,61495,61512,61545,61562,61578,61628,61645,61662,61695,61712,61762,61778,61812,61828,61879,61895,61962,61979,62062,62079,62095,62145,62179,62196,62215,62216,62246,62262,62296,62312,62329,62346,62379,62396,62429,62446,62479,62496,62513,62546,62563,62596,62613,62663,62679,62729,62763,62779,62796,62863,62880,62946,62963,63030,63046,63096,63130,63163,63180,63213,63230,63263,63280,63330,63347,63380,63397,63497,63514,63547,63564,63597,63614,63647,63664,63697,63714,63780,64239,64240,64698,64698,64699,64715,65032,65048,65115,65182,65199,65249,65265,65299,65315,65349,65365,65415,65432,65465,65482,65499,65516,65532,65566,65582,65649,65666,65716,65732,65782,65799,65832,65849,65883,65899,65933,65949,65983,65999,66049,66066,66099,66116,66133,66149,66166,66183,66216,66283,66333,66350,66400,66416,66517,66550,66633,66650,66683,66700,66750,66767,66800,66817,66850,66884,66900,66917,66967,66984,67017,67034,67084,67100,67117,67150,67201,67215,67216,67217,67234,67267,67317,67334,67384,67401,67434,67451,67951,67952,79530,80030,80581,80664,80714,80731,80747,80781,81248,81265,81331,81348,81365,81448,82316,82529,82530,82533,83150,83153,83154,83200,83217,83267,83317,83767,83784,83817,83834,83867,83901,83917,84968,84984,84985,84985,85652,85653,85654,85669,85686,85719,85736,85752,85769,86236,86270,86286,86303,86353,86370,86453,87321,87538,88155,88172,88222,88238,88255,88322,88755,88805,88839,88856,88872,88906,88922,89973,89990,90657,90674,90707,90724,90741,90757,90774,91241,91258,91341,91458,92326,92543,92851,92852,93160,93162,93163,93227,93260,93327,93760,93810,93827,93894,93911,93927,94962,94977,94978,94978,95028,95045,95495,95496,95646,95662,95729,95746,95762,95779,96246,96313,96330,96396,96463,97314,97531,98148,98332,98799,98866,98882,98916,99666,99683,99700,99716,99983,100000,100617,100667,100701,100717,100734,100751,100784,101251,101268,101285,101451,102319,102532,102533,102536,102844,102845,103153,103187,103337,103770,103787,103804,103820,103837,103854,103904,103921,103954,104905,104921,104922,104922,105038,105055,105088,105606,105611,105612,105672,105722,105739,105756,105772,106240,106256,106273,106340,106356,106423,106456,107324,107541,108158,108275,108325,108876,109376,109377,129530,130030,130063,130080,130147,130163,130197,130214,130264,130280,130314,130330,130380,130397,130447,130464,130497,130514,130531,130564,130581,130647,130664,130714,130747,130781,130797,130848,130864,130898,130914,130948,130964,131014,131031,131064,131081,131181,131215,131281,131315,131331,131415,131498,131565,131582,131598,131632,131665,131682,131715,131732,131748,131765,131782,131798,131815,131849,131882,131899,131932,131949,131965,131982,132015,132032,132082,132099,132115,132132,132149,132165,132182,132199,132205,132206,132216,132232,132249,132299,132316,132332,132349,132366,132382,132399,132432,132449,132482,132499,132516,132533,132549,132583,132599,132616,132633,132649,132666,132699,132716,132733,132749,132766,132783,132816,132833,132916,132933,132966,132983,133050,133100,133150,133183,133200,133217,133233,133250,133267,133300,133317,133333,133350,133383,133400,133417,133467,133500,133534,133550,133567,133584,133600,133617,133634,133650,133767,133771,133772,133784,133800,133817,133834,133851,133867,133901,133917,133934,133951,133984,134001,134034,134051,134067,134084,134117,134134,134168,134184,135018,135068,135085,135118,135135,135152,135185,135202,135235,135252,135285,135302,135319,135335,135369,135385,135419,135435,135452,135469,135536,135602,135652,135686,135719,135752,135769,135802,135819,135836,135853,135886,135903,135936,135953,135969,135986,136019,136053,136086,136103,136119,136136,136153,136186,136203,136236,136270,136336,136403,136420,136453,136470,136503,136520,136570,136587,136620,136637,136687,136703,136803,136820,136904,136970,137004,137020,137037,137054,137104,137120,137154,137171,137471,137971,137972,139523,140023,140090,140157,140174,140207,140224,140240,140274,140290,140340,140357,140390,140407,140457,140474,140490,140507,140524,140557,140574,140657,140674,140724,140807,140824,140858,140874,140941,140958,141024,141041,141124,141141,141175,141191,141275,141291,141375,141408,141458,141542,141558,141592,141608,141625,141658,141692,141708,141725,141758,141775,141825,141875,141892,141925,141942,141975,141992,142025,142042,142075,142092,142125,142142,142159,142176,142192,142209,142210,142242,142259,142276,142292,142309,142342,142359,142392,142409,142459,142476,142509,142526,142576,142593,142643,142659,142709,142726,142743,142793,142860,142876,142943,142960,142976,142993,143060,143076,143126,143143,143193,143210,143243,143260,143293,143310,143360,143377,143410,143427,143460,143477,143510,143527,143644,143660,143694,143710,143774,143775,143777,144695,144695,144696,144711,145028,145045,145095,145162,145179,145195,145212,145245,145262,145295,145312,145329,145345,145379,145395,145429,145445,145462,145479,145495,145512,145529,145546,145579,145612,145644,145645,145646,145647,145648,145696,145729,145746,145779,145796,145812,145829,145863,145879,145913,145929,145963,145979,146013,146029,146063,146079,146180,146280,146296,146330,146430,146480,146513,146547,146563,146597,146613,146647,146663,146713,146747,146763,146780,146813,146830,146864,146880,146930,146947,146980,146997,147030,147047,147064,147097,147114,147130,147164,147181,147197,147208,147209,147231,147247,147264,147281,147297,147331,147347,147381,147397,147447,147947,147948,149533,150033,150100,150117,150133,150167,150184,150234,150250,150300,150317,150367,150384,150417,150434,150484,150517,150534,150567,150649,150650,150651,150652,150653,150717,150751,150767,150801,150817,150834,150868,150884,150951,150968,151084,151101,151151,151201,151218,151268,151368,151435,151451,151485,151502,151518,151535,151869,152035,152186,152386,152419,152503,152636,152686,152819,152831,152832,152836,152886,152920,153103,153203,153220,153237,153270,153303,153337,153453,153470,153604,153637,153704,153737,153754,153787,153804,153837,153854,153887,153904,153921,153954,153987,154021,155022,155072,155088,155138,155155,155172,155189,155205,155239,155255,155305,155322,155339,155355,155405,155422,155455,155472,155539,155589,155637,155638,155639,155643,155644,155656,155689,155722,155772,155789,155806,155822,155856,155873,155923,155939,155973,155989,156023,156039,156089,156106,156123,156139,156156,156190,156206,156273,156323,156356,156390,156406,156440,156456,156473,156507,156523,156540,157040,157041,159527,160027,160093,160160,160177,160227,160244,160277,160294,160327,160344,160377,160394,160444,160460,160544,160561,160577,160594,160644,160677,160694,160744,160761,160794,160811,160827,160878,160894,160928,160944,160978,160994,161044,161061,161094,161111,161128,161144,161178,161211,161278,161328,161428,161445,161495,161512,161545,161562,161595,161612,161628,161662,161678,161728,161762,161812,161845,161912,161929,162029,162045,162062,162079,162129,162145,162179,162219,162220,162229,162262,162312,162329,162379,162396,162446,162479,162513,162563,162579,162613,162629,162663,162696,162729,162746,162796,162846,162880,162896,162980,162996,163030,163080,163130,163146,163180,163197,163230,163247,163280,163297,163330,163347,163380,163397,163430,163447,163480,163497,163547,163564,163580,163597,163614,163630,163647,163664,163697,163761,163762,163764,164014,164514,164515,164532,165032,165048,165065,165082,165132,165148,165182,165199,165265,165282,165315,165332,165382,165399,165449,165465,165549,165582,165649,165732,165749,165782,165799,165816,165866,165883,165933,165949,165983,165999,166066,166083,166166,166200,166216,166266,166316,166366,166400,166416,166466,166533,166550,166583,166600,166650,166667,166700,166717,166750,166767,166817,166850,166867,166884,166900,166950,166967,167017,167034,167067,167084,167100,167134,167150,167201,167214,167215,167217,167234,167267,167284,167301,167317,167334,167351,167367,167417,167434,167467,167967,167968}
const int16 angles[] = {-1,180,180,194,204,211,220,227,240,250,260,271,278,286,292,302,308,328,332,339,342,359,0,0,0,359,344,328,319,306,296,282,273,270,262,260,254,248,242,232,226,218,212,206,197,182,183,186,196,208,211,225,230,234,238,243,248,252,257,259,263,266,274,281,288,294,300,306,312,318,318,324,328,340,344,356,359,0,5,12,16,22,31,43,48,56,64,72,80,90,90,96,102,106,112,116,121,128,132,136,142,149,162,167,177,186,194,198,210,221,230,238,245,255,262,267,272,278,284,292,296,304,308,324,338,346,359,0,2,4,10,18,22,36,46,52,65,82,92,101,110,118,124,132,143,146,157,182,192,194,201,208,220,230,235,244,254,261,264,271,280,284,290,292,298,301,306,312,317,318,323,326,331,334,342,344,359,0,0,0,359,350,347,338,334,328,319,307,302,292,288,280,276,270,263,257,254,248,246,240,237,232,226,221,220,215,212,206,202,190,180,188,193,196,204,208,222,226,236,242,251,254,262,269,276,279,286,288,294,300,306,312,318,318,324,328,336,358,353,344,338,330,321,316,305,296,287,278,270,270,270,-1,180,180,182,190,200,214,220,231,242,252,260,268,275,282,292,298,304,310,326,336,344,359,348,342,339,318,306,294,286,273,265,250,244,212,181,194,203,206,214,219,222,226,230,236,240,247,252,256,260,264,276,282,290,296,302,308,314,320,320,324,329,332,344,347,354,359,0,4,10,14,20,24,32,38,44,49,58,67,75,83,90,96,100,108,114,118,122,129,133,137,144,150,165,171,181,189,200,204,221,228,240,247,254,260,266,272,277,282,288,292,298,304,306,311,321,326,330,337,342,356,359,0,0,0,0,359,182,182,190,205,212,216,226,237,246,256,264,272,278,282,288,294,300,306,312,323,332,340,348,359,357,347,338,326,318,306,296,286,278,270,263,256,250,240,234,228,222,219,213,206,198,182,190,195,202,212,218,223,228,234,238,245,250,254,258,262,266,270,276,286,292,298,305,311,316,324,339,346,348,356,359,0,0,12,14,22,30,42,56,66,74,74,-1,183,183,194,204,210,215,226,238,249,258,266,277,284,290,296,306,312,328,335,355,359,0,0,0,359,352,346,336,313,302,286,278,262,254,230,223,222,212,198,182,198,204,211,221,234,245,254,264,272,282,292,304,310,310,314,317,320,318,325,330,333,350,359,0,4,8,26,36,41,50,52,58,62,78,82,88,98,106,114,120,128,134,138,145,150,166,188,182,183,193,202,221,231,242,251,264,272,275,282,288,294,300,306,312,318,318,324,329,337,359,348,340,332,324,314,296,286,278,270,263,256,246,240,234,228,212,205,198,180,192,200,208,222,226,238,253,262,266,266,-1,180,180,194,200,215,226,238,249,258,266,274,284,290,297,304,310,315,318,319,325,331,339,356,346,336,328,324,312,300,290,277,269,262,255,246,238,232,226,220,220,214,211,199,181,184,190,200,203,208,212,215,221,221,232,234,238,242,247,253,257,261,265,272,279,292,300,316,318,322,337,347,354,359,0,8,16,22,32,38,46,56,64,74,82,90,92,98,102,108,112,118,124,128,135,143,145,149,160,167,180,185,196,200,208,218,226,234,242,248,255,261,270,276,280,286,304,308,313,318,320,326,330,336,341,347,359,359,0,0,0,359,180,180,187,200,222,234,250,260,268,275,282,288,298,304,310,316,320,320,326,332,340,352,355,345,338,328,318,306,295,286,277,269,262,256,250,240,234,228,222,221,218,212,210,197,182,188,191,196,199,211,218,230,236,240,245,251,255,260,264,267,276,279,286,296,302,308,314,320,326,329,342,356,359,0,0,8,16,31,43,58,66,75,83,83,-1,180,180,180,189,208,224,247,270,270,279,298,302,310,331,331,359,0,0,0,0,359,352,347,341,332,332,332,327,320,314,298,302,301,359,0,0,0,0,359,352,346,318,298,285,270,270,259,256,246,235,227,209,209,180,180,185,192,194,198,208,210,212,220,222,230,242,238,239,181,180,190,204,219,242,258,270,270,273,300,331,331,359,359,0,0,0,359,348,344,332,330,328,322,308,298,302,301,359,0,0,0,1,0,359,359,358,330,306,272,270,270,250,240,224,210,209,180,180,209,209,222,231,240,239,250,246,239,239,180,181,182,198,204,219,242,270,270,275,286,330,331,359,0,0,0,359,359,354,330,332,332,328,326,320,318,305,300,301,301,359,0,0,0,2,0,0,0,359,354,334,318,293,270,270,266,260,242,233,217,210,209,180,181,200,210,209,209,-1,181,181,188,194,208,218,230,242,256,264,272,280,290,296,306,312,318,320,326,332,340,352,355,344,334,328,316,299,289,280,272,265,258,248,242,236,230,211,198,180,184,188,197,208,220,221,226,231,238,240,247,249,253,255,259,260,264,268,275,282,288,294,296,302,308,314,322,328,330,338,341,348,352,358,359,0,2,8,12,30,34,44,48,56,61,69,76,83,92,94,100,102,106,111,116,118,122,123,127,131,135,137,143,144,148,152,157,174,180,184,190,201,210,226,234,241,244,250,254,260,265,270,272,278,282,288,290,300,306,312,314,320,320,322,326,328,333,358,359,0,4,14,18,26,34,51,64,74,79,88,97,106,114,121,124,130,136,144,150,155,180,192,194,204,208,212,227,238,248,256,264,272,276,282,288,294,300,306,308,314,326,345,358,351,342,336,328,318,306,302,292,283,275,268,261,258,252,246,237,231,225,222,221,215,209,201,191,180,196,212,220,234,244,254,262,274,281,288,294,304,310,328,336,358,342,334,330,326,314,296,287,278,270,270,270,-1,181,181,197,213,223,236,242,252,260,268,279,286,292,298,308,314,318,318,324,330,338,358,352,342,318,304,294,284,268,260,246,240,223,222,214,207,182,182,194,196,204,215,220,224,226,232,236,243,245,250,254,258,264,272,279,286,292,298,304,310,316,320,326,332,340,344,350,354,359,0,10,16,20,25,32,44,54,62,71,83,90,96,101,108,114,120,125,132,136,138,149,160,166,180,186,188,192,202,206,216,222,236,243,250,256,263,269,277,282,288,292,298,302,306,312,330,335,341,346,359,0,0,0,0,359,181,181,188,197,215,226,232,242,252,260,268,275,278,284,290,296,302,308,312,317,320,320,326,328,339,349,359,0,0,0,359,347,341,334,328,318,312,300,291,282,274,267,260,254,248,241,235,230,210,181,182,188,200,206,212,216,221,224,229,234,238,246,252,254,258,262,266,270,276,286,294,300,306,312,318,318,324,330,334,346,349,356,359,0,6,12,16,22,26,36,48,58,67,79,79,-1,184,184,198,204,208,216,228,246,256,268,276,286,294,300,306,314,322,325,334,359,0,0,0,359,342,336,328,320,313,300,290,282,265,258,234,226,218,207,197,179,202,224,237,248,252,261,264,271,286,300,320,320,328,341,346,358,359,0,0,4,9,27,37,38,42,45,50,52,63,66,78,82,88,94,102,110,116,124,131,137,145,148,160,170,183,181,192,198,208,216,220,227,238,248,258,270,277,280,286,296,302,308,314,326,341,359,0,0,0,359,358,348,342,328,322,318,306,295,286,273,265,258,252,246,238,230,224,221,220,214,208,200,182,192,202,208,213,229,234,245,254,263,269,269,-1,182,182,198,214,225,242,253,262,270,276,284,290,296,306,312,328,334,338,346,358,354,346,337,332,319,314,302,287,278,271,263,256,250,240,234,228,222,221,218,206,200,180,188,200,203,208,212,216,221,224,227,232,236,242,248,254,262,266,282,288,309,316,319,320,331,336,349,359,0,2,16,28,41,56,66,79,90,98,106,112,116,120,125,132,136,142,148,158,165,171,188,192,196,208,216,224,232,240,247,254,260,265,271,276,282,286,292,296,302,306,315,320,320,322,326,328,333,335,344,359,0,0,0,0,-1,181,181,188,192,194,205,213,224,236,256,264,273,280,290,296,306,312,328,340,358,342,335,326,320,308,292,282,270,262,256,250,236,230,214,203,199,180,185,192,196,200,205,214,219,222,227,234,240,244,248,252,256,262,270,270,273,280,292,298,308,314,320,320,327,334,342,357,359,0,0,8,16,20,29,34,41,46,56,70,78,86,86,-1}
int maxIdx = 1818;
int bpm=96;
int ribbon_offset=0;

//deadzone for autoswirl set negative to disable
int deadzone=5;
int ms=0;
int ms_ribbon=0;
int running=0;

int idx=0;
int curAngle=-1;

int next_beat=0;
int beat_anticipate=0;
int autoswirl=0;

init {
	beat_anticipate=60000/(bpm*4);
}

main {
	ms+=get_rtime();
	if (get_val(XB1_VIEW)>0 && event_press(XB1_A)) {
		ms=0;
		idx=0;
		next_beat=0;
		cls_oled(0);
		running=1;
		putc_oled(1,82);
		putc_oled(2,117);
		putc_oled(3,110);
		puts_oled(40,20,2,3,1);
	}
	if (event_press(XB1_B)) {
		ms=0;
		idx=0;
		next_beat=0;
		cls_oled(0);
		running=0;
		putc_oled(1,83);
		putc_oled(2,116);
		putc_oled(3,111);
		putc_oled(4,112);
		puts_oled(30,20,2,4,1);
	}
	if (event_press(XB1_RB)) {ribbon_offset = ribbon_offset + 25;set_val(TRACE_1,ribbon_offset);}
	if (event_press(XB1_LB)) {ribbon_offset = ribbon_offset - 25;set_val(TRACE_1,ribbon_offset);}
	
	if (running) {
		set_val(TRACE_2,ms);
		ms_ribbon = ms + ribbon_offset;
		//advance until we reach the end or catch up with the time code
		while (idx<maxIdx && ms_ribbon>times[idx + 1]) {
			idx++;
		}
		//if we've reached the end of the ribbon, releast LS
		if (idx>=maxIdx || angles[idx]== -1) {
			curAngle=-1;
		} else {
			curAngle=angles[idx]+(angles[idx + 1]-angles[idx])*(ms_ribbon-times[idx])/(times[idx + 1]-times[idx]);
		}
		//set LS position if ribbon present
		if (curAngle>=0) set_polar(POLAR_LS,curAngle,32767);

		//shoot if we are on the beat
		if ((ms+beat_anticipate)>((next_beat*2*60000)/bpm)) {
			next_beat+=1;
			combo_run(fire);
		}

		//swirl reticle if idle
		if (event_press(XB1_X)) {if (autoswirl==0) {autoswirl=1} else {autoswirl=0}}
		if (autoswirl==1 && get_val(XB1_RX)<=deadzone && get_val(XB1_RY)<=deadzone && get_val(XB1_RX)>=-deadzone && get_val(XB1_RY)>=-deadzone) {set_polar(POLAR_RS,ms%360,32767);}
	}
}

combo fire {
	set_val(XB1_RT,100);wait(50);
} ˙∏åºåæà±á≈ˆ∞Üæèª
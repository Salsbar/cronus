const int32 times[] = {0,22390,22890,22923,22973,22990,23006,23040,23056,23073,23123,23140,23190,23207,23240,23257,23273,23307,23357,23423,23457,23485,23486,23490,23524,23540,23557,23607,23624,23657,23674,23724,23757,23790,23807,23857,23874,23924,23957,24041,24057,24107,24174,24208,24942,24975,24992,25042,25058,25108,25125,25209,25225,25242,25259,25292,25309,25342,25375,25409,25425,25475,25492,25526,25542,25559,25576,25592,25626,25659,25692,25709,25759,25792,25809,25843,25859,25893,25909,25959,26009,26026,26076,26093,26143,26176,26226,26360,26376,26410,26426,26443,26476,26493,26527,26593,26627,26643,26693,26710,26760,26777,26877,26894,26910,26944,26960,27010,27027,27077,27110,27144,27160,27211,27227,27277,27294,27394,27427,27444,27477,27494,27544,27561,27611,28161,28177,28178,28178,28445,28478,28529,28562,28579,28612,28629,28679,28695,28779,28795,28812,28829,28862,28896,28929,28962,28996,29012,29079,29096,29213,29246,29279,29296,29346,29363,29446,29479,29546,29663,29696,29780,30514,31014,31048,31064,31098,31114,31148,31198,31231,31248,31298,31315,31365,31515,31532,31565,31582,31615,31632,31648,31682,31698,31715,31865,31882,31899,31932,31949,31999,32049,32099,32399,32449,32482,32516,32616,32749,32783,32833,32850,32900,32933,32966,32983,33066,33083,33150,33166,33209,33210,33217,33233,33267,33932,33933,33984,34017,34034,34051,34067,34084,34117,34134,34184,34201,34251,34268,34301,34318,34334,34468,34484,34651,34685,34768,34835,34885,34902,35018,35052,35085,35118,35135,35169,35202,35219,35269,35302,35319,36053,36069,36086,36136,36153,36186,36236,36286,36320,36353,36370,36403,36420,36470,36486,36537,36570,36587,36603,36653,36670,36703,36737,36787,36837,36920,36937,36987,37004,37087,37187,37204,37321,37454,37487,37504,37538,37554,37588,37604,37654,37671,37688,37738,37754,37788,37804,37855,37888,37971,38038,38055,38121,38155,38188,38255,38322,38338,38388,38455,38505,38539,38555,38589,38605,38639,38655,38705,39256,39273,39540,39606,39623,39673,39690,39740,39756,39806,39823,39857,39890,39923,39957,39973,39990,40040,40073,40127,40128,40190,40207,40224,40324,40340,40357,40374,40390,40424,40440,40474,40524,40557,40657,40691,40791,40824,40858,40874,41608,42125,42142,42192,42209,42242,42259,42309,42326,42342,42442,42476,42609,42659,42743,42759,42776,42826,42960,42976,43043,43060,43114,43115,43126,43193,43493,43544,43560,43594,43610,43710,43877,43894,43911,43944,43961,44011,44027,44077,44094,44127,44144,44178,44194,44211,44244,44261,44278,44328,44344,44844,44845,57742,58242,58275,58292,58342,58358,58408,58442,58525,58559,58575,58609,58625,58675,58692,58742,58759,58792,58809,58859,58876,58909,58942,58959,59009,59059,59092,59109,59142,59159,59193,59226,59259,59276,59326,59359,59376,59393,59409,59443,59476,59510,59526,59660,59693,59710,59743,59760,59793,59826,59893,59943,59960,59993,60027,60060,60110,60177,60194,60227,60260,60294,60327,60344,60394,60427,60477,60494,60511,60527,60544,60561,60627,60644,60694,60711,60744,60761,60811,60844,60878,60894,60911,61461,61477,61478,61478,61728,61795,61879,61929,62029,62095,62212,62229,62312,62346,62379,62546,62579,62646,62663,62679,62713,62996,63080,63814,64314,64348,64381,64414,64448,64498,64531,64565,64598,64615,64665,64831,64898,64948,64965,65065,65182,65232,65249,65332,65365,65382,65699,65732,65766,65782,65799,65816,65832,65849,65866,65899,66033,66066,66083,66099,66116,66133,66149,66200,66216,66266,66283,66316,66333,66366,66383,66400,66433,66450,66466,66483,66488,66489,66517,66533,66550,67284,67285,67286,67317,67367,67384,67401,67417,67451,67467,67518,67534,67584,67601,67634,67684,67701,67718,67818,67835,67868,67885,67918,67968,67985,68018,68085,68101,68118,68168,68218,68235,68268,68302,68352,68368,68402,68468,68502,68535,68569,68585,68619,69336,69386,69403,69436,69453,69486,69520,69553,69620,69636,69686,69720,69736,69770,69786,69837,69853,69903,69920,69953,69987,70020,70053,70103,70153,70187,70204,70237,70254,70287,70320,70370,70387,70437,70454,70470,70487,70504,70521,70571,70604,70621,70754,70787,70804,70838,70854,70888,70904,70988,71021,71038,71088,71121,71171,71205,71271,71288,71321,71355,71388,71405,71438,71505,71555,71572,71622,71638,71705,71738,71788,71805,71839,71872,71905,71939,71972,71989,72005,72556,72573,72823,72856,72873,72906,72923,72973,73006,73040,73056,73106,73123,73140,73156,73190,73290,73307,73340,73422,73423,73473,73507,73624,73640,73674,73724,73757,73857,73874,74024,74091,74107,74141,74157,74908,75409,75459,75475,75526,75542,75592,75626,75659,75709,75726,75759,75926,75959,75976,75993,76043,76076,76093,76126,76260,76293,76326,76343,76411,76412,76476,76827,76844,76860,76894,76910,76944,76960,77010,77144,77177,77194,77211,77227,77277,77294,77344,77361,77411,77427,77477,77494,77528,77544,77578,77594,77644,78412,78478,78495,78562,78579,78745,78829,78862,78979,78982,78983,79162,79213,79263,79296,79329,79346,79396,79429,79463,79479,79546,79663,79680,79730,80447,80464,80480,80531,80547,80597,80614,80681,80714,80731,80764,80797,80814,80848,80864,80881,80931,80948,80998,81014,81064,81081,81131,81148,81215,81248,81281,81298,81331,81348,81381,81415,81481,81532,81548,81582,81615,81632,81682,81715,81849,81882,81899,81932,81949,81999,82015,82065,82082,82132,82149,82182,82216,82266,82316,82366,82382,82416,82432,82466,82482,82516,82549,82566,82633,82649,82666,82699,82733,82783,82866,82900,82933,83000,83016,83033,83050,83100,83650,83667,83917,83918,83919,83967,84017,84034,84067,84084,84101,84151,84168,84218,84234,84251,84284,84334,84401,84451,84468,84501,84535,84568,84585,84701,84735,84835,84868,84885,84935,84985,85002,85085,85118,85185,85219,85269,86003,86520,86537,86620,86653,86703,86737,86803,86820,86854,87004,87020,87104,87120,87137,87154,87187,87221,87354,87387,87421,87437,87454,87504,87554,87571,87588,87905,87938,87955,88005,88055,88105,88272,88338,88355,88438,88455,88572,88589,88639,88655,88672,88692,88693,88722,88739,89239,89240,111178,111678,111762,111778,111812,111828,111845,111895,111912,111962,111979,112012,112045,112095,112129,112196,112229,112270,112271,112312,112329,112379,112412,112496,112513,112563,112596,112629,112663,112696,112713,112763,112779,112813,112846,112880,112913,112946,112980,113013,113730,113747,113764,113814,113830,113881,113897,114014,114031,114047,114081,114097,114147,114164,114198,114214,114248,114281,114298,114348,114364,114381,114414,114515,114531,114615,114648,114681,114698,114731,114748,114798,114815,114831,114865,114882,114898,114932,114998,115015,115148,115182,115199,115232,115265,115282,115299,115382,115415,115432,115482,115499,115566,115599,115649,115666,115716,115749,115766,115782,115799,115816,115832,115849,115883,115899,115916,115949,115966,115999,116033,116116,116133,116183,116200,116233,116250,116283,116300,116316,116333,116350,116366,116400,116950,116966,116967,116967,117217,117301,117317,117367,117384,117434,117451,117501,117518,117584,117801,117835,117851,117868,117918,117951,117968,117985,118035,118051,118101,118118,118135,118151,118168,118202,118235,118252,118302,118335,118368,118385,118452,118485,118585,119303,119803,119820,119853,119887,119903,119937,119953,119987,120003,120020,120070,120103,120153,120320,120354,120370,120387,120437,120470,120487,120671,120687,120704,120721,120737,120754,120821,120871,121188,121221,121238,121255,121288,121338,121355,121388,121555,121572,121605,121622,121672,121688,121738,121755,121805,121822,121855,121872,121889,121922,121939,121981,121982,121989,122005,122022,122039,122674,122675,122773,122840,122856,122906,122923,122973,122990,123023,123040,123106,123123,123156,123173,123207,123240,123273,123323,123357,123373,123473,123490,123607,123624,123690,123707,123790,123941,123991,124024,124091,124107,124825,124858,124875,124925,124942,124975,125008,125108,125125,125142,125175,125192,125225,125259,125292,125309,125359,125375,125409,125425,125442,125459,125475,125509,125559,125592,125642,125676,125692,125726,125742,125776,125809,125843,125859,125909,125926,125976,125993,126026,126059,126109,126126,126243,126260,126293,126343,126393,126410,126476,126510,126527,126577,126593,126627,126660,126760,126793,126810,126827,126844,126894,126910,126960,126977,126994,127027,127044,127094,127110,127144,127177,127277,127311,127344,127427,127444,127494,128045,128061,128328,128378,128395,128428,128462,128545,128595,128612,128662,128679,128795,128910,128911,128962,129062,129146,129196,129229,129246,129279,129296,129346,129379,129396,129429,129479,129530,129596,129613,129630,129663,130397,130597,130898,130948,130964,131014,131031,131064,131098,131148,131164,131248,131398,131448,131481,131515,131548,131565,131598,131748,131765,131815,131832,131882,131899,131900,131901,131965,132316,132332,132366,132399,132432,132449,132499,132666,132683,132699,132749,132766,132816,132833,132883,132900,132950,132966,133000,133016,133050,133066,133083,133100,133133,133633,133634,157675,158175,158192,158258,158292,158342,158358,158408,158425,158458,158492,158525,158559,158592,158609,158642,158659,158675,158725,158742,158792,158809,158926,158942,158959,158992,159009,159059,159076,159126,159142,159159,159193,159209,159259,159276,159326,159343,159409,159508,159509,159526,159530,159531,159543,159560,159593,159610,159660,159676,159726,159743,159776,159793,159810,159860,159877,159927,159943,160010,160043,160077,160093,160177,160210,160227,160244,160294,160310,160360,160394,160410,160427,160477,160494,160544,160577,160611,160627,160677,160694,160727,160777,161277,161278,163180,163680,164198,164214,164264,164281,164331,164348,164381,164398,164414,164464,164481,164548,164715,164731,164748,164815,164831,164865,164882,165065,165082,165098,165115,165132,165148,165215,165265,165582,165616,165682,165732,165749,165782,165949,165966,165983,165999,166016,166066,166083,166133,166149,166200,166216,166250,166266,166283,166316,166333,166366,166374,166375,166383,166416,166979,166980,167167,167251,167267,167317,167334,167367,167384,167401,167451,167467,167484,167518,167584,167634,167684,167751,167851,168001,168035,168101,168118,168151,168202,168252,168335,168435,168452,168485,168519,169219,169269,169286,169319,169353,169403,169453,169503,169520,169553,169570,169586,169620,169653,169670,169686,169720,169753,169786,169803,169837,169870,169887,169903,169937,169953,169987,170037,170070,170087,170120,170137,170170,170204,170254,170270,170320,170337,170354,170370,170387,170420,170454,170487,170504,170637,170654,170671,170687,170721,170737,170771,170804,170871,170921,170938,170971,171004,171054,171088,171121,171154,171171,171221,171255,171271,171305,171321,171388,171438,171455,171488,171522,171588,171638,171672,171722,171755,171822,171872,172422,172439,172706,172756,172773,172823,172840,172873,172906,172956,172973,173006,173023,173073,173106,173317,173318,173340,173373,173390,173423,173540,173557,173607,173624,173657,173674,173724,173740,173790,173824,173841,173874,173891,173924,173957,173974,174041,174074,174775,175292,175325,175342,175375,175409,175425,175459,175475,175492,175509,175559,175592,175642,175792,175859,175876,175909,175926,175943,175993,176159,176176,176193,176210,176243,176276,176297,176298,176326,176376,176710,176743,176760,176793,176827,176844,176894,177060,177077,177094,177127,177160,177227,177244,177361,177377,177427,177444,177461,177511,177528,178028,178029}
const int16 angles[] = {-1,180,180,196,213,222,236,250,257,269,286,296,312,321,331,332,336,339,346,352,356,359,0,0,4,6,10,14,18,20,24,28,33,36,40,46,48,52,57,66,68,74,80,86,62,56,50,42,36,28,22,5,1,4,12,16,22,30,41,47,53,60,54,49,44,42,37,35,26,20,12,8,6,12,18,24,30,36,44,54,56,51,44,36,29,20,10,2,8,15,20,22,33,36,47,60,54,50,42,35,26,20,2,6,12,18,24,34,42,52,62,56,50,42,36,28,22,2,9,15,21,27,37,46,54,54,0,357,359,357,341,324,308,294,280,268,252,240,214,208,207,204,200,196,194,189,186,182,176,172,160,155,150,150,142,138,130,126,119,106,102,92,120,120,124,128,132,136,140,149,144,138,130,126,119,120,118,126,134,142,146,142,130,117,120,120,117,129,142,146,175,194,209,209,218,229,233,209,209,212,230,242,257,272,280,290,312,318,338,346,359,0,2,10,19,0,359,358,346,342,336,326,320,303,288,270,258,242,232,222,218,209,194,193,172,168,158,148,144,140,128,123,120,116,114,110,106,104,100,95,94,120,124,128,136,143,148,160,170,180,172,166,160,154,144,136,124,120,124,128,136,143,148,156,166,181,160,157,144,138,120,139,144,170,177,170,164,158,152,146,138,128,122,119,128,133,138,142,150,161,180,166,158,144,132,124,128,140,147,156,172,174,168,162,156,150,144,136,126,126,184,184,206,218,240,254,273,284,300,310,320,332,335,340,341,344,348,352,359,0,8,8,12,22,26,26,30,30,36,36,44,48,52,62,67,78,82,85,88,60,60,56,50,46,42,38,32,35,42,58,60,60,54,32,38,46,60,60,63,37,25,0,359,354,331,331,323,319,306,306,331,330,324,319,306,294,279,270,256,248,238,230,220,218,211,201,192,188,168,160,160,-1,61,61,56,50,42,35,26,17,3,10,16,22,29,38,46,56,60,55,50,42,36,30,24,18,8,6,12,18,24,32,38,49,56,60,52,44,42,38,35,26,20,11,8,4,12,18,24,30,36,48,58,51,46,41,31,26,12,3,8,16,24,33,42,48,57,56,48,43,40,36,34,28,15,10,2,8,14,20,30,42,48,54,58,58,0,359,357,357,336,293,268,227,207,194,193,182,179,173,154,149,142,138,137,132,100,92,119,120,124,130,134,142,148,142,134,130,125,120,120,136,145,137,119,122,139,151,188,202,209,209,212,222,234,238,234,226,222,220,209,209,202,214,221,225,232,243,259,268,282,290,300,308,316,318,328,336,345,349,358,359,0,8,16,20,0,0,359,344,326,318,304,296,283,270,254,242,226,218,209,202,201,198,188,184,182,178,176,168,168,163,156,154,150,146,138,136,132,130,122,122,117,110,106,102,99,96,93,120,128,132,138,145,150,156,165,176,174,162,154,148,142,134,125,120,128,132,138,147,152,162,171,174,168,162,156,149,143,132,122,122,130,135,138,142,144,149,159,168,171,176,170,164,158,150,144,136,120,126,131,138,148,157,166,178,172,165,158,148,144,133,120,128,134,143,148,160,170,180,172,166,158,150,139,133,126,124,124,180,180,192,196,208,222,244,264,276,286,302,312,318,322,333,344,347,349,359,0,6,10,24,25,30,34,42,51,54,70,78,80,85,86,61,60,54,50,44,38,32,37,46,52,57,60,60,53,46,42,41,51,62,60,60,52,42,30,0,359,331,330,326,319,319,310,318,318,331,331,328,322,318,306,289,278,264,256,242,234,220,214,205,196,187,178,160,196,218,234,262,274,332,342,346,359,359,0,22,30,34,40,44,46,50,56,58,62,68,80,84,88,59,56,51,44,36,29,22,11,2,4,14,20,26,34,36,44,54,63,54,48,41,34,26,20,8,4,12,18,24,30,36,48,59,51,46,41,31,29,17,10,2,10,16,22,29,38,46,56,60,52,47,42,32,24,10,0,6,14,19,25,32,38,50,53,56,54,48,42,35,26,6,2,14,26,34,38,43,52,52,0,0,0,359,344,328,314,298,291,278,260,250,234,223,220,208,202,194,190,186,184,179,176,172,160,155,143,138,136,130,126,122,114,109,102,98,93,120,120,124,135,143,148,138,128,124,119,120,118,139,147,143,136,126,120,120,122,134,142,147,172,196,202,209,209,215,222,238,220,209,210,233,246,272,282,316,324,338,344,353,359,0,9,16,16,-1,186,186,214,229,244,252,264,282,292,308,318,326,334,340,344,350,355,359,0,4,8,13,18,26,30,34,41,44,48,52,54,58,62,65,70,72,77,80,84,88,62,58,53,45,38,31,24,2,4,12,18,24,34,42,48,54,62,56,50,42,38,35,26,4,0,20,30,36,42,50,56,56,53,48,42,38,35,26,14,6,4,12,18,25,34,36,44,59,54,48,40,34,22,12,6,4,16,24,26,34,36,42,44,51,57,62,56,50,46,40,31,15,9,2,8,14,20,26,34,36,42,44,51,57,57,0,359,358,358,330,317,294,281,262,252,236,226,206,183,178,177,173,168,164,162,159,154,150,146,144,142,138,138,132,130,126,122,118,114,111,106,100,90,120,120,122,128,132,136,140,146,148,146,140,132,126,119,120,128,135,139,138,128,120,120,131,136,143,148,160,190,209,209,212,219,224,236,224,216,209,209,213,224,236,253,263,276,286,298,308,316,318,328,336,346,359,0,2,8,16,22,0,359,356,335,323,300,286,268,257,246,236,214,208,206,202,199,194,192,186,183,180,168,165,152,148,142,138,130,110,106,102,94,93,120,124,130,138,144,149,158,178,176,169,163,158,150,139,133,127,120,126,131,136,138,143,145,154,164,172,174,168,162,156,150,143,132,126,118,127,132,140,146,152,161,170,176,178,172,164,152,139,132,120,126,132,138,146,150,160,178,170,164,162,156,146,138,128,122,119,124,130,138,145,150,159,178,171,162,144,136,125,125,186,186,203,210,227,247,284,304,312,328,332,347,359,0,5,18,27,34,37,41,44,48,52,56,57,62,66,73,80,82,85,88,60,62,60,54,50,44,38,36,35,44,48,60,60,52,44,32,44,53,60,60,58,42,30,9,0,0,359,332,330,325,312,302,312,320,331,330,326,314,296,286,271,262,248,240,226,220,212,203,194,185,180,170,162,162,-1,50,50,48,34,26,15,10,2,8,14,24,30,42,48,54,62,58,53,46,38,31,24,2,4,12,18,24,34,42,51,58,61,56,50,42,36,28,22,8,0,359,358,359,0,4,10,16,22,32,40,50,56,60,57,52,44,37,30,23,10,0,8,14,32,43,46,52,60,55,48,38,36,31,22,16,6,4,10,16,26,30,42,52,52,-1,120,120,120,124,130,134,140,146,148,146,140,132,128,120,120,124,132,145,138,128,120,120,131,136,143,148,162,192,210,209,214,236,224,216,209,210,214,220,225,238,254,264,278,286,300,308,318,320,328,337,346,355,359,0,4,16,0,359,354,327,312,290,278,265,260,248,232,222,220,208,201,194,190,182,170,150,148,138,136,132,128,120,111,100,98,94,91,120,128,134,138,148,156,170,180,172,167,160,158,148,142,137,130,124,123,128,134,138,148,150,154,160,166,172,174,168,162,156,148,142,132,122,122,130,136,138,142,145,154,159,169,172,176,172,169,163,158,150,144,132,121,129,134,139,149,158,168,174,178,172,160,154,147,139,132,121,129,134,139,148,160,174,179,166,158,144,128,128,180,180,197,206,227,242,255,274,290,300,310,318,332,336,359,0,2,8,10,14,28,32,36,40,44,46,50,54,58,62,64,68,70,74,76,80,88,88,60,60,56,52,48,42,40,34,32,34,40,48,54,60,60,48,38,32,37,48,60,61,55,44,37,24,10,0,359,346,331,331,318,310,304,316,318,331,331,326,314,302,289,266,256,222,214,200,194,186,170,160,160,-1}
int maxIdx = 1740;
int bpm=173;
int ribbon_offset=0;

//deadzone for autoswirl set negative to disable
int deadzone=5;
int ms=0;
int ms_ribbon=0;
int running=0;

int idx=0;
int curAngle=-1;

int next_beat=0;
int beat_anticipate=0;
int autoswirl=0;

init {
	beat_anticipate=60000/(bpm*4);
}

main {
	ms+=get_rtime();
	if (get_val(XB1_VIEW)>0 && event_press(XB1_A)) {
		ms=0;
		idx=0;
		next_beat=0;
		cls_oled(0);
		running=1;
		putc_oled(1,82);
		putc_oled(2,117);
		putc_oled(3,110);
		puts_oled(40,20,2,3,1);
	}
	if (event_press(XB1_B)) {
		ms=0;
		idx=0;
		next_beat=0;
		cls_oled(0);
		running=0;
		putc_oled(1,83);
		putc_oled(2,116);
		putc_oled(3,111);
		putc_oled(4,112);
		puts_oled(30,20,2,4,1);
	}
	if (event_press(XB1_RB)) {ribbon_offset = ribbon_offset + 25;set_val(TRACE_1,ribbon_offset);}
	if (event_press(XB1_LB)) {ribbon_offset = ribbon_offset - 25;set_val(TRACE_1,ribbon_offset);}
	
	if (running) {
		set_val(TRACE_2,ms);
		ms_ribbon = ms + ribbon_offset;
		//advance until we reach the end or catch up with the time code
		while (idx<maxIdx && ms_ribbon>times[idx + 1]) {
			idx++;
		}
		//if we've reached the end of the ribbon, releast LS
		if (idx>=maxIdx || angles[idx]== -1) {
			curAngle=-1;
		} else {
			curAngle=angles[idx]+(angles[idx + 1]-angles[idx])*(ms_ribbon-times[idx])/(times[idx + 1]-times[idx]);
		}
		//set LS position if ribbon present
		if (curAngle>=0) set_polar(POLAR_LS,curAngle,32767);

		//shoot if we are on the beat
		if ((ms+beat_anticipate)>((next_beat*2*60000)/bpm)) {
			next_beat+=1;
			combo_run(fire);
		}

		//swirl reticle if idle
		if (event_press(XB1_X)) {if (autoswirl==0) {autoswirl=1} else {autoswirl=0}}
		if (autoswirl==1 && get_val(XB1_RX)<=deadzone && get_val(XB1_RY)<=deadzone && get_val(XB1_RX)>=-deadzone && get_val(XB1_RY)>=-deadzone) {set_polar(POLAR_RS,ms%360,32767);}
	}
}

combo fire {
	set_val(XB1_RT,100);wait(50);
}
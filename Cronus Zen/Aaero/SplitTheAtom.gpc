const int32 times[] = {0,15716,16216,16216,16716,16717,19070,19570,19570,20070,20071,23791,24291,24291,24791,24792,28262,28762,28762,29262,29263,31182,31682,31765,31782,31815,31832,31899,31915,31932,32015,32032,32049,32065,32082,32115,32132,32148,32149,32149,32199,32216,32266,32282,32349,32366,32432,32449,32516,32533,32599,33267,33283,33600,33634,33684,33700,33717,33750,33767,33784,33834,33851,33917,33934,34001,34034,34082,34083,34084,34085,34086,34134,34184,34201,34251,34268,34284,34351,34368,34451,34468,34501,34535,35519,35552,35569,35619,35636,35652,35702,35719,35752,35769,35853,35869,35886,35919,35936,35953,35969,35997,35998,36003,36019,36036,36069,36086,36119,36136,36186,36203,36253,36270,36320,36336,36403,36420,36436,37104,37120,37437,37521,37554,37571,37604,37621,37704,37721,37738,37771,37804,37821,37838,37888,37921,38021,38038,38088,38138,38155,38222,38288,38305,38338,38355,38372,38872,38873,39757,40257,40891,40908,41859,41875,42809,42826,43777,43794,44728,44745,45045,45545,45546,46547,47047,47080,47164,47214,47231,47297,47314,47331,47397,47414,47447,47508,47509,47514,47531,47614,47631,47648,47698,47731,47814,47831,47915,47931,47948,48448,48449,48466,48966,49049,49082,49116,49132,49249,49266,49349,49383,49399,49449,49499,49550,49633,49700,49750,49766,49800,49816,49833,49867,49883,50884,50951,50984,51018,51051,51068,51118,51134,51185,51201,51235,51251,51268,51301,51318,51345,51346,51351,51401,51418,51451,51468,51518,51552,51568,51585,51652,51668,51735,51752,51802,52636,52653,52803,52886,52920,52936,52953,53020,53036,53103,53120,53153,53170,53187,53220,53287,53353,53387,53453,53470,53537,53554,53654,53670,53687,53720,54721,54755,54805,54821,54838,54872,54905,54922,54988,55005,55072,55105,55122,55138,55155,55192,55193,55205,55255,55272,55289,55305,55355,55389,55439,55455,55572,55606,56223,56490,56507,56657,56723,56740,56757,56773,56790,56840,56857,56890,56907,56940,56957,57007,57024,57040,57057,57090,57124,57140,57157,57224,57241,57307,57324,57357,57374,57441,57457,57474,57491,57541,57608,57791,58625,59309,59526,59610,59626,59643,59726,59743,60210,60244,60260,60360,60377,60410,60460,60494,60577,60744,60761,60961,61011,61028,61078,61144,61161,61228,61245,61361,61861,61862,61896,62396,62446,62496,62513,62546,62563,62579,62646,62663,62729,62746,62779,62813,62829,62846,62873,62874,62880,62930,62946,62996,63063,63096,63163,63180,63247,63263,63313,63981,63997,64314,64364,64448,64481,64498,64565,64581,64598,64681,64698,64748,64765,64796,64797,64798,64799,64800,64848,64898,64915,64932,64998,65015,65032,65115,65132,65165,65182,65249,66250,66333,66400,66416,66433,66517,66550,66600,66617,66633,66683,66715,66716,66717,66750,66767,66834,66850,66900,66917,66934,66950,67034,67050,67134,67150,67650,67651,67685,68185,68235,68285,68318,68335,68402,68418,68502,68519,68535,68585,68602,68652,68685,68752,68819,68836,68919,68936,69002,69019,69036,69086,70070,70153,70187,70204,70254,70287,70304,70387,70404,70420,70437,70454,70470,70504,70521,70537,70553,70554,70554,70604,70621,70671,70687,70737,70771,70854,70871,70954,70988,71488,71489,71505,72005,72039,72072,72105,72122,72139,72222,72239,72306,72322,72356,72372,72389,72406,72439,72456,72471,72472,72472,72473,72474,72573,72606,72623,72639,72723,72739,72840,72873,72890,72923,72940,73924,73974,74041,74057,74107,74124,74208,74224,74274,74291,74308,74324,74374,74390,74391,74391,74474,74591,74658,74842,75509,75526,75843,75909,75959,76009,76026,76093,76109,76193,76210,76260,76276,76326,76410,76426,76476,76493,76577,76593,76693,76710,76760,76777,77277,77278,91642,92142,92593,93093,93094,93561,94061,94545,95045,95046,95479,95979,96463,96963,96964,97398,97898,97898,98398,98399,99316,99816,99816,100316,100317,101252,101752,101752,102252,102253,103170,103670,104137,104637,104638,105072,105572,106056,106556,106557,106991,107491,107491,107991,107992,123341,123841,123874,123907,123941,123957,123991,124024,124041,124057,124074,124091,124124,124141,124191,124208,124224,124241,124258,124274,124315,124316,124341,124391,124408,124458,124474,124491,124525,124541,124558,124625,124641,124725,124741,125241,125242,125276,125776,125809,125843,125876,125893,125976,125993,126076,126093,126109,126143,126159,126176,126210,126226,126326,126360,126376,126426,126443,126460,126510,126527,126593,126610,126627,126643,126677,127678,127778,127861,127878,127928,127945,127995,128011,128028,128045,128061,128095,128111,128128,128144,128145,128145,128178,128195,128245,128262,128295,128312,128345,128378,128412,128462,128478,128529,128545,128595,129263,129279,129596,129646,129696,129713,129763,129780,129796,129863,129880,129930,129947,129963,129997,130013,130080,130113,130130,130180,130197,130214,130230,130280,130297,130380,130397,130430,130447,130480,130514,130531,131515,131615,131632,131648,131682,131698,131782,131798,131815,131882,131899,131915,131949,131965,131997,131998,131999,132015,132032,132082,132099,132149,132182,132249,132266,132349,132366,132432,133100,133116,133433,133500,133550,133600,133617,133667,133684,133750,133767,133800,133817,133834,133851,133867,133901,133934,134017,134034,134051,134117,134201,134218,134284,134318,134334,134368,135369,135469,135536,135552,135602,135636,135652,135719,135736,135752,135786,135834,135835,135836,135853,135869,135919,135936,135986,136019,136086,136103,136170,136186,136286,136954,136970,137287,137387,137404,137487,137504,137588,137604,137638,137654,137671,137688,137704,137721,138221,138222,138706,139206,139306,139323,139339,139423,139439,139523,139540,139590,139606,139640,139676,139677,139690,139706,139756,139773,139806,139840,139857,139873,139957,139973,140057,140073,140107,140607,140608,140624,141124,141208,141291,141308,141425,141441,141475,141491,141525,141558,141606,141607,141608,141609,141610,141708,141775,141875,141942,141975,142042,143043,143143,143227,143243,143327,143343,143393,143427,143460,143493,143509,143510,143510,143577,143594,143644,143677,143694,143710,143777,143794,143877,143894,143961,144628,144645,144962,145062,145078,145095,145145,145179,145195,145295,145312,145329,145362,145395,145445,145512,145579,145629,145646,145729,145746,145796,145812,145846,145879,146880,146980,146997,147014,147097,147114,147214,147231,147264,147281,147314,147359,147360,147364,147381,147431,147464,147548,147581,147731,147748,147764,147798,148465,148482,148799,148882,148916,148932,148999,149049,149066,149116,149149,149166,149216,149233,149283,149366,149383,149433,149449,149516,149533,149583,149600,149633,149650,149700,149716,149766,151668,151702,151752,151768,151785,151852,151869,151885,152369,152386,152402,152503,152519,152553,152619,152636,153120,153153,153170,153220,153237,153303,153320,153437,153453,153554,154221,154238,154555,154655,154721,154738,154788,154805,154855,154872,154905,154938,154955,154972,155035,155036,155055,155088,155105,155138,155172,155222,155239,155289,155305,155355,155372,155439,155455,155472,156139,156156,156473,156523,156573,156590,156607,156657,156673,156740,156757,156807,156823,156840,156874,156907,156957,157007,157057,157074,157124,157140,157224,157241,157324,157341,157374,157407,158408,158492,158559,158575,158592,158659,158675,158759,158775,158792,158825,158842,158871,158872,158892,158942,158959,159009,159026,159042,159059,159109,159126,159209,159226,159276,159293,159309,159809,159810,159827,160327,160377,160427,160444,160477,160527,160544,160577,160594,160644,160661,160694,160711,160727,160744,160761,160811,160861,160894,160911,160928,160944,160978,160994,161011,161061,161111,161128,161195,161228,161245,162229,162312,162346,162362,162396,162412,162462,162479,162529,162546,162646,162663,162706,162707,162713,162729,162763,162796,162813,162863,162880,162896,162930,162996,163013,163063,163080,163163,163814,163830,164147,164198,164264,164281,164298,164364,164381,164481,164498,164515,164548,164565,164581,164631,164748,164765,164848,164865,164948,164965,164998,165015,165065,165082,166083,166166,166200,166216,166266,166283,166300,166366,166383,166433,166466,166483,166517,166553,166554,166567,166650,166667,166733,166783,166800,166884,166900,166967,166984,167484,167485,167952,168452,168468,168485,168502,168519,168535,168569,168585,168652,168669,168735,168752,168802,168819,168886,168919,168952,168986,169002,169019,169036,169052,169069,169086,169136,169152,169169,169203,169219,169269,169286,169353,169386,169436,169469,169486,169503,169520,169553,169570,169620,169636,169703,169720,169803,169820,169837,170204,170219,170220,170220,170437,170539,170540,170888,170904,170938,170954,170971,171021,171038,171104,171121,171171,171221,171255,171271,171305,171355,171371,171421,171438,171455,171488,171505,171522,171538,171605,171622,171705,171722,171755,171788,172139,172155,172356,172806,172856,172873,172890,172940,172956,173006,173023,173056,173073,173123,173156,173173,173190,173273,173290,173307,173323,173357,173373,173407,173423,173473,173490,173540,173557,173590,173607,173624,173640,173657,173674,173707,174041,174056,174057,174057,174626,174627,174708,174725,174741,174775,174791,174808,174825,174842,174892,174908,174958,174975,174992,175042,175058,175075,175192,175225,175242,175259,175309,175325,175375,175392,175442,175459,175475,175526,175542,175576,175626,175976,175993,176143,176643,176644}
const int16 angles[] = {-1,270,270,270,270,-1,270,270,270,270,-1,270,270,270,270,-1,270,270,270,270,-1,180,180,208,214,229,242,267,272,282,308,318,320,326,329,346,350,359,0,0,9,14,22,27,38,46,56,61,72,77,88,88,182,182,192,204,212,224,240,246,258,274,282,302,311,328,344,359,0,0,0,359,344,320,314,292,286,275,254,244,220,218,201,190,182,192,196,213,221,234,252,263,274,283,306,316,318,328,338,344,347,359,0,2,4,10,16,20,24,30,38,46,52,58,66,70,80,86,88,88,180,180,208,221,230,244,256,283,294,300,308,318,320,330,347,357,328,314,292,275,264,242,224,220,209,199,211,211,-1,356,356,356,184,184,356,356,184,184,356,356,184,184,184,-1,184,184,194,226,248,259,281,286,296,314,322,332,359,0,2,4,20,22,28,36,46,60,66,80,84,87,87,-1,182,182,211,224,240,252,290,300,324,340,346,358,342,326,287,260,244,234,222,220,212,200,190,186,204,220,231,244,258,274,284,298,308,316,318,328,338,348,359,0,2,10,14,20,24,32,42,44,50,60,66,76,80,88,90,182,182,210,222,230,242,266,277,296,306,316,318,324,339,356,336,319,293,281,260,250,220,218,212,194,182,194,205,212,223,240,252,263,284,294,314,326,330,336,346,359,0,4,12,18,20,24,32,42,50,54,75,82,90,90,190,190,208,220,224,231,243,260,270,280,288,298,306,320,326,330,340,349,357,352,344,324,312,287,275,265,256,236,228,222,220,205,180,179,180,179,176,144,135,122,94,90,90,100,110,136,142,151,169,180,179,169,180,181,170,164,156,142,138,124,124,100,100,-1,180,180,194,215,220,236,242,255,277,286,306,316,323,332,344,348,359,0,2,10,16,25,38,48,58,64,74,80,87,87,180,180,194,226,242,254,276,282,292,316,324,340,350,359,0,0,0,359,344,328,322,308,282,276,264,240,230,220,218,194,183,211,240,248,260,286,302,316,320,329,346,359,0,0,6,12,22,29,38,42,44,50,64,69,82,88,88,-1,191,191,206,224,238,252,275,286,310,320,322,338,348,356,346,320,290,279,252,242,222,220,211,194,180,201,212,227,248,260,272,298,308,312,318,320,324,340,346,350,359,0,0,10,14,22,28,36,46,60,66,80,86,86,-1,180,180,191,202,213,221,236,266,278,298,308,316,320,324,334,346,350,359,0,0,0,359,328,316,308,294,265,254,226,212,208,195,190,184,199,224,233,253,265,291,300,316,318,324,333,348,359,0,0,15,36,52,86,86,180,180,204,223,244,257,279,289,314,322,336,347,358,327,320,300,288,260,250,224,222,195,190,190,-1,270,270,270,270,-1,315,315,315,315,-1,356,356,356,356,-1,45,45,45,45,-1,90,90,90,90,-1,135,135,135,135,-1,184,184,184,184,-1,225,225,225,225,-1,270,270,270,270,-1,182,182,191,199,211,225,240,253,265,270,278,280,290,300,316,318,324,333,338,346,359,0,8,16,21,30,34,37,44,46,52,62,68,82,86,86,-1,184,184,196,206,220,234,266,276,302,312,316,324,328,340,350,359,330,319,304,285,279,268,253,244,224,222,216,212,199,183,214,250,262,280,288,302,312,316,318,328,337,347,350,359,0,0,4,10,20,22,30,32,42,47,54,62,68,75,80,88,88,180,180,194,211,225,246,252,264,284,294,308,318,320,328,339,358,347,343,320,316,309,296,278,268,244,234,224,222,212,199,194,180,212,222,228,244,256,283,292,298,318,320,330,342,350,359,0,0,0,12,18,22,32,41,52,57,70,76,86,86,180,180,201,221,242,255,272,282,300,310,320,322,328,331,343,350,356,328,322,307,280,254,242,220,213,207,190,182,214,246,260,278,288,298,318,320,330,340,359,0,0,4,10,16,22,30,40,51,56,68,72,88,88,182,182,215,230,262,274,298,308,318,322,326,334,342,346,346,-1,182,182,216,222,238,268,279,304,314,326,331,347,359,0,4,8,16,22,26,33,36,43,57,62,76,82,86,86,-1,184,184,212,248,260,296,306,318,320,330,343,359,0,0,0,359,324,292,254,230,222,197,182,214,252,266,292,302,316,324,340,350,359,0,0,12,18,26,35,38,42,53,58,72,78,88,88,180,180,214,222,236,256,267,278,308,318,320,330,347,359,334,306,286,274,248,238,222,220,210,197,180,212,220,236,266,278,308,318,324,330,346,359,0,1,8,16,24,38,48,74,82,81,86,86,184,184,205,218,232,261,278,288,302,313,320,336,346,358,328,322,301,288,265,256,242,232,222,220,205,196,180,179,168,150,143,128,105,94,90,90,96,106,132,142,150,174,180,180,173,167,159,154,142,136,116,110,94,94,182,182,212,240,254,272,282,296,306,314,326,329,339,359,0,6,12,17,22,30,38,44,52,57,65,70,80,86,88,88,180,180,194,211,218,232,251,263,283,292,306,316,318,328,344,358,344,322,317,296,283,256,246,222,220,208,191,184,212,242,248,261,282,292,316,320,329,340,350,359,0,6,14,20,27,33,36,40,48,54,66,72,80,85,88,88,-1,182,182,201,222,227,242,262,274,284,292,306,316,322,328,336,342,350,351,338,322,318,310,298,286,281,270,256,240,230,212,201,192,180,206,222,227,240,253,272,280,294,302,333,342,359,0,2,4,12,18,22,30,36,38,48,58,62,70,76,88,88,180,180,190,213,222,237,262,273,302,313,318,326,331,342,358,322,309,277,266,240,232,222,218,202,196,181,208,221,236,256,261,272,292,302,316,328,332,347,359,0,4,18,24,36,47,52,66,72,82,88,88,-1,93,93,96,90,100,102,108,112,116,125,130,138,142,150,154,166,174,180,168,164,150,144,136,130,119,102,92,86,78,69,56,48,30,15,2,17,22,34,42,52,63,79,90,108,118,138,144,148,148,0,356,359,357,359,0,8,16,26,38,46,63,74,95,104,118,132,146,150,163,178,171,155,148,133,119,115,109,98,78,68,46,37,28,17,17,184,183,172,156,143,135,118,107,91,82,72,64,52,38,34,26,0,11,16,25,36,49,60,70,85,94,108,116,125,133,137,143,146,155,166,166,0,356,359,359,0,0,4,16,26,37,45,50,60,76,87,102,106,114,128,136,139,180,168,162,152,130,119,102,92,78,74,64,51,44,34,20,20,184,184,184,-1}
int maxIdx = 1399;
int bpm=125;
int ribbon_offset=0;

//deadzone for autoswirl set negative to disable
int deadzone=5;
int ms=0;
int ms_ribbon=0;
int running=0;

int idx=0;
int curAngle=-1;

int next_beat=0;
int beat_anticipate=0;
int autoswirl=0;

init {
	beat_anticipate=60000/(bpm*4);
}

main {
	ms+=get_rtime();
	if (get_val(XB1_VIEW)>0 && event_press(XB1_A)) {
		ms=0;
		idx=0;
		next_beat=0;
		cls_oled(0);
		running=1;
		putc_oled(1,82);
		putc_oled(2,117);
		putc_oled(3,110);
		puts_oled(40,20,2,3,1);
	}
	if (event_press(XB1_B)) {
		ms=0;
		idx=0;
		next_beat=0;
		cls_oled(0);
		running=0;
		putc_oled(1,83);
		putc_oled(2,116);
		putc_oled(3,111);
		putc_oled(4,112);
		puts_oled(30,20,2,4,1);
	}
	if (event_press(XB1_RB)) {ribbon_offset = ribbon_offset + 25;set_val(TRACE_1,ribbon_offset);}
	if (event_press(XB1_LB)) {ribbon_offset = ribbon_offset - 25;set_val(TRACE_1,ribbon_offset);}
	
	if (running) {
		set_val(TRACE_2,ms);
		ms_ribbon = ms + ribbon_offset;
		//advance until we reach the end or catch up with the time code
		while (idx<maxIdx && ms_ribbon>times[idx + 1]) {
			idx++;
		}
		//if we've reached the end of the ribbon, releast LS
		if (idx>=maxIdx || angles[idx]== -1) {
			curAngle=-1;
		} else {
			curAngle=angles[idx]+(angles[idx + 1]-angles[idx])*(ms_ribbon-times[idx])/(times[idx + 1]-times[idx]);
		}
		//set LS position if ribbon present
		if (curAngle>=0) set_polar(POLAR_LS,curAngle,32767);

		//shoot if we are on the beat
		if ((ms+beat_anticipate)>((next_beat*2*60000)/bpm)) {
			next_beat+=1;
			combo_run(fire);
		}

		//swirl reticle if idle
		if (event_press(XB1_X)) {if (autoswirl==0) {autoswirl=1} else {autoswirl=0}}
		if (autoswirl==1 && get_val(XB1_RX)<=deadzone && get_val(XB1_RY)<=deadzone && get_val(XB1_RX)>=-deadzone && get_val(XB1_RY)>=-deadzone) {set_polar(POLAR_RS,ms%360,32767);}
	}
}

combo fire {
	set_val(XB1_RT,100);wait(50);
}
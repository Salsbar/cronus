const int32 times[] = {0,27461,27961,27995,28011,28028,28045,28095,28111,28128,28145,28178,28228,28328,28428,28462,28512,28545,28595,28629,28695,28745,28762,28779,28795,28829,28896,28912,28929,28962,28979,28996,29029,29046,29079,29096,29129,29146,29196,29213,29246,29296,29346,29396,29413,29446,29463,29496,29513,29530,29546,29580,29596,29980,29997,30030,30047,30247,30364,30380,30430,30480,30497,30514,30714,30731,30747,30764,30781,30814,30848,30864,30881,30898,30914,30931,30948,30981,30998,31014,31031,31081,31098,31114,31164,31215,31231,31265,31398,31498,31515,31632,31648,31665,31682,31698,31748,31765,31882,31899,31932,31949,31999,32015,32032,32049,32065,32082,32115,32149,32165,32182,32216,32232,32249,32266,32299,32316,32349,32849,32850,38339,38839,38872,38889,38906,38922,38956,38972,38989,39006,39039,39056,39072,39089,39122,39139,39223,39273,39289,39306,39323,39373,39389,39406,39423,39456,39489,39506,39523,39540,39573,39590,39623,39640,39690,39740,39756,39773,39790,39806,39840,39857,39873,39940,39973,39990,40023,40040,40057,40073,40090,40123,40140,40157,40274,40290,40307,40324,40340,40357,40374,40407,40440,40457,40474,40490,40524,40891,40924,40974,41008,41024,41041,41058,41091,41141,41208,41225,41308,41358,41408,41441,41458,41475,41625,41675,41692,41708,41725,41742,41758,41775,41792,41808,41825,41842,41859,41892,41909,41925,41942,41959,41975,42009,42025,42042,42059,42092,42109,42125,42142,42159,42176,42192,42209,42226,42309,42342,42359,42492,42509,42526,42543,42576,42593,42693,42726,42743,42759,42793,42876,42910,42943,42976,42993,43010,43026,43060,43076,43093,43110,43143,43193,43210,43227,43260,43760,43761,48616,49116,49149,49166,49316,49333,49399,49433,49533,49550,49616,49633,49683,49700,49733,49766,49800,49816,49850,49867,49900,49967,49983,50000,50017,50150,50167,50184,50334,50400,50417,50434,50450,50467,50484,50517,50534,50551,50567,50684,50717,50734,50751,50784,50801,50817,50834,50984,51001,51018,51051,51068,51101,51168,51201,51218,51235,51251,51268,51285,51301,51318,51351,51368,51401,51418,51451,52152,52169,52219,52336,52352,52369,52386,52402,52436,52452,52536,52553,52603,52619,52636,52653,52686,52703,52719,52736,52753,52786,52819,52836,52853,52870,52903,52920,52936,52953,52970,52986,53020,53036,53053,53070,53103,53120,53187,53220,53237,53303,53370,53387,53437,53470,53487,53537,53570,53587,53604,53637,53670,53720,53737,53837,53854,53871,53904,53921,53937,53954,53971,53987,54004,54021,54037,54054,54071,54104,54121,54137,54171,54671,54672,59543,60043,60077,60093,60177,60194,60227,60244,60277,60310,60360,60410,60477,60511,60527,60644,60661,60711,60744,60761,60777,60794,60827,60844,60878,60894,60911,60928,60961,61044,61078,61144,61211,61228,61261,61278,61295,61311,61328,61361,61378,61411,61428,61461,61478,61562,61595,61612,61628,61662,61678,61712,61728,61762,61778,61828,61845,61862,61879,61912,61929,61962,62079,62095,62129,62145,62162,62179,62196,62229,62262,62279,62312,62329,62346,63046,63063,63080,63113,63130,63146,63163,63180,63197,63213,63230,63263,63280,63297,63313,63330,63347,63447,63463,63497,63514,63547,63564,63580,63597,63630,63647,63664,63680,63714,63730,63747,63780,63797,63814,63830,63847,63864,63881,63897,63947,63964,63981,63997,64014,64031,64081,64114,64131,64147,64164,64198,64298,64348,64364,64414,64448,64464,64498,64515,64531,64581,64648,64665,64731,64748,64765,64781,64798,64815,64848,64865,64898,64948,64982,64998,65032,65048,65082,65582,65583,65666,66166,66183,66200,66216,66233,66250,66266,66283,66316,66333,66366,66383,66416,66450,66466,66500,66517,66550,66567,66583,66667,66700,66717,66733,66750,66767,66783,66817,66834,66850,66900,66917,66950,66967,66984,67000,67034,67050,67067,67117,67184,67217,67251,67284,67301,67317,67334,67367,67401,67417,67434,67451,67484,67501,67518,67534,67551,67568,67584,67601,67634,68252,68268,68552,68569,68585,68602,68619,68652,68702,68719,68735,68752,68769,68785,68802,68836,68869,68886,68902,68919,68936,68969,69036,69052,69069,69086,69102,69119,69136,69186,69236,69269,69286,69319,69336,69353,69369,69386,69403,69419,69436,69469,69486,69520,69536,69553,69586,69603,69620,69636,69653,69670,69686,69703,69720,69920,69937,69953,70037,70053,70087,70187,70270,70287,70304,70320,70337,70354,70370,70387,70420,70437,70454,70470,70487,70504,70521,71021,71022,71122,71622,71672,71688,71705,71722,71738,71755,71772,71788,71839,71905,71922,71939,71955,71972,71989,72005,72022,72039,72105,72139,72155,72206,72256,72289,72306,72356,72422,72439,72456,72472,72489,72523,72539,72556,72639,72656,72673,72689,72706,72723,72789,72806,72823,72840,72873,72906,72923,72940,72956,72973,73006,73040,73056,73090,73674,73690,73957,73974,73991,74007,74024,74057,74074,74091,74107,74141,74157,74191,74208,74224,74241,74358,74374,74391,74408,74441,74458,74474,74491,74525,74541,74558,74575,74608,74641,74658,74691,74708,74725,74741,74775,74808,74825,74842,74858,74875,74908,74925,75008,75042,75058,75075,75108,75192,75225,75242,75292,75325,75475,75576,75592,75626,75659,75676,75709,75726,75742,75759,75792,75809,75843,75859,75876,75893,75926,75976,76260,76276,76393,76660,76677,76693,76793,76810,76860,76894,77010,77044,77060,77094,77177,77194,77227,77244,77277,77294,77311,77327,77394,77411,77477,77511,77694,77711,77828,77845,78061,78095,78111,78128,78161,78212,78228,78245,78345,78428,78445,78495,78512,78529,78579,78595,78629,78645,78695,78712,79213,79229,79463,79479,79496,79513,79530,79546,79563,79580,79613,79630,79646,79680,79696,79713,79746,79763,79780,79796,79813,79847,79863,79880,79897,79930,79947,79963,79980,80013,80047,80113,80147,80163,80180,80197,80214,80230,80264,80280,80297,80314,80347,80364,80380,80397,80430,80597,80631,80647,80681,80764,80864,80881,80964,80981,81014,81031,81048,81164,81181,81215,81265,81281,81298,81315,81348,81365,81398,81415,81431,81949,81965,82199,82216,82232,82349,82449,82482,82499,82649,82666,82733,82833,82900,83217,83283,83300,83383,83417,83534,83667,83684,83750,83767,83867,83917,84034,84051,84101,84117,84134,84184,84685,84701,84935,85018,85052,85085,85202,85219,85235,85285,85352,85369,85452,85469,85485,85519,85569,85619,85702,85736,85752,85769,85869,85903,86053,86069,86303,86320,86336,86420,86603,86637,86737,86753,86770,86887,86904,87404,87405,136537,137037,137070,137087,137104,137120,137154,137204,137271,137287,137304,137321,137387,137421,137437,137454,137604,137638,137654,137688,137704,137721,137738,137754,137788,137804,137821,137838,137905,137921,137955,137971,138021,138055,138071,138088,138121,138138,138172,138188,138205,138222,138255,138305,138338,138355,138438,138455,138472,138488,138505,138522,138539,138555,138589,138605,138655,138672,138722,139072,139106,139139,139173,139189,139223,139239,139273,139289,139306,139323,139339,139406,139489,139506,139590,139606,139623,139706,139790,139806,139823,139840,139857,139873,139890,139907,139923,139957,139973,139990,140007,140040,140057,140073,140090,140123,140140,140157,140174,140207,140224,140240,140274,140290,140307,140324,140340,140374,140390,140407,140457,140490,140507,140524,140691,140741,140774,140908,140924,141058,141074,141108,141141,141158,141175,141241,141258,141275,141291,141308,141325,141341,141375,141408,141441,141941,141942,147431,147931,147948,147965,147981,148015,148031,148048,148065,148098,148115,148131,148182,148215,148232,148365,148398,148415,148432,148448,148465,148482,148532,148549,148582,148599,148615,148632,148665,148682,148715,148732,148799,148815,148849,148882,148899,148932,148966,148982,148999,149032,149049,149082,149132,149166,149199,149216,149349,149366,149383,149399,149416,149433,149449,149466,149483,149516,149533,149566,149583,149600,149616,149983,150100,150150,150200,150217,150234,150250,150267,150367,150400,150434,150484,150501,150534,150567,150584,150601,150717,150734,150767,150784,150801,150817,150834,150851,150868,150884,150901,150934,150951,150984,151001,151018,151051,151068,151084,151101,151118,151134,151168,151251,151285,151301,151401,151418,151435,151451,151502,151518,151585,151602,151652,151685,151802,151818,151852,151935,152002,152019,152052,152069,152102,152119,152135,152152,152169,152186,152219,152236,152252,152269,152286,152336,152836,152837,157725,158225,158242,158258,158292,158325,158392,158408,158442,158458,158475,158509,158525,158542,158575,158592,158675,158742,158842,158859,158892,158909,158926,158942,158976,158992,159026,159042,159059,159076,159109,159193,159226,159309,159326,159376,159393,159426,159443,159493,159526,159643,159660,159693,159710,159726,159743,159843,159860,159877,159893,159927,159943,159977,160010,160060,160077,160093,160110,160127,160160,160194,160260,160277,160294,160310,160327,160344,160360,160394,160410,160427,160460,160477,160494,160527,161245,161261,161278,161311,161328,161345,161361,161395,161411,161445,161461,161478,161495,161512,161545,161628,161645,161662,161678,161712,161728,161745,161762,161778,161795,161812,161845,161862,161912,161929,161962,161979,161995,162012,162045,162095,162129,162145,162162,162212,162246,162296,162362,162429,162496,162513,162546,162596,162713,162729,162763,162829,162863,162896,162930,162946,162963,162980,162996,163030,163046,163063,163080,163096,163113,163146,163163,163180,163197,163213,163247,163747,163748,168619,169119,169269,169386,169403,169736,169770,169903,169970,169987,170037,170137,170237,170270,170354,170404,170420,170454,170470,170521,170771,170804,170921,170988,171004,171054,171154,171171,171205,171255,171288,171305,171405,171438,172155,172256,172356,172372,172406,172422,172523,172606,172623,172639,172656,172789,172823,172856,172873,173006,173023,173056,173073,173106,173207,173240,173273,173473,173507,173757,173774,173824,173841,173924,174057,174074,174124,174157,174657,174658}
const int16 angles[] = {-1,96,96,102,108,110,116,126,128,133,135,144,152,180,164,161,154,148,142,134,126,120,116,114,111,108,98,97,94,92,95,100,106,112,117,122,127,132,139,146,150,162,180,172,168,164,159,154,149,146,140,134,130,88,92,96,99,122,135,136,144,149,150,154,180,172,170,164,162,150,137,132,126,122,114,110,104,97,88,92,98,110,112,116,126,136,142,146,180,164,164,147,144,142,136,135,128,125,110,106,104,100,94,90,90,96,100,106,110,120,122,127,132,136,138,144,148,154,160,160,-1,90,90,84,78,76,70,64,60,57,52,48,43,41,35,31,25,10,2,2,4,8,14,18,18,22,26,31,35,37,42,46,50,53,57,64,72,73,77,78,82,86,90,90,72,66,60,56,51,49,44,42,34,32,26,4,8,14,18,24,26,35,50,57,64,68,75,82,90,86,78,76,72,72,68,66,58,52,50,41,34,30,24,23,20,2,18,20,26,30,38,44,48,56,60,66,70,77,83,88,88,82,78,74,68,62,60,56,51,46,44,38,36,32,30,26,20,0,5,9,26,30,31,34,38,44,56,63,64,68,70,83,87,87,80,74,72,67,62,57,54,50,46,33,31,26,19,19,-1,180,180,176,173,156,151,143,134,122,118,110,106,100,97,94,94,100,106,112,118,122,137,139,145,147,178,178,173,154,143,139,138,134,132,129,126,122,121,118,102,98,96,93,90,97,100,106,136,138,144,148,154,161,179,174,170,168,164,162,158,156,150,146,139,134,129,127,112,98,110,134,136,142,144,148,154,160,179,172,158,156,147,143,130,126,118,114,108,101,90,95,98,104,108,114,116,122,124,128,133,137,139,146,150,156,172,180,176,166,158,156,148,144,139,132,127,126,122,118,113,107,104,90,92,98,104,110,112,118,120,124,126,130,132,137,139,147,149,155,162,162,-1,2,2,6,10,20,22,26,30,34,41,48,55,66,69,72,88,90,76,72,66,64,58,54,49,44,38,36,32,26,0,2,14,22,24,30,31,34,36,42,45,49,52,56,59,62,72,78,80,83,86,92,84,78,72,67,58,54,51,46,42,35,31,0,8,14,20,22,30,35,50,58,66,73,80,84,90,87,81,76,70,67,62,60,55,53,49,44,38,36,32,30,24,2,6,18,22,31,40,44,52,60,68,71,78,86,90,84,78,74,70,65,62,58,56,52,43,40,34,32,27,24,9,0,1,4,6,12,24,33,34,44,48,52,54,58,60,68,76,79,88,90,88,82,79,74,68,62,58,46,42,35,31,25,18,18,-1,180,180,178,172,170,166,164,160,158,152,150,142,135,130,123,120,126,132,138,145,148,180,176,172,170,166,164,160,154,150,148,134,132,125,117,120,126,131,137,139,154,180,176,168,164,160,158,152,147,138,135,130,128,118,120,126,130,135,138,144,147,156,156,2,2,4,12,16,20,28,48,56,60,66,70,76,79,90,84,78,76,70,68,59,46,44,38,36,32,30,25,13,0,12,16,26,30,38,42,50,54,61,64,77,80,92,88,86,82,80,78,76,74,72,70,68,66,44,43,38,30,26,24,10,4,8,14,18,22,30,34,44,52,58,62,70,74,80,83,83,-1,180,180,168,166,162,162,158,156,151,148,134,122,118,122,128,131,136,139,146,148,170,180,176,164,158,150,148,134,122,119,125,128,134,139,146,149,178,178,176,170,168,164,154,149,146,139,134,127,125,118,121,128,133,144,146,156,156,91,91,87,81,78,72,67,62,60,54,50,45,41,35,33,27,4,8,14,16,25,33,38,48,56,63,66,74,80,90,84,78,72,70,64,60,52,50,45,43,36,32,27,10,2,4,8,10,23,26,30,37,44,65,78,82,84,90,85,80,74,70,66,60,55,50,46,44,38,33,22,22,180,180,156,154,152,144,140,136,132,122,120,122,128,138,143,148,149,154,159,161,165,177,180,174,170,154,152,142,138,119,125,126,130,133,140,145,146,162,177,180,168,166,162,155,150,144,138,128,126,126,0,0,6,12,14,20,24,31,35,50,54,62,68,75,79,90,88,82,80,74,68,64,61,56,51,47,45,38,34,26,8,0,8,11,16,20,26,34,44,48,56,64,71,74,81,90,70,66,64,60,51,40,36,29,24,22,18,17,1,4,14,26,34,40,50,56,64,72,79,82,82,178,178,179,173,154,130,122,118,139,143,152,170,180,150,143,140,132,130,118,139,143,152,152,171,178,156,154,142,142,137,126,126,2,2,24,35,49,86,86,90,76,60,60,42,36,36,30,13,0,24,36,36,46,79,90,70,70,44,42,38,30,5,2,28,34,42,79,83,83,-1,92,92,98,104,108,113,118,130,143,148,150,156,170,178,177,173,154,148,146,140,138,134,133,129,126,122,121,118,110,106,103,100,94,93,96,102,108,112,118,123,126,130,135,148,152,158,180,176,174,170,168,164,162,158,152,148,138,133,125,90,96,98,104,104,110,110,116,116,120,120,124,130,139,143,152,154,156,167,177,179,172,168,164,160,154,150,140,132,124,120,112,106,99,96,90,97,102,106,111,116,121,124,131,133,137,139,146,150,156,159,171,178,177,173,151,143,136,118,114,96,96,90,100,102,106,121,123,127,129,134,136,142,146,154,163,163,-1,90,90,85,82,76,70,66,64,58,54,49,47,34,30,24,0,4,8,10,14,14,18,24,28,32,36,38,43,47,50,54,58,67,70,74,80,81,86,87,84,78,72,67,62,49,45,36,34,1,4,12,14,20,22,30,34,46,54,61,68,75,79,86,88,74,68,62,62,58,58,54,44,41,35,31,27,24,20,18,14,2,8,16,22,26,34,38,44,52,56,63,70,77,85,90,84,78,72,70,65,62,58,53,34,30,24,2,4,8,8,16,18,26,30,37,44,60,64,66,79,88,90,83,78,72,66,64,59,57,52,48,43,41,35,33,22,22,-1,178,178,176,172,168,164,156,152,148,144,143,136,134,130,127,124,113,103,90,96,102,108,110,116,120,125,130,134,137,143,147,170,180,168,168,160,158,154,150,143,136,120,117,114,110,109,106,92,90,92,98,104,110,116,123,133,135,142,144,148,154,163,179,177,172,170,166,164,160,154,150,148,139,136,132,128,95,98,104,110,115,118,122,127,132,138,142,144,148,150,161,176,172,166,162,154,146,140,136,128,124,116,109,102,90,96,102,108,110,116,120,132,137,143,145,156,167,180,170,162,154,149,146,136,120,116,113,104,99,94,90,93,100,102,108,112,118,120,124,127,132,138,144,148,150,156,163,163,-1,0,0,20,36,41,88,86,56,43,38,30,0,14,20,30,37,42,46,52,56,90,81,55,42,37,28,0,4,13,24,36,44,76,85,82,61,43,38,32,25,2,22,32,36,44,83,90,82,74,48,46,38,35,24,1,5,10,37,46,78,82,88,88,70,44,41,26,19,19,-1}
int maxIdx = 1521;
int bpm=88;
int ribbon_offset=0;

//deadzone for autoswirl set negative to disable
int deadzone=5;
int ms=0;
int ms_ribbon=0;
int running=0;

int idx=0;
int curAngle=-1;

int next_beat=0;
int beat_anticipate=0;
int autoswirl=0;

init {
	beat_anticipate=60000/(bpm*4);
}

main {
	ms+=get_rtime();
	if (get_val(XB1_VIEW)>0 && event_press(XB1_A)) {
		ms=0;
		idx=0;
		next_beat=0;
		cls_oled(0);
		running=1;
		putc_oled(1,82);
		putc_oled(2,117);
		putc_oled(3,110);
		puts_oled(40,20,2,3,1);
	}
	if (event_press(XB1_B)) {
		ms=0;
		idx=0;
		next_beat=0;
		cls_oled(0);
		running=0;
		putc_oled(1,83);
		putc_oled(2,116);
		putc_oled(3,111);
		putc_oled(4,112);
		puts_oled(30,20,2,4,1);
	}
	if (event_press(XB1_RB)) {ribbon_offset = ribbon_offset + 25;set_val(TRACE_1,ribbon_offset);}
	if (event_press(XB1_LB)) {ribbon_offset = ribbon_offset - 25;set_val(TRACE_1,ribbon_offset);}
	
	if (running) {
		set_val(TRACE_2,ms);
		ms_ribbon = ms + ribbon_offset;
		//advance until we reach the end or catch up with the time code
		while (idx<maxIdx && ms_ribbon>times[idx + 1]) {
			idx++;
		}
		//if we've reached the end of the ribbon, releast LS
		if (idx>=maxIdx || angles[idx]== -1) {
			curAngle=-1;
		} else {
			curAngle=angles[idx]+(angles[idx + 1]-angles[idx])*(ms_ribbon-times[idx])/(times[idx + 1]-times[idx]);
		}
		//set LS position if ribbon present
		if (curAngle>=0) set_polar(POLAR_LS,curAngle,32767);

		//shoot if we are on the beat
		if ((ms+beat_anticipate)>((next_beat*2*60000)/bpm)) {
			next_beat+=1;
			combo_run(fire);
		}

		//swirl reticle if idle
		if (event_press(XB1_X)) {if (autoswirl==0) {autoswirl=1} else {autoswirl=0}}
		if (autoswirl==1 && get_val(XB1_RX)<=deadzone && get_val(XB1_RY)<=deadzone && get_val(XB1_RX)>=-deadzone && get_val(XB1_RY)>=-deadzone) {set_polar(POLAR_RS,ms%360,32767);}
	}
}

combo fire {
	set_val(XB1_RT,100);wait(50);
}
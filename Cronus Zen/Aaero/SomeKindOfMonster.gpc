const int32 times[] = {0,32566,33066,33083,33100,33116,33150,33166,33183,33200,33233,33250,33267,33300,33350,33367,33400,33450,33500,33517,33534,33540,33541,33550,33567,33600,33617,33634,33650,33684,33700,33750,33784,33800,33834,34685,35853,35869,35886,35903,35919,35936,35953,35969,35986,36019,36036,36053,36086,36103,36119,36203,36236,36253,36270,36286,36303,36320,36336,36353,36370,36386,36403,36420,36453,36486,36520,36537,36553,36570,36583,36584,36603,36637,36653,36687,36703,36720,36737,36753,36770,36803,36820,36837,36854,36870,37070,37087,37171,37187,37204,37221,37237,37254,37287,37304,37321,37337,37354,37421,37437,37454,37471,37487,37521,37604,37638,37654,37671,37688,37704,37754,37771,37788,37804,37821,37838,37871,37921,37971,39706,39957,39973,39990,40007,40040,40090,40107,40174,40190,40207,40209,40210,40257,40274,40307,40357,40374,40390,40407,40424,40457,40474,40490,41275,41291,41308,41325,41341,41358,41375,41391,41408,41425,41441,41458,41475,41508,41525,41542,41558,41575,41608,41625,41658,41675,41708,41725,41753,41754,41758,41792,41808,41825,41859,41892,41909,41942,41959,41975,42009,42025,42059,42576,43844,44061,44077,44094,44127,44144,44161,44178,44244,44261,44294,44311,44344,44361,44378,44411,44428,44444,44461,44478,44511,44528,44545,44561,44578,44595,44611,44628,44645,44661,44678,44695,44711,44728,44745,44761,44790,44791,44795,44811,44828,44845,44862,44878,44895,44912,44928,44945,44962,44995,45012,45028,45045,45062,45078,45262,45279,45362,45379,45412,45429,45495,45512,45562,45596,45612,45646,45662,45712,45729,45779,45796,45812,45829,45846,45863,45879,45913,45946,45963,45979,45996,46029,46046,46079,46096,46129,47130,47630,47631,48966,49466,49499,49516,49550,49566,49583,49600,49633,49650,49683,49700,49766,49783,49800,49816,49833,49850,49900,49917,49947,49948,49983,50000,50100,50117,50150,50167,50184,50200,50217,50234,50267,50817,51335,52002,52269,52302,52319,52352,52369,52402,52419,52452,52469,52486,52503,52536,52553,52586,52619,52653,52669,52686,52703,52736,52753,52786,52803,52819,52836,52870,52886,52920,52936,52953,52986,52990,52991,53003,53020,53036,53053,53070,53086,53120,53136,53170,53187,53220,53237,53253,53270,53287,53470,53487,53570,53604,53620,53654,53704,53737,53770,53854,53904,53921,53937,53954,54004,54021,54054,54104,54121,54137,54154,54204,54238,54254,54288,54304,54321,54338,54354,55372,56390,56406,56423,56456,56490,56507,56523,56557,56573,56607,56621,56622,56640,56673,56690,56740,56757,56773,56790,56807,56840,56857,56890,57674,57691,57708,57741,57791,57824,57875,57908,57925,57958,57975,58025,58041,58108,58125,58141,58152,58153,58158,58175,58192,58258,58275,58292,58308,58342,58358,58392,58408,58425,58442,58475,59393,59409,59459,60327,60477,60527,60544,60561,60577,60611,60627,60661,60677,60711,60744,60777,60794,60827,60844,60878,60894,60928,60944,60978,60994,61011,61028,61061,61078,61111,61128,61144,61161,61178,61195,61199,61200,61211,61228,61245,61261,61295,61311,61345,61361,61395,61411,61445,61461,61495,61995,61996,62046,62546,62546,63046,63047,63080,63580,63580,64080,64081,65149,65649,65682,65699,65732,65749,65766,65782,65799,65816,65832,65866,65883,65899,65916,65949,65966,65983,65999,66033,66049,66066,66099,66116,66164,66165,66166,66834,66867,66884,66900,66934,66984,67000,67017,67034,67050,67084,67100,67134,67150,67167,67184,67217,67234,67267,67284,67301,67317,67351,67367,67401,67417,67467,67484,67518,67534,67584,67601,67634,67651,67701,68886,68952,69086,69253,69753,69770,69786,69803,69820,69837,69853,69870,69887,69920,69953,69987,70003,70020,70037,70053,70070,70087,70103,70137,70187,70204,70220,70720,70721,71272,71772,72439,72456,72773,73273,73274,73374,73874,73907,73924,73957,73974,74007,74024,74041,74057,74091,74107,74124,74141,74174,74191,74224,74241,74258,74274,74291,74308,74374,74474,74491,74641,74658,74691,74758,74775,74842,74858,74875,74892,74942,74958,75008,75025,75075,75092,75108,75125,75175,75192,75275,75292,75309,75325,75359,75375,75409,75425,75442,75475,75492,75526,75542,75576,75592,75626,75642,75659,75676,75709,75726,75759,75792,75809,75826,75909,77127,77131,77132,77244,77311,77344,77461,77845,77861,77878,77895,77911,77928,77945,77961,78411,78428,78478,78495,78511,78528,78561,78578,79078,79079,79480,79980,79980,80480,80481,81565,82065,82115,82165,82182,82198,82215,82249,82265,82282,82299,82332,82349,82365,82382,82415,82432,82465,82482,82563,82564,82565,83233,83300,83316,83333,83350,83366,83416,83433,83450,83466,83483,83500,83533,83550,83566,83583,83617,83633,83650,83667,83700,83717,83733,83750,83767,83800,83850,83867,83900,83917,83950,84000,84017,84117,85335,85468,85502,85652,85719,86119,86136,86169,86186,86202,86219,86236,86253,86269,86286,86303,86336,86353,86369,86386,86403,86419,86436,86453,86469,86486,86553,86620,86636,87136,87137,87688,88188,88188,88688,88689,88705,89205,89205,89705,89706,89757,90257,90262,90263,90290,90307,90340,90373,90390,90407,90423,90440,90473,90490,90507,90523,90557,90574,90590,90607,90674,90707,90724,90740,90774,90890,90907,91024,91107,91141,91191,91207,91224,91241,91274,91358,91391,91458,91524,91541,91558,91575,91608,91625,91658,91675,91708,91725,91741,91775,91808,91825,91858,91875,91925,91942,91975,91992,92042,92092,92125,92142,92175,92192,92225,92242,92275,92309,92926,92927,93543,93610,93727,93760,93860,94327,94827,94828,131031,131531,131564,131598,131615,131631,131698,131715,131748,131765,131798,131815,131881,131898,131915,131932,131948,131965,131982,131996,131997,131998,132015,132032,132065,132115,132132,132148,132165,132182,132198,132215,132232,132282,133383,134301,134334,134367,134384,134401,134417,134451,134501,134517,134534,134551,134584,134601,134634,134651,134668,134684,134718,134734,134751,134768,134784,134801,134818,134834,134868,134884,134901,134918,134935,134951,134968,134985,135001,135018,135035,135038,135039,135051,135085,135101,135118,135135,135151,135168,135185,135218,135235,135268,135285,135302,135318,135335,135518,135535,135619,135652,135669,135685,135702,135735,135752,135885,135902,135936,135952,135969,135986,136002,136019,136036,136069,136102,136136,136152,136169,136202,136219,136253,136269,136286,136319,136403,138421,138471,138488,138505,138555,138572,138605,138638,138655,138665,138666,138705,138738,138755,138772,138805,138822,138838,138872,138888,138905,138922,138939,139739,139756,139773,139906,139923,139940,139956,140023,140040,140056,140073,140090,140106,140156,140173,140190,140201,140202,140206,140223,140240,140257,140273,140290,140307,140323,140340,140373,140390,140423,140440,140490,140540,142409,142542,142559,142576,142592,142609,142626,142659,142676,142709,142742,142759,142792,142809,142859,142892,142909,142926,142943,142959,142976,142993,143009,143043,143093,143109,143159,143176,143209,143226,143243,143252,143253,143260,143276,143293,143326,143343,143360,143376,143410,143426,143443,143460,143476,143510,143526,143727,143743,143827,143860,143877,143893,143910,143927,143944,143960,144010,144044,144060,144094,144110,144160,144177,144194,144227,144244,144277,144294,144311,144327,144361,144377,144394,144411,144461,144477,144494,144511,144527,144544,144578,144594,145528,145579,146079,146080,147431,147931,147964,147981,147998,148014,148031,148064,148081,148098,148114,148148,148164,148231,148265,148281,148298,148315,148365,148381,148398,148404,148405,148415,148431,148465,148481,148548,148565,148582,148615,148648,148665,148698,149449,149633,149666,149699,150717,150734,150800,150817,150834,150850,150901,150934,150951,150967,150984,151017,151034,151067,151084,151101,151117,151134,151151,151167,151201,151217,151234,151251,151284,151301,151318,151334,151368,151384,151401,151418,151451,151453,151454,151468,151484,151501,151518,151534,151551,151568,151601,151618,151635,151651,151685,151701,151751,151935,151952,152035,152068,152085,152102,152118,152152,152168,152202,152218,152235,152252,152319,152335,152352,152452,152502,152519,152535,152552,152569,152586,152602,152636,152652,152669,152702,152719,152736,152802,154187,154821,154871,154888,154905,154921,154938,155005,155038,155071,155079,155080,155088,155121,155138,155171,155221,155238,155255,155288,155305,155338,155355,156139,156156,156172,156189,156222,156239,156256,156273,156306,156323,156339,156356,156423,156439,156473,156489,156506,156523,156539,156556,156573,156590,156606,156612,156613,156623,156640,156706,156723,156773,156790,156823,156856,156873,156907,157757,158892,158959,158975,159009,159059,159092,159109,159142,159175,159209,159225,159259,159292,159309,159326,159342,159359,159376,159409,159426,159459,159476,159492,159509,159542,159559,159576,159593,159609,159626,159656,159657,159659,159676,159693,159709,159726,159743,159776,159793,159826,159843,159859,159876,159910,159926,159943,159960,160460,160461,160511,161011,161678,161695,162012,162512,162513,163597,164097,164114,164147,164180,164197,164214,164230,164247,164264,164281,164314,164331,164347,164364,164381,164397,164431,164447,164464,164481,164514,164531,164547,164564,164581,164608,164609,164614,164648,165315,165332,165348,165365,165382,165398,165415,165432,165448,165465,165482,165515,165532,165565,165582,165599,165615,165649,165665,165699,165715,165732,165749,165782,165815,165832,165849,165865,165882,165916,165932,165966,165982,166016,166032,166066,166099,166116,166149,166182,167384,167517,167717,168218,168235,168251,168268,168285,168301,168318,168335,168351,168368,168385,168401,168418,168451,168468,168501,168518,168535,168551,168568,168585,168602,168618,168635,168668,168685,169185,169186,169737,170237,170237,170737,170738,170754,171254,171254,171754,171755,171839,172339,172372,172389,172422,172439,172472,172489,172505,172522,172555,172572,172589,172606,172639,172656,172672,172689,172706,172722,172739,172756,172772,172789,172822,172906,172956,173123,173139,173156,173223,173290,173356,173373,173406,173440,173573,173607,173623,173640,173723,173740,173773,173807,173823,173840,173857,173873,173890,173907,173924,173940,173957,173974,173990,174007,174040,174057,174074,174090,174124,174140,174174,174190,174207,174241,174257,174291,174324,174357,174957,174958,175558,175625,175692,175725,175759,175926,176393,176426,176443,176459,176476,176493,176509,176526,176559,176576,176593,176610,176626,176643,176676,176693,176710,176726,176743,176760,176776,176793,176810,176843,176860,176876,177376,177377,177928,178428,178428,178928,178929,180013,180513,180530,180563,180580,180597,180614,180630,180647,180664,180697,180714,180730,180747,180780,180797,180814,180830,180864,180880,180947,180964,180981,181029,181030,181031,181373,181374,181715,181731,181734,181735,181748,181815,181848,181865,181881,181898,181932,181948,181965,181982,182015,182032,182065,182082,182098,182115,182148,182198,182232,182249,182265,182282,182315,182382,182399,182415,182449,182482,182499,182565,183733,183800,183934,183967,184117,184618,184634,184651,184668,184684,184701,184718,184734,184751,184768,184784,184801,184818,184834,184868,184884,184901,184918,184935,184951,184968,184985,185001,185018,185035,185051,185085,185585,185586,186136,186636,186636,187136,187137,187154,187654,187654,188154,188155,188222,188722,188738,188772,188805,188822,188855,188872,188888,188905,188939,188955,188972,188989,189022,189039,189055,189072,189105,189139,189155,189172,189189,189239,189339,189372,189406,189472,189506,189589,189606,189689,189706,189723,189739,189756,189789,189806,189823,189856,189873,189940,189956,189973,189990,190023,190040,190090,190106,190140,190156,190190,190223,190240,190257,190290,190357,190373,190423,190457,190473,190490,190523,190540,190574,190590,190624,190657,190674,190690,190724,190774,191992,191997,191998,192125,192192,192225,192325,192792,193292,193293}
const int16 angles[] = {-1,270,270,274,276,282,286,290,292,298,302,306,308,316,322,326,331,342,351,356,358,359,0,2,5,12,15,20,22,30,32,47,52,56,61,86,118,118,122,127,130,134,137,144,146,154,161,164,176,178,185,204,213,220,226,234,238,248,252,259,262,270,273,284,296,315,322,330,344,350,359,0,14,33,50,65,80,86,98,103,114,122,132,136,147,150,150,268,268,266,262,259,254,252,246,244,240,238,233,220,220,218,214,212,203,188,180,178,172,170,166,158,152,150,146,143,136,132,118,118,68,62,63,60,54,48,32,30,11,8,0,0,359,348,342,336,320,316,306,301,292,284,276,273,272,274,278,280,286,288,292,294,298,300,304,306,310,315,320,320,322,326,330,336,341,346,350,356,359,0,0,10,12,16,22,30,33,43,45,50,56,62,62,76,112,118,118,124,130,135,138,144,159,166,176,182,189,194,196,206,210,218,222,229,238,246,252,259,262,270,274,284,290,301,306,315,318,326,330,344,359,0,2,16,26,34,52,60,74,81,93,99,108,118,128,132,143,147,156,156,270,270,268,262,260,246,244,232,228,224,221,216,208,203,194,192,187,184,180,178,172,166,160,156,154,148,143,136,131,126,120,90,90,-1,270,270,274,280,284,288,290,296,300,304,308,314,322,328,329,334,336,341,349,354,359,0,6,11,30,35,42,48,50,55,57,63,62,78,92,112,118,123,128,136,142,147,154,160,167,171,178,185,192,197,207,214,222,228,237,246,254,262,270,275,287,298,308,318,326,331,358,359,0,4,16,22,41,50,66,81,93,104,116,125,135,139,146,156,156,270,270,266,260,256,244,240,233,219,211,206,204,199,190,186,180,168,166,162,160,147,142,135,130,125,123,116,118,90,60,58,52,46,36,33,27,20,12,4,0,359,354,346,340,330,322,320,314,304,294,286,277,270,272,276,282,292,298,308,313,318,320,324,333,338,349,354,356,359,0,1,4,9,20,25,27,33,38,45,50,55,58,62,62,88,91,90,114,118,127,132,135,142,147,154,161,168,176,187,194,200,206,213,221,231,240,250,258,265,270,281,292,303,313,322,326,334,345,358,359,0,4,18,24,43,60,76,89,102,112,123,132,143,154,154,-1,270,270,270,270,-1,356,356,356,356,-1,183,183,192,198,206,212,221,226,238,243,254,262,271,276,283,292,298,302,310,317,322,326,338,347,359,0,0,1,2,5,11,17,30,32,38,42,48,53,58,64,70,72,78,83,88,94,98,100,106,110,115,120,124,133,135,143,145,156,160,165,170,180,181,184,194,209,209,212,220,223,232,237,244,249,257,264,278,284,290,294,300,304,310,312,318,322,338,345,346,346,-1,270,270,270,356,356,356,-1,351,351,344,336,328,318,304,294,288,279,270,262,258,250,242,235,228,220,218,212,208,198,182,193,194,210,213,216,224,226,236,238,241,242,248,252,256,260,264,268,269,268,254,244,222,216,212,207,192,188,172,168,158,148,135,125,115,105,96,88,80,76,68,60,54,48,36,33,26,0,0,0,359,348,344,340,331,330,328,313,308,296,291,283,279,258,254,234,232,222,218,206,195,195,-1,356,356,356,356,-1,186,186,199,213,222,230,241,252,261,266,274,282,290,294,301,308,316,324,328,359,0,0,0,6,12,14,20,22,36,40,43,49,52,57,62,68,70,76,80,86,88,94,98,104,106,110,112,119,128,132,136,142,146,156,162,180,181,194,195,208,209,209,213,210,214,222,227,236,240,248,252,260,267,274,277,284,286,292,296,302,306,312,324,347,350,350,-1,356,356,356,356,-1,356,356,356,356,-1,1,1,0,359,352,344,336,323,318,305,300,290,280,271,267,259,252,244,240,232,216,205,196,193,180,194,194,208,216,222,226,230,232,235,238,250,254,264,270,262,258,250,244,236,228,222,215,207,202,189,180,170,160,150,130,120,109,100,85,66,59,52,46,37,31,23,14,0,0,359,359,352,344,340,331,331,331,-1,272,272,277,276,286,290,302,306,312,316,319,324,335,340,342,347,348,354,356,359,0,0,2,8,14,25,27,32,35,42,44,48,50,61,92,118,120,127,132,135,142,147,160,167,170,178,184,190,196,203,206,212,222,229,234,243,248,256,259,266,274,285,292,302,306,316,318,327,332,346,358,359,0,6,26,34,53,62,76,83,94,106,116,125,134,139,149,154,154,270,270,266,260,258,254,250,245,220,220,212,210,206,204,198,196,192,187,181,173,170,166,160,156,150,144,142,133,118,62,54,48,46,31,29,18,8,2,0,359,350,343,336,334,322,320,310,300,292,288,280,277,273,276,280,304,308,310,314,324,328,329,334,336,341,350,354,356,359,0,1,4,8,11,16,18,22,24,30,35,42,47,52,60,62,116,120,122,128,131,136,139,149,152,163,170,178,186,191,202,212,220,222,232,236,244,248,256,263,283,294,311,320,330,345,352,359,0,6,12,26,48,64,72,87,99,110,115,124,129,144,148,148,270,270,264,258,256,252,250,246,244,234,230,226,221,217,210,205,203,194,193,184,182,178,176,166,164,160,158,146,144,138,136,132,129,122,118,92,91,91,-1,270,270,276,279,284,286,290,294,300,302,306,310,315,324,330,335,337,342,350,355,358,359,0,2,4,12,14,29,34,36,46,50,56,62,82,87,91,90,118,118,134,136,143,145,159,168,175,178,184,190,196,203,210,212,222,224,229,239,248,256,260,268,278,290,294,305,315,322,328,340,358,359,0,10,18,30,41,58,66,80,92,104,110,119,128,137,158,158,269,269,264,260,257,252,248,244,240,234,232,228,218,214,212,192,183,178,176,170,168,164,162,155,150,147,138,136,131,120,80,62,55,52,47,44,37,22,11,3,0,359,356,350,344,337,322,318,308,298,290,281,273,270,274,276,282,286,290,292,298,302,306,308,312,322,326,330,335,338,342,344,348,350,356,358,359,0,2,5,20,22,34,37,46,51,56,62,86,118,120,126,132,147,154,160,168,180,186,194,200,210,212,218,226,231,240,250,257,265,274,280,292,302,312,316,324,329,343,359,0,1,14,20,34,45,62,76,89,102,112,118,127,136,146,150,156,156,-1,270,270,270,356,356,356,-1,180,180,183,194,202,210,214,221,232,238,248,258,267,271,280,283,290,298,306,308,316,322,328,332,341,346,359,0,2,0,1,2,8,10,16,18,22,25,31,34,42,47,52,58,63,66,72,77,82,88,92,96,100,106,112,114,119,122,126,130,134,138,145,149,154,159,168,170,182,180,181,192,209,210,214,220,226,234,239,248,251,258,262,270,274,280,286,292,300,306,308,314,318,318,326,328,335,346,348,348,-1,270,270,270,270,-1,356,356,356,356,-1,349,349,342,334,326,314,302,292,286,277,268,260,256,248,240,234,230,222,221,218,210,206,197,194,180,190,194,213,214,218,224,234,242,246,249,254,270,262,257,248,226,219,211,196,192,182,178,172,162,158,148,143,136,126,121,112,102,94,90,82,74,66,60,53,50,38,35,24,15,0,0,359,359,356,350,346,345,331,330,329,326,316,312,304,300,292,283,276,272,265,262,256,250,242,240,234,230,224,222,220,214,204,197,194,194,-1,356,356,356,356,-1,180,180,186,196,202,204,210,219,224,236,248,257,262,270,278,286,290,298,306,312,330,337,340,359,0,0,0,359,359,358,359,0,5,20,27,32,35,42,48,54,56,62,67,72,78,83,86,91,96,108,112,118,120,124,128,143,145,149,154,162,164,180,180,182,194,196,209,209,212,220,223,232,237,245,249,256,260,266,270,276,279,292,294,300,302,308,312,318,318,324,326,332,340,348,348,-1,356,356,356,356,-1,356,356,356,356,-1,358,358,354,343,336,327,316,303,298,288,278,269,265,257,250,242,238,230,224,214,207,203,194,180,192,194,199,206,210,220,220,233,234,238,240,243,246,249,250,255,256,265,266,270,268,259,250,238,230,222,220,208,195,191,180,170,144,130,115,99,94,86,78,70,62,55,48,37,34,26,18,0,0,0,359,348,343,340,331,332,332,-1}
int maxIdx = 1782;
int bpm=117;
int ribbon_offset=0;

//deadzone for autoswirl set negative to disable
int deadzone=5;
int ms=0;
int ms_ribbon=0;
int running=0;

int idx=0;
int curAngle=-1;

int next_beat=0;
int beat_anticipate=0;
int autoswirl=0;

init {
	beat_anticipate=60000/(bpm*4);
}

main {
	ms+=get_rtime();
	if (get_val(XB1_VIEW)>0 && event_press(XB1_A)) {
		ms=0;
		idx=0;
		next_beat=0;
		cls_oled(0);
		running=1;
		putc_oled(1,82);
		putc_oled(2,117);
		putc_oled(3,110);
		puts_oled(40,20,2,3,1);
	}
	if (event_press(XB1_B)) {
		ms=0;
		idx=0;
		next_beat=0;
		cls_oled(0);
		running=0;
		putc_oled(1,83);
		putc_oled(2,116);
		putc_oled(3,111);
		putc_oled(4,112);
		puts_oled(30,20,2,4,1);
	}
	if (event_press(XB1_RB)) {ribbon_offset = ribbon_offset + 25;set_val(TRACE_1,ribbon_offset);}
	if (event_press(XB1_LB)) {ribbon_offset = ribbon_offset - 25;set_val(TRACE_1,ribbon_offset);}
	
	if (running) {
		set_val(TRACE_2,ms);
		ms_ribbon = ms + ribbon_offset;
		//advance until we reach the end or catch up with the time code
		while (idx<maxIdx && ms_ribbon>times[idx + 1]) {
			idx++;
		}
		//if we've reached the end of the ribbon, releast LS
		if (idx>=maxIdx || angles[idx]== -1) {
			curAngle=-1;
		} else {
			curAngle=angles[idx]+(angles[idx + 1]-angles[idx])*(ms_ribbon-times[idx])/(times[idx + 1]-times[idx]);
		}
		//set LS position if ribbon present
		if (curAngle>=0) set_polar(POLAR_LS,curAngle,32767);

		//shoot if we are on the beat
		if ((ms+beat_anticipate)>((next_beat*2*60000)/bpm)) {
			next_beat+=1;
			combo_run(fire);
		}

		//swirl reticle if idle
		if (event_press(XB1_X)) {if (autoswirl==0) {autoswirl=1} else {autoswirl=0}}
		if (autoswirl==1 && get_val(XB1_RX)<=deadzone && get_val(XB1_RY)<=deadzone && get_val(XB1_RX)>=-deadzone && get_val(XB1_RY)>=-deadzone) {set_polar(POLAR_RS,ms%360,32767);}
	}
}

combo fire {
	set_val(XB1_RT,100);wait(50);
}
const int32 times[] = {0,38356,38856,38889,38906,38922,38939,38956,39006,39039,39072,39122,39139,39156,39223,39239,39256,39306,39323,39339,39373,39389,39439,39456,39489,39506,39523,39540,39556,39561,39562,39573,39590,39623,39640,39690,39706,39756,39773,39806,39823,40224,40290,40324,40657,40724,40774,40824,40858,40891,40908,40974,41008,41074,41141,41158,41208,41225,41241,41258,41275,41325,41341,41375,41391,41408,41425,41441,41458,41459,41460,41475,41491,41525,41542,41558,41608,41625,41658,41675,41725,41758,42176,42693,42709,42726,42759,42776,42809,42826,42876,42910,42960,42993,43043,43060,43093,43110,43143,43160,43177,43193,43210,43243,43260,43293,43310,43327,43343,43360,43402,43403,43427,43443,43477,43493,43527,43544,43577,43594,43627,43644,44044,44077,44161,44528,44561,44578,44611,44862,44895,44912,44945,44978,44995,45028,45045,45112,45512,45529,45562,45579,45946,45963,45979,46530,46580,46597,46613,46630,46647,46663,46730,46763,46847,46880,46897,46930,46947,46997,47030,47047,47064,47114,47130,47164,47197,47231,47245,47246,47247,47264,47281,47297,47314,47331,47347,47364,47414,47431,47464,47481,47514,47898,47931,47948,47998,48348,48398,48415,48448,48482,48498,48515,48532,48549,48615,48665,48682,48715,48732,48765,48782,48815,48832,48849,48866,48899,48916,48932,48949,48982,48999,49016,49032,49066,49116,49131,49132,49132,49149,49166,49183,49199,49216,49233,49266,49283,49299,49316,49349,49366,49383,49433,49883,50384,50400,50434,50467,50484,50501,50567,50584,50651,50667,50717,50734,50751,50784,50801,50834,50851,50884,50901,50934,50951,50984,51001,51018,51051,51068,51080,51081,51084,51101,51118,51134,51151,51185,51201,51235,51251,51301,51335,51702,51735,51785,51835,52202,52236,52252,52269,52302,52536,52569,52619,52636,52719,52736,52786,52803,53153,53203,53253,54037,54221,54238,54288,54304,54338,54371,54421,54471,54505,54555,54588,54605,54638,54655,54671,54688,54705,54721,54738,54788,54805,54821,54838,54855,54897,54898,54905,54922,54938,54955,54972,54988,55038,55055,55105,55122,55138,55189,57057,57107,57124,57140,57174,57624,58058,58091,58108,58175,58225,58242,58292,58392,58408,58425,58475,58492,58509,58525,58542,58559,58575,58625,58642,58659,58692,58709,58725,58736,58737,58742,58775,58809,58825,58842,58892,58909,58959,58976,59042,60894,60961,61011,61078,61128,61161,61178,61228,61245,61295,61311,61328,61345,61361,61378,61379,61380,61395,61445,61745,61762,61895,61912,61962,61979,62045,62162,62229,62262,62296,62346,62362,62379,62446,62462,62479,62529,62546,62579,62583,62584,62596,62613,62629,62663,62679,62696,62746,62763,62880,64748,64798,64815,64831,65299,65732,65799,65816,65883,65933,65983,66033,66083,66116,66149,66166,66233,66283,66300,66333,66350,66366,66383,66412,66413,66416,66450,66466,66483,66517,66533,66583,66600,66633,66650,66717,67634,67684,67751,67784,67835,67851,67901,67935,67968,68001,68018,68068,68085,68118,68135,68185,68285,68302,68418,68435,68535,68552,68569,68644,68645,68669,68685,68802,68836,68986,69002,69069,69569,69570,99800,100300,100334,100350,100367,100384,100400,100434,100484,100501,100551,100567,100584,100601,100634,100651,100667,100717,100734,100751,100767,100784,100801,100851,100868,100901,100918,100934,100951,100968,100980,100981,100984,101001,101018,101034,101051,101084,101101,101134,101168,101185,101235,101268,101285,101652,101668,101702,101935,103153,103187,103203,103220,103237,103704,104137,104154,104204,104221,104254,104271,104321,104354,104371,104421,104471,104505,104521,104571,104588,104605,104621,104638,104688,104705,104721,104755,104771,104816,104817,104821,104838,104855,104872,104888,104905,104922,104972,104988,105005,105072,105122,107007,107024,107057,107090,107841,107858,107991,108025,108058,108075,108175,108208,108275,108292,108308,108342,108358,108408,108425,108442,108458,108492,108509,108575,108592,108609,108625,108642,108662,108663,108692,108709,108759,108825,108926,108942,110844,110878,110894,110928,111378,111812,111845,111862,111895,111912,111929,111945,112062,112095,112162,112196,112212,112262,112279,112296,112312,112379,112396,112412,112446,112462,112479,112496,112503,112504,112529,112546,112563,112579,112646,112663,112679,112746,112796,114681,114715,114731,114765,115232,115732,115733,122840,123340,123390,123423,123457,123473,123557,123558,123559,123574,123657,123674,123690,123724,123740,123790,123807,123857,123874,123907,123924,123941,123957,123974,124007,124024,124041,124057,124074,124091,124124,124141,124157,124191,124208,124224,124241,124274,124291,124691,124708,124725,124791,125192,125209,125225,125259,125275,125292,125325,125342,125359,125375,125409,125469,125470,125492,125526,125542,125576,125592,125626,125642,125659,125676,125709,125726,125742,125759,125792,125809,125826,125843,125859,125893,125909,125926,125943,125976,125993,126026,126043,126059,126076,126109,126126,126159,126176,126226,126677,127177,127211,127227,127244,127277,127311,127327,127344,127393,127394,127411,127427,127511,127528,127561,127578,127644,127661,127678,127694,127728,127744,127778,127794,127811,127828,127845,127861,127878,127895,127911,127928,127945,127961,127995,128011,128045,128061,128111,128128,128529,128545,128562,128629,128979,129046,129096,129329,129379,129463,129496,129530,129596,129997,130013,130047,130063,130430,130447,130464,131014,131064,131098,131114,131164,131215,131235,131236,131248,131348,131365,131415,131431,131481,131498,131548,131565,131598,131615,131632,131648,131665,131682,131698,131715,131732,131748,131765,131782,131798,131815,131832,131849,131865,131899,131915,131982,132366,132482,132866,132883,132900,132933,132966,132983,133000,133016,133050,133066,133100,133116,133150,133151,133152,133166,133183,133200,133233,133267,133283,133300,133317,133333,133350,133367,133400,133417,133433,133450,133483,133500,133517,133534,133550,133584,133600,133634,133650,133667,133684,133717,133734,133767,133784,133817,133834,133884,133917,134268,134852,134868,134918,134935,134968,134985,135035,135064,135065,135068,135118,135135,135202,135219,135252,135269,135302,135319,135335,135352,135369,135402,135419,135452,135469,135485,135502,135519,135586,135602,135636,135652,135702,135719,135769,135802,135819,136186,136203,136236,136253,136320,136653,136720,136770,136787,136987,137004,137070,137187,137204,137287,137671,137688,137704,137721,137738,138689,138705,138722,138755,138772,138789,138822,138856,138889,138915,138916,138989,139039,139056,139089,139106,139139,139156,139206,139239,139256,139289,139306,139323,139339,139356,139373,139406,139423,139439,139473,139506,139523,139590,139606,139673,139690,141542,141592,141608,141625,141642,142109,142543,142576,142593,142643,142659,142757,142758,142759,142793,142876,142893,142910,142943,142976,142993,143010,143060,143076,143126,143143,143177,143193,143210,143227,143243,143260,143277,143310,143327,143377,143393,143443,143460,143527,145379,145445,145495,145496,145497,145579,145596,145612,145629,145646,145662,145729,145746,145762,145779,145796,145812,145829,145846,145896,145929,146230,146246,146380,146396,146446,146463,146496,146563,146597,146605,146606,146713,146763,146797,146847,146864,146880,146930,146980,146997,147030,147064,147080,147097,147114,147130,147147,147197,147214,147264,147281,147347,149216,149283,149299,149316,149783,150217,150234,150300,150317,150334,150400,150441,150442,150467,150551,150584,150617,150667,150684,150701,150767,150784,150817,150834,150851,150884,150901,150918,150934,150951,150968,151001,151018,151034,151084,151101,151201,152152,152186,152219,152236,152252,152279,152280,152286,152319,152352,152369,152436,152452,152486,152503,152553,152569,152603,152619,152669,152686,152719,152753,152786,152803,152836,152853,152903,152936,152953,153003,153020,153053,153070,153153,153170,153237,153270,153303,153337,153403,153420,153554,154054,154055,184285,184785,184801,184852,184868,184902,184918,184952,184996,184997,185002,185035,185052,185118,185135,185152,185185,185202,185252,185269,185319,185335,185369,185385,185402,185419,185435,185452,185469,185485,185502,185519,185552,185569,185602,185619,185636,185686,185702,185752,187621,187671,187688,187721,188172,188605,188639,188655,188689,188705,188739,188772,188822,188831,188832,188856,188906,188939,188956,188972,188989,189039,189056,189072,189122,189139,189156,189206,189223,189239,189273,189289,189306,189323,189339,189356,189406,189423,189456,189473,189523,189540,189606,191458,191525,191542,191575,192326,192342,192476,192492,192543,192576,192598,192599,192626,192659,192726,192759,192776,192809,192826,192876,192893,192926,192943,192960,193010,193026,193043,193060,193076,193093,193110,193126,193143,193177,193193,193210,193243,193277,193293,193310,193343,193360,193443,195329,195345,195362,195379,195412,195863,196296,196313,196363,196380,196413,196446,196480,196511,196512,196580,196630,196663,196680,196713,196747,196763,196780,196813,196830,196897,196914,196930,196947,196964,196980,197014,197030,197047,197064,197114,197147,197181,197197,197281,199149,199183,199199,199216,199233,199249,199633,200133,200134}
const int16 angles[] = {-1,120,120,127,134,137,142,145,159,168,182,194,196,201,224,232,243,259,264,273,284,294,308,318,324,331,340,346,358,359,0,3,16,26,45,67,80,98,108,116,120,120,138,148,148,138,122,132,142,148,156,173,186,201,224,236,252,262,268,270,283,298,309,319,326,330,338,351,358,359,0,12,18,44,53,70,91,102,114,124,138,148,149,120,124,130,136,143,149,157,168,182,194,204,214,226,239,249,258,269,270,277,287,296,304,314,320,324,332,338,359,0,12,22,36,54,68,80,91,100,110,119,120,127,149,148,146,132,120,120,124,126,130,132,136,138,142,148,148,142,118,120,120,118,120,120,130,136,139,144,147,154,171,184,204,217,222,236,248,262,277,282,292,306,316,322,336,354,359,0,0,12,18,26,38,48,55,69,88,99,108,118,120,120,128,136,148,148,145,132,121,127,133,135,143,145,164,178,186,192,199,206,212,222,234,240,250,258,268,270,281,292,301,306,315,322,349,359,0,0,8,18,24,44,52,68,81,94,99,110,118,127,131,149,148,122,128,134,144,147,154,170,180,196,202,214,220,232,244,254,262,270,282,292,300,309,318,324,328,345,349,359,0,2,8,18,24,38,55,69,82,93,106,120,120,122,134,148,148,146,136,128,120,120,124,128,132,140,143,146,148,148,144,120,120,120,127,137,144,150,161,177,190,200,213,225,238,250,254,264,270,274,280,292,308,317,320,325,333,359,0,4,10,22,32,44,62,85,98,116,125,129,148,148,146,124,110,90,90,122,128,134,151,165,169,188,211,216,228,248,252,262,269,272,278,290,306,317,320,330,344,350,359,0,4,20,44,54,70,92,104,120,129,148,148,154,177,202,240,260,274,292,302,317,325,330,338,352,359,359,0,4,32,32,118,118,126,135,143,156,192,209,221,238,256,261,272,298,304,315,328,343,356,359,0,10,18,32,55,64,78,99,110,148,148,144,106,90,90,122,134,142,156,170,186,198,213,226,241,254,276,296,307,318,321,326,340,359,0,2,14,30,42,62,78,98,110,120,129,148,149,152,166,178,188,194,202,209,220,229,240,250,258,265,270,277,294,300,320,320,337,340,346,359,0,4,10,30,42,69,76,86,86,-1,122,122,128,134,137,142,145,156,169,178,191,194,198,206,213,219,230,248,258,262,270,272,284,300,310,318,328,334,341,354,359,0,1,14,20,34,50,68,82,96,108,118,132,146,148,148,150,148,150,148,146,132,104,90,90,120,127,135,143,149,156,169,179,187,198,212,224,237,252,262,268,270,284,300,310,315,322,331,359,0,2,10,22,30,42,52,70,92,104,110,131,149,148,146,113,90,90,148,148,155,162,170,192,200,212,222,225,235,244,256,263,268,270,284,296,316,324,329,336,351,359,0,12,28,62,96,96,148,148,147,111,90,90,118,126,132,139,144,147,154,186,198,215,228,240,257,262,268,278,302,313,318,327,336,348,355,359,0,16,22,32,56,89,96,108,129,149,148,147,126,90,90,90,-1,56,56,47,36,31,23,0,0,359,352,334,328,319,306,294,280,270,255,245,236,227,222,220,212,200,189,183,170,166,158,136,128,114,101,90,84,76,66,60,61,57,50,31,32,46,52,58,54,48,43,36,33,26,20,0,359,352,344,338,332,324,314,302,297,288,279,270,266,255,244,236,230,222,220,205,193,186,174,158,138,122,108,100,88,77,68,58,49,31,32,58,52,46,43,32,24,20,12,0,359,355,347,330,318,306,294,276,266,260,250,242,233,224,222,214,209,197,192,180,174,162,158,145,135,120,106,94,84,68,60,60,57,50,32,32,42,60,60,56,46,44,38,32,32,46,62,60,62,62,60,59,49,38,35,21,8,0,359,354,331,320,302,290,276,266,250,240,231,223,220,216,209,200,194,183,177,166,160,147,137,129,116,110,98,88,78,60,61,32,32,37,50,58,52,47,44,36,31,24,16,9,0,0,359,354,349,346,336,328,318,314,308,298,292,283,275,266,260,250,240,231,226,220,216,199,187,168,158,150,130,114,100,88,76,66,57,42,32,32,61,54,45,38,32,24,12,0,359,358,347,340,326,314,301,291,282,271,270,263,254,244,236,227,220,216,208,202,168,158,144,127,106,94,78,62,60,62,62,55,47,32,32,38,62,60,62,62,54,42,38,32,32,38,46,62,60,62,58,52,45,43,35,29,20,6,0,359,341,324,319,304,292,282,278,255,244,234,223,220,211,204,190,184,164,158,136,118,102,88,64,54,34,32,32,35,58,72,90,90,57,50,44,33,26,0,359,359,346,327,321,308,296,284,276,272,252,241,226,218,207,193,186,172,166,156,142,121,106,84,72,57,49,32,32,24,0,0,359,330,306,294,284,277,263,240,230,225,222,217,205,197,184,164,148,148,60,60,53,44,36,30,12,2,0,359,329,310,294,277,270,258,239,222,213,199,178,170,158,148,136,117,94,81,64,55,32,32,61,74,90,90,60,54,41,33,30,12,0,359,352,330,318,302,284,271,268,242,231,220,217,206,189,178,170,160,151,130,110,104,90,72,62,32,31,24,14,11,6,0,359,358,350,344,339,326,318,308,300,288,280,274,268,260,256,250,244,240,234,230,226,220,214,212,202,198,194,188,176,169,158,149,143,134,123,117,94,94,-1,62,62,54,44,36,30,26,12,0,359,358,348,342,326,315,308,296,286,270,260,244,232,223,220,211,204,191,184,170,164,154,137,119,104,89,84,72,56,48,32,32,34,64,90,90,60,54,48,42,34,29,16,3,0,359,351,340,329,325,318,306,290,281,276,256,250,240,225,218,212,194,181,174,162,156,136,110,96,84,72,58,49,32,32,44,77,90,90,30,30,26,16,4,0,359,354,346,333,322,318,309,300,287,280,271,268,256,240,229,224,221,216,205,198,184,178,158,150,128,110,95,82,76,64,55,32,32,34,48,67,90,90,62,54,44,36,30,22,8,0,359,341,327,316,303,291,281,270,267,254,242,222,214,208,200,187,180,160,152,130,120,96,78,66,56,32,32,34,48,65,80,90,90,90,-1}
int maxIdx = 1350;
int bpm=125;
int ribbon_offset=0;

//deadzone for autoswirl set negative to disable
int deadzone=5;
int ms=0;
int ms_ribbon=0;
int running=0;

int idx=0;
int curAngle=-1;

int next_beat=0;
int beat_anticipate=0;
int autoswirl=0;

init {
	beat_anticipate=60000/(bpm*4);
}

main {
	ms+=get_rtime();
	if (get_val(XB1_VIEW)>0 && event_press(XB1_A)) {
		ms=0;
		idx=0;
		next_beat=0;
		cls_oled(0);
		running=1;
		putc_oled(1,82);
		putc_oled(2,117);
		putc_oled(3,110);
		puts_oled(40,20,2,3,1);
	}
	if (event_press(XB1_B)) {
		ms=0;
		idx=0;
		next_beat=0;
		cls_oled(0);
		running=0;
		putc_oled(1,83);
		putc_oled(2,116);
		putc_oled(3,111);
		putc_oled(4,112);
		puts_oled(30,20,2,4,1);
	}
	if (event_press(XB1_RB)) {ribbon_offset = ribbon_offset + 25;set_val(TRACE_1,ribbon_offset);}
	if (event_press(XB1_LB)) {ribbon_offset = ribbon_offset - 25;set_val(TRACE_1,ribbon_offset);}
	
	if (running) {
		set_val(TRACE_2,ms);
		ms_ribbon = ms + ribbon_offset;
		//advance until we reach the end or catch up with the time code
		while (idx<maxIdx && ms_ribbon>times[idx + 1]) {
			idx++;
		}
		//if we've reached the end of the ribbon, releast LS
		if (idx>=maxIdx || angles[idx]== -1) {
			curAngle=-1;
		} else {
			curAngle=angles[idx]+(angles[idx + 1]-angles[idx])*(ms_ribbon-times[idx])/(times[idx + 1]-times[idx]);
		}
		//set LS position if ribbon present
		if (curAngle>=0) set_polar(POLAR_LS,curAngle,32767);

		//shoot if we are on the beat
		if ((ms+beat_anticipate)>((next_beat*2*60000)/bpm)) {
			next_beat+=1;
			combo_run(fire);
		}

		//swirl reticle if idle
		if (event_press(XB1_X)) {if (autoswirl==0) {autoswirl=1} else {autoswirl=0}}
		if (autoswirl==1 && get_val(XB1_RX)<=deadzone && get_val(XB1_RY)<=deadzone && get_val(XB1_RX)>=-deadzone && get_val(XB1_RY)>=-deadzone) {set_polar(POLAR_RS,ms%360,32767);}
	}
}

combo fire {
	set_val(XB1_RT,100);wait(50);
}
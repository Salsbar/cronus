const int32 times[] = {0,38356,38856,38889,38906,38939,38956,38989,39006,39022,39072,39089,39122,39139,39189,39206,39256,39273,39289,39306,39323,39339,39389,39907,40290,40307,40324,40340,40374,40390,40407,40457,40474,40490,40524,40574,40624,40641,40657,40674,40691,40741,40757,40774,40791,40824,40873,40874,40874,41041,41158,41175,41208,41225,41241,41275,41291,41358,41375,41425,41441,41475,41491,41542,41558,41575,41592,41608,41658,41675,42626,43010,43143,43427,43460,43477,43510,43527,43544,43560,43577,43627,43644,43694,43710,43744,43760,43810,43827,43877,43894,43911,43961,44428,44478,44494,44578,44595,44678,44862,44878,44895,44945,44978,45145,45162,45179,45195,45212,45229,45245,45295,45429,45462,45479,45529,45562,45679,45729,45746,45762,45779,45829,45846,46013,46029,46146,46163,46196,46246,47197,47381,47731,47998,48048,48065,48131,48148,48182,48198,48215,48248,48265,48315,48332,48382,48398,48465,48498,48515,48532,49319,49320,49349,49383,49433,49449,49483,49499,49516,49533,49566,49583,49633,49650,49666,49716,49766,49783,49800,49816,49833,49850,49867,49900,49917,49950,49999,50000,50000,50184,50300,50317,50334,50350,50384,50400,50417,50467,50484,50517,50534,50584,50601,50651,50667,50717,50734,50767,50784,51702,51718,52152,52302,52436,52586,52603,52619,52636,52653,52686,52703,52753,52769,52819,52836,52870,52886,52903,52920,52936,52986,53003,53020,53036,53042,53043,53070,53086,53103,53704,53737,53754,53804,53837,53871,53904,53937,53954,54004,54037,54054,54071,54104,54121,54288,54454,54571,54671,54721,54788,54805,54855,54922,54951,54952,54955,55022,55038,55072,55088,55105,55155,55172,55205,55222,55272,55289,55322,55339,55389,56373,57007,57174,57191,57224,57241,57274,57291,57307,57374,57391,57508,57524,57574,57608,57641,57674,57925,58108,58225,58575,58675,58709,58725,58792,58809,59059,59142,59193,59226,59243,59293,59309,59426,59443,59459,59493,59510,59526,59543,59560,59610,59626,59660,59676,59726,59743,59776,59793,59826,59843,59877,60010,60727,60861,61645,61712,61745,61762,61778,61795,61845,61862,61895,61912,61945,61962,62012,62029,62079,62095,62145,62162,62179,62246,62579,62596,62613,62629,62646,62679,62696,62729,62746,62796,62813,62846,62863,62880,62930,62963,63030,63046,63063,63096,63130,63146,63163,63197,63213,63230,63247,63263,63280,63285,63286,63297,63313,63330,63363,63380,63413,63430,63480,63497,63530,63564,63597,63630,63664,63680,63697,63714,63730,63780,63797,63830,63847,63864,63881,63897,63931,63947,63964,63995,63996,63997,64014,64031,64047,64064,64097,64114,64147,64164,64214,64231,64264,64281,64314,64331,64381,64398,64431,64448,64481,64498,64515,65499,65666,65999,66283,66333,66366,66416,66433,66466,66483,66517,66533,66583,66600,66633,66650,66700,66717,66750,66767,66817,67138,67139,67150,67201,67217,67251,67284,67384,67718,67818,68001,68151,68168,68185,68285,68519,68585,68619,68652,68669,68702,68719,68769,68785,68819,68836,68869,68886,68919,68936,68952,68969,69002,69052,69086,69169,70020,70037,70137,70220,70571,70587,70604,70721,70871,70888,70904,70921,70954,70971,71004,71021,71071,71088,71121,71138,71188,71205,71238,71271,71288,71305,71331,71332,71371,71388,72005,72105,72122,72289,72339,72439,72472,72556,72573,72606,72673,72823,72856,72956,73106,73140,73207,73223,73236,73237,73290,73307,73340,73357,73373,73390,73440,73457,73490,73507,73557,73574,73607,73624,73640,73657,73674,74675,75292,75792,75793,111512,112012,112029,112045,112062,112079,112112,112129,112179,112196,112246,112262,112312,112329,112379,112396,112429,112462,112513,112529,113447,113480,113514,113530,113564,113714,113997,114014,114114,114147,114198,114248,114464,114481,114982,115032,115182,115199,115282,115315,115349,115532,115549,115582,115599,115649,115666,115716,116149,116300,116567,116583,116600,116617,116667,116683,116700,116733,116750,116800,116817,116867,116884,116934,116950,117000,117034,117084,117100,118051,118435,118452,118485,118502,118535,118552,118602,118619,118652,118669,118719,118735,118752,118785,118802,119152,121104,121154,121188,121271,121288,121321,121338,121388,121405,121455,121471,121522,121538,121572,121588,121605,121638,121672,122289,122306,122589,122623,122656,122723,122739,122806,122873,122990,123006,123023,123156,123207,123240,123257,123290,123323,123373,123774,124741,125008,125626,125642,125726,125742,125759,125776,125792,125843,125859,125893,125909,125959,125976,126026,126043,126076,126093,126109,126126,126143,126176,126187,126188,126193,126226,126860,126894,126960,126994,127027,127060,127094,127108,127109,127127,127143,127144,127144,127160,127177,127194,127244,127377,127394,127427,127461,127477,127528,127578,127611,127711,127761,127828,127845,127861,127995,128028,128078,128096,128097,128111,128145,128212,128228,128278,128295,128328,128345,128395,128412,128462,128478,128529,129513,130147,130330,130347,130380,130397,130464,130480,130581,130597,130664,130731,130764,130797,130814,131164,131198,131248,131298,131381,131715,131732,131748,131798,131832,131882,131915,131949,132216,132232,132282,132499,132516,132583,132616,132633,132666,132683,132733,132749,132799,132816,132866,132883,132933,132950,132983,133000,133033,133083,133150,133884,134017,134852,134885,134902,134918,134968,134985,135002,135052,135068,135102,135118,135169,135185,135252,135269,135285,135302,135352,135385,135736,135953,135957,135958,136003,136053,136069,136086,136103,136153,136170,136203,136220,136253,136270,136286,136303,136320,136336,136353,136370,136386,136403,136453,136470,136520,136537,136570,136587,136620,136643,136644,136653,136737,137020,137135,137136,137154,137187,137204,137221,137271,137287,137321,137337,137387,137404,137437,137454,137504,137521,137571,137588,137621,137654,138639,138805,139156,139423,139489,139506,139556,139573,139590,139623,139640,139690,139706,139756,139773,139806,139823,139857,139873,139890,139907,139940,139957,140277,140278,140290,140307,140340,140424,140524,140858,140891,140908,140974,141008,141074,141091,141158,141191,141225,141308,141358,141425,141441,141458,141508,141558,141592,141642,141708,141742,141758,141792,141808,141842,141859,141909,141925,141975,141992,142025,142042,142075,142109,142176,142192,142226,142309,143160,143260,143293,143727,143777,143794,143844,143861,144011,144027,144044,144061,144094,144111,144127,144161,144178,144228,144244,144294,144311,144344,144361,144394,144428,144444,144461,144475,144476,144478,144511,144528,145145,145362,145429,145512,145529,145579,145596,145662,145712,145812,145946,145963,146013,146046,146113,146280,146346,146363,146380,146381,146446,146463,146496,146513,146530,146580,146597,146647,146663,146697,146713,146763,146780,146813,147731,148432,148582,148866,148966,148982,149016,149049,149066,149082,149683,150000,150050,150083,150150,150184,150217,150234,150884,151151,151201,151218,151351,151385,151869,152085,152302,152786,152803,152870,153003,153020,153153,153437,153587,153670,154181,154182,154254,154571,154588,154605,154638,154721,154805,155005,155055,155056,155105,155155,155222,155239,155305,155339,155355,155422,155436,155437,155439,155722,155873,155956,156456,156673,156676,156677,156874,157357,157374,157441,157558,157591,157741,158008,158108,158141,158175,158208,158242,158876,159109,159176,159243,159309,159326,159393,159626,159843,159877,159993,160027,160294,160427,160444,160460,160511,161028,161094,161445,161929,161945,162012,162129,162162,162296,162596,162729,162796,162813,163130,163146,163697,163814,163881,163931,163947,163964,164144,164145,164147,164281,164283,164284,164314,164348,164448,164464,164481,164515,164531,164577,164578,164581,164848,164849,165115,165599,165883,165899,166383,166567,166583,166817,166867,167150,167167,167201,167284,167301,167317,167367,167935,168285,168352,168368,168485,168519,169152,169436,169486,169520,169636,169653,170137,170470,170487,170804,170871,170888,171071,171088,171154,171288,171305,171455,171705,171738,171855,171955,172495,172496,172573,172856,172940,172956,173040,173090,173290,173340,173341,173390,173440,173507,173524,173590,173624,173640,173707,173721,173722,173724,174007,174041,174057,174191,174241,174558,174563,174564,174575,175325,175559,175909,175926,176293,176310,176343,176426,176460,176527,177160,177427,177494,177511,177528,177661,177895,178145,178295,178562,178612,178645,178795,179112,179129,180097,180264,180297,180414,180447,180581,180848,180881,180998,181014,181064,181081,181616,181617,181665,181999,182032,182049,182149,182232,182432,182683,182699,183116,183183,183200,183217,183233,183250,183267,183300,183350,183367,183750,183767,184067,184084,184518,184852,184968,185002,185502,185503}
const int16 angles[] = {-1,180,180,170,162,154,144,132,127,118,104,96,88,80,68,61,52,45,42,37,34,26,14,0,0,16,24,52,74,84,100,120,131,136,148,184,206,218,234,249,270,292,299,312,318,328,359,0,0,1,4,10,20,30,34,47,57,76,84,98,104,112,119,129,135,138,143,146,162,166,148,148,180,179,170,162,154,144,137,132,123,109,100,88,80,72,66,55,49,38,32,29,14,0,6,8,16,20,26,30,30,26,22,18,0,2,4,6,8,10,12,18,31,28,25,21,16,5,4,8,18,20,36,49,100,108,135,144,151,165,148,148,180,180,192,199,216,226,239,244,254,264,272,284,292,302,310,326,333,342,346,359,0,0,2,6,14,50,61,70,89,104,117,134,146,150,180,203,212,243,256,266,274,288,302,314,324,359,0,0,1,5,12,16,24,34,40,50,64,74,82,90,102,110,120,127,136,144,150,155,146,148,148,180,180,210,214,222,226,239,250,260,272,280,292,300,306,314,318,318,322,340,346,349,358,359,0,6,14,18,32,30,26,22,18,15,10,8,4,0,4,6,9,12,14,30,14,0,12,17,24,26,29,12,0,359,358,342,335,328,321,310,294,284,275,266,254,248,240,232,222,209,209,168,162,154,144,132,127,118,100,91,62,54,43,34,26,16,0,16,26,31,20,17,14,8,5,32,24,18,15,12,8,4,1,6,14,24,36,46,50,62,77,87,96,105,117,125,132,139,148,151,166,208,210,180,179,178,170,162,158,149,132,123,115,106,97,89,78,70,60,53,44,38,35,14,0,14,20,35,46,62,76,89,100,116,126,135,145,148,167,187,208,227,238,253,276,283,296,309,314,323,328,346,354,359,0,10,18,41,64,83,100,114,130,142,154,172,195,212,244,264,272,276,284,294,302,309,316,320,321,328,335,344,347,359,0,0,4,12,16,24,33,44,54,63,76,85,94,100,108,114,125,131,137,145,151,156,162,148,148,180,180,192,204,216,226,238,248,258,267,279,286,294,300,312,318,324,330,346,359,0,0,6,8,12,16,26,31,20,0,18,18,22,30,6,9,20,34,46,58,68,83,93,102,110,117,125,132,139,144,147,160,176,190,209,208,204,189,186,180,182,186,200,210,214,222,232,244,252,262,270,282,290,296,304,314,320,328,339,347,350,359,0,14,18,30,20,17,0,6,16,20,29,31,28,20,4,0,12,27,29,12,3,0,359,346,340,332,324,318,308,294,284,275,267,254,248,240,233,230,224,220,209,209,209,-1,4,4,12,16,24,27,38,50,64,73,86,94,106,114,124,130,137,148,160,164,208,205,200,200,195,180,207,208,198,194,190,184,184,120,120,124,138,142,148,146,140,121,120,125,130,136,142,149,148,180,180,176,168,164,146,140,130,121,112,98,90,78,70,60,53,44,32,20,16,0,2,14,24,40,55,67,84,96,106,116,128,136,142,150,155,180,181,182,194,214,224,237,248,262,271,284,292,302,310,318,318,326,333,347,347,208,208,205,200,194,193,184,182,193,194,196,208,204,199,198,194,192,186,180,180,149,148,210,210,214,222,227,239,254,264,272,280,292,298,310,318,322,326,334,338,345,354,359,0,2,12,30,27,20,16,14,9,6,0,359,351,359,0,0,2,4,6,12,26,26,31,28,25,21,15,12,0,6,14,14,18,30,22,4,0,359,356,345,329,318,301,290,281,272,260,252,240,234,224,209,209,166,158,148,136,117,107,80,72,56,42,32,20,14,3,6,12,18,26,31,30,26,22,18,14,10,6,31,30,24,0,0,8,17,26,42,52,69,79,94,104,116,124,135,144,150,156,171,187,208,209,180,180,170,162,159,138,133,124,110,102,93,84,74,66,52,46,43,37,27,18,0,0,0,359,354,334,320,302,279,254,241,229,220,208,190,181,164,158,130,118,108,99,85,70,61,48,38,31,26,8,0,359,356,331,331,359,0,4,16,20,30,46,56,65,73,86,94,102,110,120,126,136,144,150,162,148,148,180,180,196,202,216,222,232,244,254,268,276,288,296,302,310,317,318,326,329,340,347,359,0,0,4,6,16,26,31,28,26,20,15,8,5,2,5,10,18,24,32,30,28,22,18,14,8,1,10,20,30,44,56,67,82,92,106,114,122,129,136,148,167,176,188,209,208,192,187,182,188,192,198,200,210,214,222,232,244,248,258,267,275,286,294,306,312,320,324,332,345,348,356,359,0,0,14,18,30,8,0,10,12,16,20,26,32,21,8,4,2,4,13,30,13,4,0,359,343,336,328,322,312,294,284,270,262,254,248,236,228,222,180,180,208,208,198,196,194,190,188,186,180,180,174,170,164,159,156,154,180,180,174,171,158,154,180,180,209,209,270,270,301,301,332,330,348,356,359,0,0,0,2,4,8,18,26,0,0,359,359,356,346,342,334,340,346,357,359,0,0,1,18,26,0,0,0,359,331,331,270,270,238,239,209,208,198,194,192,188,184,180,179,176,168,162,158,154,148,146,152,178,180,179,164,162,160,155,180,180,209,209,270,270,302,301,332,332,346,352,354,354,301,302,312,319,323,326,327,359,0,0,0,0,359,354,346,333,336,342,346,352,359,0,0,0,359,359,331,331,270,270,239,239,191,180,180,176,173,164,162,160,154,148,149,142,138,126,123,148,148,142,136,125,122,149,148,209,211,212,209,209,270,270,301,301,331,332,333,346,356,359,0,0,0,10,12,20,26,0,0,359,359,356,346,342,334,340,346,357,359,0,0,0,4,8,20,26,26,0,359,302,301,270,270,208,208,208,204,194,192,184,180,180,172,170,168,154,148,148,180,179,176,170,154,154,239,239,270,270,301,301,332,332,332,346,346,352,354,359,0,0,1,4,8,18,26,0,57,60,62,68,70,72,74,76,78,80,86,88,64,60,60,0,0,32,60,60,60,-1}
int maxIdx = 1294;
int bpm=105;
int ribbon_offset=0;

//deadzone for autoswirl set negative to disable
int deadzone=5;
int ms=0;
int ms_ribbon=0;
int running=0;

int idx=0;
int curAngle=-1;

int next_beat=0;
int beat_anticipate=0;
int autoswirl=0;

init {
	beat_anticipate=60000/(bpm*4);
}

main {
	ms+=get_rtime();
	if (get_val(XB1_VIEW)>0 && event_press(XB1_A)) {
		ms=0;
		idx=0;
		next_beat=0;
		cls_oled(0);
		running=1;
		putc_oled(1,82);
		putc_oled(2,117);
		putc_oled(3,110);
		puts_oled(40,20,2,3,1);
	}
	if (event_press(XB1_B)) {
		ms=0;
		idx=0;
		next_beat=0;
		cls_oled(0);
		running=0;
		putc_oled(1,83);
		putc_oled(2,116);
		putc_oled(3,111);
		putc_oled(4,112);
		puts_oled(30,20,2,4,1);
	}
	if (event_press(XB1_RB)) {ribbon_offset = ribbon_offset + 25;set_val(TRACE_1,ribbon_offset);}
	if (event_press(XB1_LB)) {ribbon_offset = ribbon_offset - 25;set_val(TRACE_1,ribbon_offset);}
	
	if (running) {
		set_val(TRACE_2,ms);
		ms_ribbon = ms + ribbon_offset;
		//advance until we reach the end or catch up with the time code
		while (idx<maxIdx && ms_ribbon>times[idx + 1]) {
			idx++;
		}
		//if we've reached the end of the ribbon, releast LS
		if (idx>=maxIdx || angles[idx]== -1) {
			curAngle=-1;
		} else {
			curAngle=angles[idx]+(angles[idx + 1]-angles[idx])*(ms_ribbon-times[idx])/(times[idx + 1]-times[idx]);
		}
		//set LS position if ribbon present
		if (curAngle>=0) set_polar(POLAR_LS,curAngle,32767);

		//shoot if we are on the beat
		if ((ms+beat_anticipate)>((next_beat*2*60000)/bpm)) {
			next_beat+=1;
			combo_run(fire);
		}

		//swirl reticle if idle
		if (event_press(XB1_X)) {if (autoswirl==0) {autoswirl=1} else {autoswirl=0}}
		if (autoswirl==1 && get_val(XB1_RX)<=deadzone && get_val(XB1_RY)<=deadzone && get_val(XB1_RX)>=-deadzone && get_val(XB1_RY)>=-deadzone) {set_polar(POLAR_RS,ms%360,32767);}
	}
}

combo fire {
	set_val(XB1_RT,100);wait(50);
}
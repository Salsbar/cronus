const int32 times[] = {0,72390,72890,72940,72990,73006,73040,73056,73073,73090,73123,73140,73156,73173,73207,73223,73407,73574,73640,73774,73807,73907,74124,74241,74277,74278,74491,74575,74591,74708,74725,75375,75576,75609,75876,76009,76026,76176,76210,76460,76560,76743,76793,77077,77110,77211,77244,77427,77744,77761,77778,77794,77811,77828,77861,77895,77928,77945,77946,77947,77961,77978,77995,78011,78045,78061,78078,78095,78111,78128,78145,78178,78195,78228,78245,78262,78295,78328,78362,78378,78412,78428,78478,78695,78712,78762,78779,78812,78829,78862,78879,78912,78979,78996,79012,79046,79246,79513,79530,79546,79563,79580,79596,79630,80113,80297,80330,80364,80430,80447,80764,80797,80831,80848,80864,80881,80914,81365,81398,81415,81532,81548,81632,81648,81665,81698,81715,82165,82182,82216,82249,82266,82316,82749,82783,82799,82833,82883,82900,82933,82950,82966,82983,83450,83483,83500,83534,83567,83588,83589,83600,83617,83634,83667,83684,83800,84034,84051,84067,84084,84101,84117,84134,84151,84168,84201,84218,84219,84220,84268,84284,84318,84334,84351,84368,84384,84785,84801,84818,84885,84935,84968,85002,85152,85285,85502,85686,85736,85752,85853,85869,85953,86036,86436,86470,86503,86537,86670,87020,87187,87204,87354,87371,87621,87723,87724,87754,87905,87921,87938,88038,88222,88288,88322,88622,88906,88956,88972,88989,89006,89022,89039,89056,89072,89089,89122,89139,89156,89173,89189,89223,89239,89256,89289,89323,89356,89373,89389,89406,89439,89456,89473,89489,89506,89523,89556,89573,89606,89623,89857,89860,89861,89940,89957,89973,90040,90073,90123,90224,90657,90674,90691,90707,90724,90741,90757,90790,90791,90791,91258,91275,91308,91458,91463,91464,91491,91525,91575,91608,91942,91975,91992,92009,92025,92074,92075,92075,92543,92545,92546,92559,92593,92609,92626,92659,92676,92759,92809,92826,92843,92876,92893,93327,93343,93360,93377,93393,93443,93475,93476,93477,93694,93695,93911,93944,93961,94027,94061,94077,94094,94111,94127,94144,94161,94194,94611,94628,94645,94661,94678,94695,94724,94725,94728,94745,94761,94795,94811,94845,95195,95212,95229,95245,95262,95279,95312,95362,95379,95395,95429,95445,95462,95479,95495,95529,95546,95562,95746,96113,96196,96213,96246,96463,96606,96607,96613,96647,96663,96680,96897,96930,97014,97030,97231,97264,97664,97681,97931,97998,98048,98232,98348,98365,98498,98515,98532,98799,98815,99066,99082,99349,99416,99449,99499,99800,100083,100100,100133,100150,100167,100184,100200,100217,100234,100250,100266,100267,100284,100300,100317,100334,100350,100367,100400,100417,100434,100450,100484,100501,100517,100534,100567,100584,100601,100617,100634,100651,100684,100701,100734,100751,100801,101001,101034,101068,101084,101118,101201,101218,101251,101268,101285,101301,101318,101335,101351,101368,101385,101835,101852,101869,101885,101902,101919,101969,102653,102686,102703,102736,102769,103103,103170,103187,103203,103237,103687,103720,103737,103804,103904,103971,103987,104004,104021,104037,104505,104538,104555,104571,104588,104638,105072,105088,105105,105172,105189,105205,105222,105239,105272,105289,105322,105772,105789,105822,105839,105856,105873,105906,105910,105911,105939,105956,105973,105989,106006,106106,106373,106406,106456,106473,106490,106557,106558,106573,106623,106657,106673,106707,106723,106857,106874,106957,107224,107241,107257,107307,107324,107341,107424,107608,107658,107708,107824,107841,107908,107941,108041,108075,108091,108175,108208,108442,108458,108475,108559,108759,108809,109309,109510,109526,109693,109710,109977,110063,110064,110110,110127,110143,110294,110427,110561,110611,110661,110677,110777,110794,110878,110911,111245,111261,111295,111311,111361,111378,111395,111411,111428,111445,111478,111495,111512,111562,111578,111612,111662,112162,112163,139373,139873,139907,139923,139957,139973,140007,140023,140040,140057,140073,140090,140107,140140,140157,140174,140190,140507,140541,140757,140807,140874,140891,140908,140924,140941,141091,141124,141252,141253,141258,141308,141325,141542,141558,141658,141675,141909,142025,142042,142109,142125,142159,142192,142242,142609,142626,142743,142910,142993,143060,143177,143443,143477,143727,144044,144077,144194,144228,144278,144294,144378,144728,144745,144761,144795,144811,144828,144845,144862,144878,144895,144914,144915,144928,144945,144962,144978,144995,145028,145045,145095,145112,145128,145162,145179,145195,145212,145229,145245,145279,145295,145312,145362,145379,145412,145445,145679,145746,145863,145879,145896,145913,145979,145996,146029,146463,146480,146496,146513,146530,146547,146563,146580,146613,147264,147331,147364,147381,147397,147414,147748,147764,147781,147798,147814,147831,147848,147881,148348,148365,148382,148465,148482,148515,148532,148549,148632,148649,148665,148682,148699,149132,149149,149166,149183,149199,149216,149233,149249,149283,149733,149750,149766,149783,149816,149867,149883,149900,149917,149967,150434,150450,150484,150501,150534,150551,150566,150567,150567,150584,150601,150617,150634,150651,151001,151034,151051,151068,151084,151101,151118,151151,151168,151185,151198,151199,151218,151235,151285,151301,151318,151335,151368,151818,151919,151935,151985,152002,152052,152252,152336,152486,152503,152686,152703,152719,152836,152870,153153,153487,153687,153704,153887,154154,154204,154321,154338,154371,154703,154704,154805,154872,154938,155155,155272,155305,155506,155539,155556,155889,155906,155923,155956,155973,155989,156006,156023,156039,156073,156089,156106,156123,156139,156156,156173,156190,156223,156340,156356,156373,156406,156423,156440,156456,156490,156507,156623,156731,156732,156840,156857,156907,156974,157040,157074,157090,157107,157124,157191,157641,157658,157691,157708,157724,157758,157773,157774,157774,158475,158476,158477,158509,158559,158592,158909,158942,158959,158976,159009,159058,159059,159059,159284,159285,159510,159560,159676,159710,159760,159776,159793,159810,159843,159860,159893,160310,160327,160360,160377,160394,160410,160443,160444,160444,160669,160670,160894,160928,160994,161061,161078,161094,161144,161595,161612,161628,161645,161662,161678,161695,161701,161702,161712,161728,161745,161762,161778,161812,162312,162313}
const int16 angles[] = {-1,182,182,192,203,210,214,221,225,234,240,248,252,258,264,270,286,300,306,318,320,328,347,356,359,0,20,26,30,38,42,96,110,112,130,138,142,151,154,172,181,194,196,216,220,226,229,244,270,272,278,290,296,306,316,331,352,358,359,0,12,22,30,48,62,75,82,90,96,98,104,110,116,121,121,132,138,146,151,158,164,170,180,180,182,190,194,196,200,204,208,213,226,228,233,239,238,239,229,224,216,212,199,180,179,180,184,194,228,239,238,232,222,215,210,196,180,181,184,188,204,208,222,224,230,234,239,239,238,227,213,203,180,181,183,192,200,220,232,244,254,260,270,270,288,303,318,339,359,0,10,20,52,78,90,90,86,74,70,60,55,46,42,36,26,13,0,0,359,342,332,317,298,290,276,270,236,233,232,226,222,220,217,204,194,174,158,154,151,144,140,132,126,92,92,86,85,76,51,40,37,28,26,8,0,359,357,346,347,344,338,324,319,318,292,272,254,244,238,228,224,216,211,198,192,168,162,148,138,124,107,96,90,82,72,66,61,58,54,48,44,41,34,32,26,20,14,6,1,0,0,359,348,346,342,333,328,320,301,301,303,308,318,322,331,338,359,0,0,0,2,0,0,0,359,357,346,322,301,301,311,319,324,331,359,0,0,0,0,359,356,352,348,346,340,339,324,316,312,309,298,301,301,300,305,315,318,346,359,0,0,0,359,359,358,352,339,330,328,319,318,310,306,300,301,301,304,310,320,326,340,359,0,2,18,35,58,75,90,93,104,110,120,124,133,144,166,178,186,196,208,214,222,242,256,270,270,288,320,325,328,329,348,359,0,0,4,4,8,26,30,36,40,56,60,94,94,112,116,120,132,140,142,151,152,154,173,176,194,194,213,218,221,223,248,270,282,292,304,308,318,322,328,338,350,359,0,10,20,26,44,51,66,79,90,94,100,106,112,114,119,124,130,132,137,139,146,150,157,164,170,180,181,182,186,190,194,207,211,215,220,220,226,228,234,236,242,239,240,228,224,216,212,199,180,181,193,204,216,239,239,220,212,200,180,180,183,187,196,212,224,226,232,234,240,238,228,220,216,204,180,179,178,184,205,210,220,226,239,250,260,270,270,282,296,311,318,328,354,359,0,32,48,72,84,90,90,78,65,48,36,31,0,359,352,332,314,292,275,270,258,256,250,226,225,222,220,219,216,210,194,191,186,176,173,168,164,155,155,150,144,140,120,120,116,110,94,89,54,41,38,28,26,6,0,359,356,355,352,344,334,324,320,318,315,308,305,300,296,270,266,252,240,221,217,208,195,189,174,160,143,130,106,92,104,116,116,-1,184,184,190,196,201,206,212,221,224,228,236,240,246,254,260,264,270,296,300,319,322,328,328,330,330,334,346,348,359,0,0,4,8,26,28,36,40,58,69,70,76,76,80,82,88,114,114,123,134,140,146,154,173,176,194,216,219,226,230,233,236,242,270,276,288,298,309,314,322,328,339,345,359,0,10,16,27,36,52,67,80,98,100,106,112,118,120,126,128,133,138,144,147,158,164,170,180,181,192,210,213,214,220,230,235,239,239,240,235,225,222,212,206,194,180,180,194,206,213,228,240,240,240,228,224,220,211,197,180,180,182,186,197,201,206,210,211,226,230,233,242,239,239,242,236,226,221,218,208,195,180,181,182,186,194,202,222,236,242,252,270,270,288,302,317,328,349,359,0,0,20,32,52,67,92,86,74,64,59,50,45,35,26,14,5,0,359,352,342,326,306,297,282,268,230,221,222,216,212,212,194,188,174,172,154,156,152,142,138,114,86,72,72,58,40,36,28,26,24,0,359,352,346,343,328,318,317,300,298,296,270,264,253,242,232,227,220,214,203,186,172,166,156,148,130,124,109,96,96,90,54,49,44,42,37,32,26,0,0,359,359,358,349,340,328,324,320,320,314,301,302,302,315,326,331,350,359,0,0,0,0,359,344,316,301,301,304,310,320,333,359,0,0,0,359,359,354,336,330,320,320,316,310,304,300,301,301,304,316,320,327,340,359,0,0,0,359,359,358,340,326,321,318,301,301,306,314,320,326,344,353,359,0,10,18,28,54,66,84,84,-1}
int maxIdx = 928;
int bpm=172;
int ribbon_offset=0;

//deadzone for autoswirl set negative to disable
int deadzone=5;
int ms=0;
int ms_ribbon=0;
int running=0;

int idx=0;
int curAngle=-1;

int next_beat=0;
int beat_anticipate=0;
int autoswirl=0;

init {
	beat_anticipate=60000/(bpm*4);
}

main {
	ms+=get_rtime();
	if (get_val(XB1_VIEW)>0 && event_press(XB1_A)) {
		ms=0;
		idx=0;
		next_beat=0;
		cls_oled(0);
		running=1;
		putc_oled(1,82);
		putc_oled(2,117);
		putc_oled(3,110);
		puts_oled(40,20,2,3,1);
	}
	if (event_press(XB1_B)) {
		ms=0;
		idx=0;
		next_beat=0;
		cls_oled(0);
		running=0;
		putc_oled(1,83);
		putc_oled(2,116);
		putc_oled(3,111);
		putc_oled(4,112);
		puts_oled(30,20,2,4,1);
	}
	if (event_press(XB1_RB)) {ribbon_offset = ribbon_offset + 25;set_val(TRACE_1,ribbon_offset);}
	if (event_press(XB1_LB)) {ribbon_offset = ribbon_offset - 25;set_val(TRACE_1,ribbon_offset);}
	
	if (running) {
		set_val(TRACE_2,ms);
		ms_ribbon = ms + ribbon_offset;
		//advance until we reach the end or catch up with the time code
		while (idx<maxIdx && ms_ribbon>times[idx + 1]) {
			idx++;
		}
		//if we've reached the end of the ribbon, releast LS
		if (idx>=maxIdx || angles[idx]== -1) {
			curAngle=-1;
		} else {
			curAngle=angles[idx]+(angles[idx + 1]-angles[idx])*(ms_ribbon-times[idx])/(times[idx + 1]-times[idx]);
		}
		//set LS position if ribbon present
		if (curAngle>=0) set_polar(POLAR_LS,curAngle,32767);

		//shoot if we are on the beat
		if ((ms+beat_anticipate)>((next_beat*2*60000)/bpm)) {
			next_beat+=1;
			combo_run(fire);
		}

		//swirl reticle if idle
		if (event_press(XB1_X)) {if (autoswirl==0) {autoswirl=1} else {autoswirl=0}}
		if (autoswirl==1 && get_val(XB1_RX)<=deadzone && get_val(XB1_RY)<=deadzone && get_val(XB1_RX)>=-deadzone && get_val(XB1_RY)>=-deadzone) {set_polar(POLAR_RS,ms%360,32767);}
	}
}

combo fire {
	set_val(XB1_RT,100);wait(50);
}